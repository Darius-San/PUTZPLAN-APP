<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putzplan App - DEBUG MODE</title>
    <!-- Font Awesome for better icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Responsive App Container */
        .app-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: #ffffff;
            position: relative;
            overflow-x: hidden;
        }

        /* Desktop/Tablet - App-√§hnliche Darstellung mit Schatten */
        @media (min-width: 769px) {
            .app-container {
                max-width: 700px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 24px;
                box-shadow: 0 0 60px rgba(0, 0, 0, 0.15);
                overflow: hidden;
            }
        }

        /* Tablet Portrait */
        @media (min-width: 481px) and (max-width: 768px) {
            .app-container {
                max-width: 580px;
                margin: 10px auto;
                min-height: calc(100vh - 20px);
                border-radius: 16px;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            }
        }

        /* Mobile - Vollbild */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            
            body {
                padding: 0;
            }
        }
        /* Status Bar - iOS Style */
        .debug-banner {
            background: linear-gradient(135deg, #ff416c 0%, #ff4757 100%);
            color: white;
            text-align: center;
            padding: 12px 20px;
            font-weight: 600;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            font-size: 13px;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 10px rgba(255, 65, 108, 0.3);
        }

        /* Responsive Container Padding */
        .container { 
            padding: 60px 16px 20px;
            max-width: 100%;
        }

        /* Desktop */
        @media (min-width: 769px) {
            .container {
                padding: 70px 32px 32px;
            }
        }

        /* Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 65px 20px 20px;
            }
        }

        /* Mobile */
        @media (max-width: 480px) {
            .container {
                padding: 55px 16px 16px;
            }
        }
        /* Responsive App Cards */
        .card { 
            background: #ffffff; 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            margin: 12px 0;
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* Desktop - Gr√∂√üere Cards */
        @media (min-width: 769px) {
            .card {
                border-radius: 20px;
                padding: 28px;
                margin: 20px 0;
            }
        }

        /* Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .card {
                border-radius: 18px;
                padding: 24px;
                margin: 16px 0;
            }
        }

        /* Mobile - Kompaktere Cards */
        @media (max-width: 480px) {
            .card {
                border-radius: 14px;
                padding: 18px;
                margin: 10px 0;
            }
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
        }

        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }
        /* Responsive Avatar Grid */
        .avatar-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin: 16px 0;
        }

        /* Desktop - Mehr Platz */
        @media (min-width: 769px) {
            .avatar-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 16px;
                margin: 24px 0;
            }
        }

        /* Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .avatar-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 14px;
                margin: 20px 0;
            }
        }

        /* Mobile - Kompakter */
        @media (max-width: 480px) {
            .avatar-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin: 14px 0;
            }
        }
        /* Modern Avatar Selection */
        .avatar-option { 
            aspect-ratio: 1;
            border: 3px solid rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .avatar-option:hover { 
            border-color: #667eea; 
            transform: scale(1.05) translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }
        .avatar-option.selected { 
            border-color: #667eea; 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }
        /* Responsive Form Groups */
        .form-group { margin: 20px 0; }
        .form-group label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 600; 
            color: #1f2937;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        /* Desktop - Mehr Abstand */
        @media (min-width: 769px) {
            .form-group { margin: 28px 0; }
            .form-group label { 
                margin-bottom: 14px;
                font-size: 15px;
            }
        }

        /* Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .form-group { margin: 24px 0; }
            .form-group label { 
                margin-bottom: 12px;
                font-size: 14px;
            }
        }

        /* Mobile - Kompakter */
        @media (max-width: 480px) {
            .form-group { margin: 18px 0; }
            .form-group label { 
                margin-bottom: 8px;
                font-size: 14px;
            }
        }
        .form-group input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 14px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            font-family: inherit;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Desktop - Gr√∂√üere Inputs */
        @media (min-width: 769px) {
            .form-group input {
                padding: 16px 20px;
                border-radius: 16px;
                font-size: 16px;
            }
        }

        /* Mobile - Touch-friendly Inputs */
        @media (max-width: 480px) {
            .form-group input {
                padding: 14px 16px;
                border-radius: 12px;
                font-size: 16px; /* iOS zoom prevention */
            }
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #667eea; 
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        .form-group select { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 14px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            font-family: inherit;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Desktop - Gr√∂√üere Selects */
        @media (min-width: 769px) {
            .form-group select {
                padding: 16px 20px;
                border-radius: 16px;
                font-size: 16px;
            }
        }

        /* Mobile - Touch-friendly Selects */
        @media (max-width: 480px) {
            .form-group select {
                padding: 14px 16px;
                border-radius: 12px;
                font-size: 16px; /* iOS zoom prevention */
            }
        }
        .form-group select:focus { 
            outline: none; 
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        /* Responsive App Buttons */
        .btn { 
            padding: 14px 20px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            font-size: 15px;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            font-family: inherit;
            text-decoration: none;
            width: auto;
        }

        /* Desktop - Kompakte Buttons */
        @media (min-width: 769px) {
            .btn {
                padding: 12px 24px;
                border-radius: 14px;
                font-size: 15px;
                min-height: 44px;
            }
        }

        /* Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .btn {
                padding: 12px 20px;
                border-radius: 14px;
                font-size: 15px;
                min-height: 42px;
            }
        }

        /* Mobile - Touch-friendly Buttons */
        @media (max-width: 480px) {
            .btn {
                padding: 14px 20px;
                border-radius: 12px;
                font-size: 15px;
                min-height: 46px;
            }
        }

        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary { 
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover { 
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-debug { 
            background: linear-gradient(135deg, #ff416c 0%, #ff4757 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 65, 108, 0.3);
            font-size: 14px;
            padding: 12px 20px;
            min-height: 44px;
        }
        .btn-debug:hover { 
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 65, 108, 0.4);
        }
        .progress-bar { 
            background: #e5e7eb; 
            height: 8px; 
            border-radius: 4px; 
            overflow: hidden;
            margin-bottom: 24px;
        }
        .progress-fill { 
            background: #f59e0b; 
            height: 100%; 
            transition: width 0.3s;
        }
        .task-item { 
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .emoji-grid { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 8px; 
            margin: 12px 0;
        }
        .emoji-option { 
            aspect-ratio: 1;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-option:hover { border-color: #f59e0b; }
        .emoji-option.selected { border-color: #f59e0b; background: #fef3c7; }
        .rating-section { margin: 20px 0; }
        .slider { width: 100%; margin: 8px 0; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; }
        .preview { background: #fef3c7; padding: 16px; border-radius: 8px; margin-top: 16px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
        .text-sm { font-size: 14px; }
        .text-gray-600 { color: #6b7280; }
        /* Responsive Typography */
        .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }

        /* Responsive Text Sizes */
        h1 { font-size: 24px; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; }
        
        @media (min-width: 769px) {
            h1 { font-size: 28px; }
            h2 { font-size: 24px; }
            h3 { font-size: 20px; }
        }

        @media (max-width: 480px) {
            h1 { font-size: 22px; }
            h2 { font-size: 18px; }
            h3 { font-size: 16px; }
        }

        /* Responsive Flex Layouts */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }

        /* Mobile Flex Improvements */
        @media (max-width: 480px) {
            .flex.justify-between {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .flex.justify-between > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
        }
        .debug-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .user-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .user-card {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .user-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .user-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .user-avatar {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .task-info {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .task-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: #f3f4f6;
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        /* Toast Notifications - App-Style Center Positioning */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 20px 28px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 320px;
            min-width: 280px;
            font-weight: 500;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 8px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: scale(1.1);
        }

        /* Responsive Toast Adjustments */
        @media (max-width: 480px) {
            .toast {
                max-width: calc(100% - 32px);
                min-width: calc(100% - 32px);
                margin: 0 16px;
                padding: 18px 24px;
                font-size: 15px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .toast {
                max-width: 340px;
                min-width: 300px;
            }
        }

        /* Modern Dial/Wheel Control */
        .dial-container {
            position: relative;
            display: inline-block;
        }

        .dial-wheel {
            transform: rotate(-90deg);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .dial-progress {
            transition: stroke-dashoffset 0.3s ease;
        }

        .dial-text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            font-weight: 600;
            fill: #1f2937;
        }

        .dial-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 60px;
            opacity: 0;
            cursor: pointer;
        }

        .dial-container:hover .dial-wheel {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
        }

        /* Absence Manager Styles */
        .absence-user-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 8px;
            background: white;
            min-height: 120px;
            height: 120px;
        }

        .absence-user-card:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .absence-user-card.selected {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .absence-user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        /* Mobile anpassungen f√ºr absence cards */
        @media (max-width: 480px) {
            .absence-user-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .absence-user-card {
                min-height: 100px;
                height: 100px;
                padding: 12px;
            }
        }

        .absence-entry {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .absence-entry.vacation { border-left: 4px solid #10b981; }
        .absence-entry.work { border-left: 4px solid #3b82f6; }
        .absence-entry.family { border-left: 4px solid #8b5cf6; }
        
        /* Gone Fishing Styles */
        .gone-fishing {
            color: #0891b2;
            font-size: 20px;
            animation: float 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        /* Profile Management Styles */
        .profile-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .profile-info h3 {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .profile-stats {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            gap: 16px;
            margin-top: 4px;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .profile-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .profile-actions .btn-load {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .profile-actions .btn-edit {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .profile-actions .btn-edit:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        }

        .profile-actions .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .profile-actions .btn-delete:hover {
            background: #fecaca;
        }

        .w-full { width: 100%; }
        .space-y-3 > * + * { margin-top: 12px; }

        /* Bewertungssystem */
        .rating-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .rating-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            color: white;
            text-align: center;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            font-size: 2rem;
        }

        .rating-star {
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }

        .rating-star.active,
        .rating-star:hover {
            color: #ffd700;
        }

        .rating-comment {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: vertical;
            min-height: 80px;
        }

        .rating-comment::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .rating-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .rate-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .rate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .cancel-rate-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .task-rating {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .task-rating-stars {
            color: #ffd700;
            margin-right: 10px;
        }

        .rating-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .rating-average {
            font-weight: bold;
            color: #ffd700;
        }

        .rating-count {
            color: #ccc;
        }

        .rate-task-btn {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .rate-task-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
        }

        /* Profile Edit Styles */
        .member-edit-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 10px 0;
        }

        .member-icon-selector {
            position: relative;
        }

        .member-icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .member-icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .icon-dropdown {
            position: absolute;
            top: 60px;
            left: 0;
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .icon-dropdown.show {
            display: block;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .icon-option {
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-size: 1.2rem;
            transition: background 0.2s;
        }

        .icon-option:hover {
            background: #f0f0f0;
        }

        .member-name-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 16px;
        }

        .member-name-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .member-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .member-remove-btn:hover {
            background: #dc2626;
        }

        /* Rate Tasks Styles */
        .member-rating-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .member-rating-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .member-rating-card.completed {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .member-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .rating-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .slider {
            width: 100%;
            margin: 10px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .preview {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        /* Refresh Button Styles */
        .refresh-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-button:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .refresh-button:active {
            transform: rotate(180deg) scale(0.95);
        }

        /* Responsive positioning for mobile */
        @media (max-width: 480px) {
            .refresh-button {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        /* Temporary residents icon selection styles */
        .temp-icon-btn {
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .temp-icon-btn:hover {
            border-color: #f59e0b;
            background: #fef3c7;
            transform: scale(1.05);
        }

        .temp-icon-btn.selected {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        /* Alarm button animations */
        @keyframes pulse-red {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes glow-red {
            0% { box-shadow: 0 0 5px #ef4444; }
            100% { box-shadow: 0 0 20px #ef4444, 0 0 30px #ef4444; }
        }

        /* Urgent task styles */
        .urgent-task {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            border-left: 5px solid #ef4444 !important;
            animation: urgent-flash 3s ease-in-out infinite;
        }

        @keyframes urgent-flash {
            0%, 100% { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
            50% { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        }

        /* Modal styles for task selection */
        .urgent-task-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .urgent-task-modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body>
    <!-- Refresh Button -->
    <button class="refresh-button" onclick="refreshCurrentPage()" title="Seite aktualisieren">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <div class="app-container">


        <div class="container">
        <!-- WG Profile Selection Screen -->
        <div id="profileSelection" class="phase">
            <div class="debug-info">
                <strong>üè† PUTZPLAN:</strong> WG-Profil ausw√§hlen oder neues erstellen
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-3xl mb-2">üè† Putzplan Manager</h1>
                <p class="opacity-90 mb-6">W√§hle dein WG-Profil oder erstelle ein neues</p>
            </div>

            <!-- Existing Profiles -->
            <div class="card">
                <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
                    <i class="fas fa-users"></i>
                    Bestehende WG-Profile
                </h2>
                <div id="profileList" class="space-y-3">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                <div id="noProfilesMessage" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-home text-4xl mb-4 opacity-50"></i>
                    <p>Noch keine WG-Profile erstellt</p>
                    <p class="text-sm">Erstelle dein erstes Profil!</p>
                </div>
            </div>

            <!-- New Profile Action -->
            <div class="card">
                <h2 class="font-bold text-xl mb-4 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Neues WG-Profil
                </h2>
                <div class="space-y-3">
                    <button class="btn btn-success w-full" onclick="createNewProfile()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 16px; font-size: 16px;">
                        <i class="fas fa-plus mr-2"></i>
                        Neue WG erstellen
                    </button>
                    <button class="btn btn-primary w-full" onclick="loadDariusWG()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 16px; font-size: 16px;">
                        <i class="fas fa-rocket mr-2"></i>
                        Darius WG (Vorkonfiguriert)
                    </button>
                </div>
            </div>

            <!-- Debug Actions -->
            <div class="card">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-tools"></i>
                    Debug & Verwaltung
                </h3>
                <div class="flex gap-2">
                    <button class="btn btn-debug" onclick="alert('‚úÖ JavaScript funktioniert!')">üß™ JS Test</button>
                    <button class="btn btn-debug" onclick="clearAllProfiles()">üóëÔ∏è Alle Profile l√∂schen</button>
                    <button class="btn btn-debug" onclick="exportProfiles()">üì§ Profile exportieren</button>
                    <button class="btn btn-debug" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
                </div>
            </div>
        </div>

        <!-- Phase 0: WG Setup -->
        <div id="phase0" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> WG-Name und Mitglieder sind vorausgef√ºllt
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üè† WG einrichten</h1>
                <p>Zuerst die Grundlagen: Wie hei√üt eure WG und wer wohnt dort?</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label>Name der WG</label>
                    <input type="text" id="wgName" value="Villa Kunterbunt" />
                </div>

                <div class="form-group">
                    <label>Wie viele Personen wohnen in der WG?</label>
                    <select id="memberCount" onchange="updateMemberCount()">
                        <option value="2">2 Personen</option>
                        <option value="3" selected>3 Personen</option>
                        <option value="4">4 Personen</option>
                        <option value="5">5 Personen</option>
                        <option value="6">6 Personen</option>
                    </select>
                </div>

                <div id="memberNames">
                    <h3 class="font-bold mb-4">Namen der WG-Mitglieder:</h3>
                    <div class="form-group">
                        <label>Person 1</label>
                        <input type="text" class="member-name" value="Darius" />
                    </div>
                    <div class="form-group">
                        <label>Person 2</label>
                        <input type="text" class="member-name" value="Lilly" />
                    </div>
                    <div class="form-group">
                        <label>Person 3</label>
                        <input type="text" class="member-name" value="Hendrik I" />
                    </div>
                    <div class="form-group">
                        <label>Person 4</label>
                        <input type="text" class="member-name" value="Hendrik II" />
                    </div>
                    <div class="form-group">
                        <label>Person 5</label>
                        <input type="text" class="member-name" value="Hamza Hamza" />
                    </div>
                    <div class="form-group">
                        <label>Person 6</label>
                        <input type="text" class="member-name" value="Sofia" />
                    </div>
                </div>

                <div class="flex justify-between">
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
                        <button class="btn btn-success" onclick="setupRealWG()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">üè† Darius WG Setup</button>
                        <button class="btn btn-warning" onclick="completeAutoSetup()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">‚ö° Komplett-Auto-Setup</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="nextPhase(1)">Weiter zu Profilen ‚Üí</button>
                        <button class="btn btn-debug" onclick="debugFillAndSkip(1)">üêõ Skip Phase</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 1: Individual User Creation -->
        <div id="phase1" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Profile sind vorausgef√ºllt - einfach durchklicken!
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üë§ Profil erstellen</h1>
                <p>Jetzt erstellt jede Person ihr individuelles Profil:</p>
                <div class="text-center mt-4">
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span id="currentMember">Anna</span> ist dran
                    </span>
                </div>
            </div>

            <div class="card">
                <h2 class="font-bold mb-4">W√§hle deinen Avatar</h2>
                
                <div style="margin-bottom: 16px;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">üé≠ Emojis</h3>
                    <div class="avatar-grid">
                        <div class="avatar-option selected" onclick="selectAvatar(this, 'üòä')">üòä</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üòé')">üòé</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'ü§ì')">ü§ì</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üò¥')">üò¥</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'ü•≥')">ü•≥</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üòá')">üòá</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'ü§î')">ü§î</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üòã')">üòã</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üôÉ')">üôÉ</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'ü§™')">ü§™</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'üòå')">üòå</div>
                        <div class="avatar-option" onclick="selectAvatar(this, 'ü§ó')">ü§ó</div>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #374151;">üë§ Professionelle Icons</h3>
                    <div class="avatar-grid">
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-user-circle')"><i class="fas fa-user-circle" style="font-size: 20px; color: #3b82f6;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-user-tie')"><i class="fas fa-user-tie" style="font-size: 20px; color: #1f2937;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-user-graduate')"><i class="fas fa-user-graduate" style="font-size: 20px; color: #059669;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-user-astronaut')"><i class="fas fa-user-astronaut" style="font-size: 20px; color: #7c3aed;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-user-ninja')"><i class="fas fa-user-ninja" style="font-size: 20px; color: #dc2626;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-crown')"><i class="fas fa-crown" style="font-size: 20px; color: #f59e0b;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-brain')"><i class="fas fa-brain" style="font-size: 20px; color: #ec4899;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-heart')"><i class="fas fa-heart" style="font-size: 20px; color: #ef4444;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-star')"><i class="fas fa-star" style="font-size: 20px; color: #f59e0b;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-bolt')"><i class="fas fa-bolt" style="font-size: 20px; color: #eab308;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-fire')"><i class="fas fa-fire" style="font-size: 20px; color: #f97316;"></i></div>
                        <div class="avatar-option" onclick="selectAvatarIcon(this, 'fas fa-diamond')"><i class="fas fa-gem" style="font-size: 20px; color: #06b6d4;"></i></div>
                    </div>
                </div>
            </div>

                <div class="form-group">
                    <label>Dein Name</label>
                    <input type="text" id="userName" value="Anna" />
                </div>

                <div class="form-group">
                    <label>E-Mail (optional)</label>
                    <input type="email" id="userEmail" value="anna@villa-kunterbunt.de" />
                </div>

                <div class="flex justify-between">
                    <button class="btn btn-primary" id="profileButton" onclick="nextPhase(2)">Profil speichern ‚Üí</button>
                    <button class="btn btn-debug" onclick="debugFillAndSkip(2)">üêõ Skip All Profiles</button>
                </div>
            </div>
        </div>

        <!-- Phase 1b: Profile Overview -->
        <div id="phase1b" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Profile-√úbersicht - alle erstellen Profile ansehen und bearbeiten
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üë§ Profile-√úbersicht</h1>
                <p>Alle WG-Mitglieder und ihre Profile verwalten</p>
            </div>

            <div id="profileOverviewContainer">
                <!-- Wird dynamisch gef√ºllt -->
            </div>

            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="nextPhase(2)">Weiter zu Tasks ‚Üí</button>
                    <button class="btn btn-debug" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
                </div>
            </div>
        </div>

        <!-- Phase 2: Task Creation -->
        <div id="phase2" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> 5 Standard-Tasks sind vorausgef√ºllt
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 40%"></div>
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üìù Tasks erstellen</h1>
                <p>Welche Aufgaben fallen in der <strong id="wgNameDisplay">Villa Kunterbunt</strong> an?</p>
            </div>

            <div class="card">
                <div id="taskList">
                    <!-- DEBUG: Vorausgef√ºllte Tasks -->
                    <div class="task-item" data-emoji="üßπ">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" value="K√ºche putzen" />
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <input type="text" value="Sp√ºlmaschine ausr√§umen, Oberfl√§chen wischen, Herd reinigen" />
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="minDaysEnabled_k0" onchange="toggleMinDays('k0', this.checked)" checked>
                                <label for="minDaysEnabled_k0" style="margin: 0;">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                            </div>
                            <div id="minDaysSlider_k0" style="margin-left: 24px;">
                                <div style="display: flex; align-items: center; gap: 16px; padding: 12px;">
                                    <div class="dial-container">
                                        <svg class="dial-wheel" width="60" height="60" viewBox="0 0 60 60">
                                            <circle cx="30" cy="30" r="25" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
                                            <circle cx="30" cy="30" r="25" stroke="#3b82f6" stroke-width="4" fill="none" 
                                                    stroke-dasharray="157" stroke-dashoffset="150" 
                                                    id="dialProgress_k0" class="dial-progress"></circle>
                                            <text x="30" y="35" text-anchor="middle" class="dial-text" id="dialText_k0">1</text>
                                        </svg>
                                        <input type="range" class="dial-input" min="1" max="30" value="1" 
                                               oninput="updateDialMinDays('k0', this.value)" id="dialInput_k0">
                                    </div>
                                    <div style="font-size: 14px; color: #64748b;">
                                        <div><strong id="dialLabel_k0">1 Tag</strong> Mindestpause</div>
                                        <div style="font-size: 12px; margin-top: 2px;">zwischen Ausf√ºhrungen</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Icon w√§hlen</label>
                            
                            <div style="margin-bottom: 12px;">
                                <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151;">üßπ Putzen & Hygiene</h4>
                                <div class="emoji-grid">
                                    <div class="emoji-option selected" onclick='selectIcon(this, "fas fa-broom", "üßπ")' data-icon="fas fa-broom"><i class="fas fa-broom"></i></div>
                                    <div class="emoji-option" onclick='selectIcon(this, "fas fa-shower", "üõÅ")' data-icon="fas fa-shower"><i class="fas fa-shower"></i></div>
                                    <div class="emoji-option" onclick='selectIcon(this, "fas fa-soap", "üßΩ")' data-icon="fas fa-soap"><i class="fas fa-soap"></i></div>
                                    <div class="emoji-option" onclick='selectIcon(this, "fas fa-spray-can", "üß¥")' data-icon="fas fa-spray-can"><i class="fas fa-spray-can"></i></div>
                                    <div class="emoji-option" onclick='selectIcon(this, "fas fa-toilet-paper", "üßª")' data-icon="fas fa-toilet-paper"><i class="fas fa-toilet-paper"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-bath', 'üõÅ')" data-icon="fas fa-bath"><i class="fas fa-bath"></i></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 12px;">
                                <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151;">üçΩÔ∏è K√ºche & Essen</h4>
                                <div class="emoji-grid">
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-utensils', 'üçΩÔ∏è')" data-icon="fas fa-utensils"><i class="fas fa-utensils"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-coffee', '‚òï')" data-icon="fas fa-coffee"><i class="fas fa-coffee"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-wine-glass', 'üç∑')" data-icon="fas fa-wine-glass"><i class="fas fa-wine-glass"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-blender', 'ü•§')" data-icon="fas fa-blender"><i class="fas fa-blender"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-cookie-bite', 'üç™')" data-icon="fas fa-cookie-bite"><i class="fas fa-cookie-bite"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-pizza-slice', 'üçï')" data-icon="fas fa-pizza-slice"><i class="fas fa-pizza-slice"></i></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 12px;">
                                <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151;">üè† Haushalt & Ordnung</h4>
                                <div class="emoji-grid">
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-home', 'üè†')" data-icon="fas fa-home"><i class="fas fa-home"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-box', 'üì¶')" data-icon="fas fa-box"><i class="fas fa-box"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-trash', 'üóëÔ∏è')" data-icon="fas fa-trash"><i class="fas fa-trash"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-recycle', '‚ôªÔ∏è')" data-icon="fas fa-recycle"><i class="fas fa-recycle"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-couch', 'üõãÔ∏è')" data-icon="fas fa-couch"><i class="fas fa-couch"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-bed', 'üõèÔ∏è')" data-icon="fas fa-bed"><i class="fas fa-bed"></i></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 12px;">
                                <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151;">üîß Reparatur & Wartung</h4>
                                <div class="emoji-grid">
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-tools', 'üîß')" data-icon="fas fa-tools"><i class="fas fa-tools"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-wrench', 'üîß')" data-icon="fas fa-wrench"><i class="fas fa-wrench"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-hammer', 'üî®')" data-icon="fas fa-hammer"><i class="fas fa-hammer"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-lightbulb', 'üí°')" data-icon="fas fa-lightbulb"><i class="fas fa-lightbulb"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-plug', 'üîå')" data-icon="fas fa-plug"><i class="fas fa-plug"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-battery-half', 'üîã')" data-icon="fas fa-battery-half"><i class="fas fa-battery-half"></i></div>
                                </div>
                            </div>

                            <div>
                                <h4 style="font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #374151;">üåø Natur & Sonstiges</h4>
                                <div class="emoji-grid">
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-seedling', 'üå±')" data-icon="fas fa-seedling"><i class="fas fa-seedling"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-leaf', 'üçÉ')" data-icon="fas fa-leaf"><i class="fas fa-leaf"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-car', 'ÔøΩ')" data-icon="fas fa-car"><i class="fas fa-car"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-bicycle', 'üö¥')" data-icon="fas fa-bicycle"><i class="fas fa-bicycle"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-star', '‚ú®')" data-icon="fas fa-star"><i class="fas fa-star"></i></div>
                                    <div class="emoji-option" onclick="selectIcon(this, 'fas fa-heart', '‚ù§Ô∏è')" data-icon="fas fa-heart"><i class="fas fa-heart"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="task-item" data-emoji="üõÅ">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" value="Bad putzen" />
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <input type="text" value="Toilette, Dusche, Waschbecken und Spiegel reinigen" />
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="minDaysEnabled_k1" onchange="toggleMinDays('k1', this.checked)" checked>
                                <label for="minDaysEnabled_k1" style="margin: 0;">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                            </div>
                            <div id="minDaysSlider_k1" style="margin-left: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>Mindestens </span>
                                    <input type="range" class="min-days-range" min="1" max="30" value="3" style="width: 150px;" oninput="updateMinDays('k1', this.value)">
                                    <span id="minDaysValue_k1">3</span>
                                    <span> Tage Pause</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Emoji w√§hlen</label>
                            <div class="emoji-grid">
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßπ')">üßπ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                                <div class="emoji-option selected" onclick="selectEmoji(this, 'üõÅ')">üõÅ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßΩ')">üßΩ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üóëÔ∏è')">üóëÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üß¥')">üß¥</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üí°')">üí°</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üå±')">üå±</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üîß')">üîß</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üì¶')">üì¶</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üè†')">üè†</div>
                                <div class="emoji-option" onclick="selectEmoji(this, '‚ú®')">‚ú®</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-item" data-emoji="üóëÔ∏è">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" value="M√ºll rausbringen" />
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <input type="text" value="Alle M√ºlleimer leeren und M√ºlls√§cke zur Stra√üe bringen" />
                        </div>
                        <div class="form-group">
                            <label>‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                            <select class="min-days-select">
                                <option value="0" selected>Kann t√§glich gemacht werden</option>
                                <option value="1">Mindestens 1 Tag Pause</option>
                                <option value="2">Mindestens 2 Tage Pause</option>
                                <option value="3">Mindestens 3 Tage Pause</option>
                                <option value="7">Mindestens 1 Woche Pause</option>
                                <option value="14">Mindestens 2 Wochen Pause</option>
                                <option value="30">Nur 1x pro Monat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Emoji w√§hlen</label>
                            <div class="emoji-grid">
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßπ')">üßπ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üõÅ')">üõÅ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßΩ')">üßΩ</div>
                                <div class="emoji-option selected" onclick="selectEmoji(this, 'üóëÔ∏è')">üóëÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üß¥')">üß¥</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üí°')">üí°</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üå±')">üå±</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üîß')">üîß</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üì¶')">üì¶</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üè†')">üè†</div>
                                <div class="emoji-option" onclick="selectEmoji(this, '‚ú®')">‚ú®</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-item" data-emoji="üßΩ">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" value="Staubsaugen" />
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <input type="text" value="Alle R√§ume und Flure staubsaugen" />
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="minDaysEnabled_3" onchange="toggleMinDays(3, this.checked)" checked>
                                <label for="minDaysEnabled_3" style="margin: 0;">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                            </div>
                            <div id="minDaysSlider_3" style="margin-left: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>Mindestens </span>
                                    <input type="range" class="min-days-range" min="1" max="30" value="7" style="width: 150px;" oninput="updateMinDays(3, this.value)">
                                    <span id="minDaysValue_3">7</span>
                                    <span> Tage Pause</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Emoji w√§hlen</label>
                            <div class="emoji-grid">
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßπ')">üßπ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üõÅ')">üõÅ</div>
                                <div class="emoji-option selected" onclick="selectEmoji(this, 'üßΩ')">üßΩ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üóëÔ∏è')">üóëÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üß¥')">üß¥</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üí°')">üí°</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üå±')">üå±</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üîß')">üîß</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üì¶')">üì¶</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üè†')">üè†</div>
                                <div class="emoji-option" onclick="selectEmoji(this, '‚ú®')">‚ú®</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-item" data-emoji="üå±">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" value="Pflanzen gie√üen" />
                        </div>
                        <div class="form-group">
                            <label>Beschreibung</label>
                            <input type="text" value="Alle Zimmerpflanzen und Balkonpflanzen gie√üen" />
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="minDaysEnabled_4" onchange="toggleMinDays(4, this.checked)" checked>
                                <label for="minDaysEnabled_4" style="margin: 0;">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                            </div>
                            <div id="minDaysSlider_4" style="margin-left: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>Mindestens </span>
                                    <input type="range" class="min-days-range" min="1" max="30" value="2" style="width: 150px;" oninput="updateMinDays(4, this.value)">
                                    <span id="minDaysValue_4">2</span>
                                    <span> Tage Pause</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Emoji w√§hlen</label>
                            <div class="emoji-grid">
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßπ')">üßπ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üõÅ')">üõÅ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üßΩ')">üßΩ</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üóëÔ∏è')">üóëÔ∏è</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üß¥')">üß¥</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üí°')">üí°</div>
                                <div class="emoji-option selected" onclick="selectEmoji(this, 'üå±')">üå±</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üîß')">üîß</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üì¶')">üì¶</div>
                                <div class="emoji-option" onclick="selectEmoji(this, 'üè†')">üè†</div>
                                <div class="emoji-option" onclick="selectEmoji(this, '‚ú®')">‚ú®</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between">
                    <div class="flex gap-2">
                        <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                        <button class="btn btn-secondary" onclick="addTask()">+ Weiteren Task hinzuf√ºgen</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary mt-4" onclick="nextPhase('2_5')">Weiter zur Bewertung ‚Üí</button>
                        <button class="btn btn-debug mt-4" onclick="debugFillAndSkip(3)">üêõ Skip Phase</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 2.5: User Overview -->
        <div id="phase2_5" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Benutzer√ºbersicht - W√§hle aus, wer bewerten soll
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 60%"></div>
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üë• Wer soll bewerten?</h1>
                <p>W√§hle ein WG-Mitglied aus, um die Tasks zu bewerten:</p>
            </div>

            <div class="card">
                <div id="userOverviewList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>

                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                    <div>
                        <button class="btn btn-primary" onclick="startAllRatings()" style="display: none;" id="startAllBtn">Alle fertig - Weiter ‚Üí</button>
                        <button class="btn btn-debug" onclick="debugFillAllRatings()">üêõ Fill All Ratings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 3: Collaborative Rating -->
        <div id="phase3" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Slider-Werte werden automatisch gesetzt
            </div>

            <div class="progress-bar">
                <div class="progress-fill" style="width: 80%"></div>
            </div>

            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üéØ Task bewerten</h1>
                <p><strong id="ratingMemberName">Anna</strong>, bewerte jeden Task nach deiner Einsch√§tzung:</p>
                <div class="text-center mt-4">
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full inline-block mb-2">
                        Person <span id="currentRatingMember">1</span> von <span id="totalMembers">3</span>
                    </div>
                    <br>
                    <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full inline-block">
                        Task <span id="currentTask">1</span> von <span id="totalTasks">5</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="text-center mb-4">
                    <div style="font-size: 48px; margin-bottom: 8px;" id="taskEmoji">üßπ</div>
                    <h2 class="font-bold" id="taskTitle">K√ºche putzen</h2>
                    <p class="text-gray-600" id="taskDescription">Sp√ºlmaschine ausr√§umen, Oberfl√§chen wischen...</p>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">‚è±Ô∏è Wie lange brauchst DU f√ºr diesen Task? (<span id="minutesValue">30</span> Min.)</label>
                    <input type="range" class="slider" min="5" max="120" step="5" value="30" 
                           onchange="updateValue('minutesValue', this.value)" />
                    <div class="slider-labels">
                        <span>5 Min</span>
                        <span>2h</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">üò§ Wie nervig ist dieser Task? (<span id="painValue">5</span>/10)</label>
                    <input type="range" class="slider" min="1" max="10" value="5" 
                           onchange="updateValue('painValue', this.value)" />
                    <div class="slider-labels">
                        <span>üòä Entspannt</span>
                        <span>üò§ Sehr nervig</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">‚≠ê Wie wichtig ist dieser Task? (<span id="importanceValue">5</span>/10)</label>
                    <input type="range" class="slider" min="1" max="10" value="5" 
                           onchange="updateValue('importanceValue', this.value)" />
                    <div class="slider-labels">
                        <span>Kann warten</span>
                        <span>Sehr wichtig</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">üìÖ Wie oft pro Monat? (<span id="frequencyValue">4</span>x)</label>
                    <input type="range" class="slider" min="1" max="30" value="4" 
                           onchange="updateValue('frequencyValue', this.value)" />
                    <div class="slider-labels">
                        <span>1x</span>
                        <span>T√§glich</span>
                    </div>
                </div>

                <div class="preview">
                    <h3 class="font-bold mb-2">Deine Bewertung:</h3>
                    <div class="flex justify-between">
                        <span>Punkte pro Task: <strong id="taskPoints">38</strong></span>
                        <span>Punkte pro Monat: <strong id="monthlyPoints">152</strong></span>
                    </div>
                </div>

                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                    <div>
                        <button class="btn btn-primary" onclick="nextTask()">N√§chster Task ‚Üí</button>
                        <button class="btn btn-debug" onclick="debugAutoRate()">üêõ Auto-Rate</button>
                    </div>
                </div>
            </div>

            <div class="card" style="background: #f0fdf4; border: 2px solid #bbf7d0;">
                <div class="text-center">
                    <h3 class="font-bold mb-2">‚ÑπÔ∏è Info</h3>
                    <p class="text-sm">
                        Sp√§ter werden alle Bewertungen der WG-Mitglieder gemittelt.<br>
                        Formel: (Minuten + Minuten √ó Pain √ó 0.1) √ó (Wichtigkeit √∑ 10)
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="phaseComplete" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Haupt-Dashboard - Navigation zu verschiedenen Bereichen
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">ÔøΩ WG Dashboard</h1>
                <p><strong id="dashboardWgName">Villa Kunterbunt</strong> - Putzplan App</p>
                <div style="margin-top: 12px;">
                    <button class="btn btn-secondary" onclick="showProfileSelection()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 14px; padding: 8px 16px;">
                        <i class="fas fa-exchange-alt mr-1"></i>
                        Profil wechseln
                    </button>
                </div>
            </div>

            <div class="card">
                <h3 class="font-bold mb-4">üìä Schnell√ºbersicht</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div class="card bg-blue-50" style="padding: 16px;">
                        <div class="text-center">
                            <div style="font-size: 24px; font-weight: bold;" id="totalTasksCount">5</div>
                            <div class="text-sm text-gray-600">Tasks aktiv</div>
                        </div>
                    </div>
                    <div class="card bg-green-50" style="padding: 16px;">
                        <div class="text-center">
                            <div style="font-size: 24px; font-weight: bold;" id="completedTasksToday">0</div>
                            <div class="text-sm text-gray-600">Heute erledigt</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="font-bold mb-4">üß≠ Navigation</h3>
                <div style="display: grid; gap: 12px;">
                    <button class="btn btn-primary" onclick="showTaskTable()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-table" style="width: 20px;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Tabellen-√úbersicht</div>
                                <div class="text-sm opacity-80">Tasks erledigen und verfolgen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showRatingOverview()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; position: relative;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-star" style="width: 20px; color: #ffd700;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Bewertungen</div>
                                <div class="text-sm opacity-80">Aufgaben bewerten & √úbersicht</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="pendingRatingsBadge" style="display: none; background: #ff4444; color: white; border-radius: 12px; padding: 4px 8px; font-size: 12px; font-weight: bold;"></span>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showRateTasks()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-star-half-alt" style="width: 20px; color: #f59e0b;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Rate Tasks</div>
                                <div class="text-sm opacity-80">Tasks von jedem Mitglied bewerten lassen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showTaskManagement()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-cog" style="width: 20px;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Tasks bearbeiten</div>
                                <div class="text-sm opacity-80">Namen √§ndern, Pausen einstellen, Checklisten</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    
                    <button class="btn btn-warning" onclick="showAbsenceManager()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-calendar-times" style="width: 20px; color: white;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold" style="color: white;">Abwesenheit melden</div>
                                <div class="text-sm opacity-90" style="color: white;">Urlaub/Gesch√§ftsreise eintragen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: white;"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showPeriodSettings()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-calendar-alt" style="width: 20px; color: #6366f1;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Zeitraum-Einstellungen</div>
                                <div class="text-sm opacity-80">Start- und Enddatum festlegen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-info" onclick="showPhase('temporaryResidents')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-user-plus" style="width: 20px; color: white;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold" style="color: white;">Besuch/Tempor√§re Bewohner</div>
                                <div class="text-sm opacity-90" style="color: white;">Kurzzeitig Personen zum Putzplan hinzuf√ºgen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: white;"></i>
                    </button>
                </div>
                
                    <button class="btn btn-success" onclick="showPhase('backupManagement')" style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-shield-alt" style="width: 20px; color: white;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold" style="color: white;">Sicherungen</div>
                                <div class="text-sm opacity-90" style="color: white;">Daten sichern & wiederherstellen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: white;"></i>
                    </button>
                
                <div class="flex justify-center mt-6">
                    <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
                </div>
            </div>
        </div>

        <!-- üíæ Sicherungen Page -->
        <div id="backupManagement" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Datensicherung - Export, Import und Auto-Backup Verwaltung
            </div>
            
            <div class="card gradient-bg" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h1 class="font-bold text-2xl mb-2" style="color: white;">üíæ Sicherungen</h1>
                <p style="color: white; opacity: 0.9;">Daten sichern, wiederherstellen und Auto-Backups verwalten</p>
            </div>

            <!-- Export Section -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #10b981;">üì§ Daten exportieren</h3>
                <p class="mb-4 text-gray-600">Erstellen Sie eine vollst√§ndige Sicherung aller Ihrer Daten als JSON-Datei.</p>
                
                <button class="btn" onclick="exportAppData()" style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 100%;">
                    <i class="fas fa-download" style="font-size: 18px;"></i>
                    <div>
                        <div class="font-bold">Backup herunterladen</div>
                        <div class="text-sm opacity-90">Alle Profile, Tasks, Bewertungen & Einstellungen</div>
                    </div>
                </button>
            </div>

            <!-- Import Section -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #f59e0b;">üì• Daten wiederherstellen</h3>
                <p class="mb-4 text-gray-600">Stellen Sie eine vorherige Sicherung wieder her. <strong>‚ö†Ô∏è Warnung:</strong> Alle aktuellen Daten werden √ºberschrieben!</p>
                
                <button class="btn" onclick="document.getElementById('importFile').click()" style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 100%;">
                    <i class="fas fa-upload" style="font-size: 18px;"></i>
                    <div>
                        <div class="font-bold">Backup-Datei ausw√§hlen</div>
                        <div class="text-sm opacity-90">JSON-Datei von vorherigem Export</div>
                    </div>
                </button>
                
                <!-- Hidden file input for import -->
                <input type="file" id="importFile" accept=".json" onchange="importAppData(this)" style="display: none;">
            </div>

            <!-- Auto-Backup Section -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #6366f1;">üîÑ Auto-Backup System</h3>
                <p class="mb-4 text-gray-600">Automatische Sicherungen werden bei jeder wichtigen √Ñnderung erstellt.</p>
                
                <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="showBackupList()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-history" style="width: 20px; color: #6366f1;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Backup-Verlauf anzeigen</div>
                                <div class="text-sm opacity-80">Liste aller automatischen Sicherungen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="testAutoBackup()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-play-circle" style="width: 20px; color: #059669;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">Test-Backup erstellen</div>
                                <div class="text-sm opacity-80">Manuell ein Backup ausl√∂sen zum Testen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Status Info -->
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                        <span class="font-bold text-sm" style="color: #1e40af;">Auto-Backup Status</span>
                    </div>
                    <div class="text-sm" style="color: #1e40af;">
                        <div style="margin-bottom: 4px;">‚úÖ <strong>Aktiv:</strong> Automatische Sicherung l√§uft</div>
                        <div style="margin-bottom: 4px;">üì¶ <strong>Ausl√∂ser:</strong> Task-√Ñnderungen, Bewertungen, Profil-Updates</div>
                        <div style="margin-bottom: 4px;">üïê <strong>Speicher:</strong> Letzte 10 Backups werden behalten</div>
                        <div>üíæ <strong>Ort:</strong> Browser LocalStorage (automatisch)</div>
                    </div>
                </div>
            </div>

            <!-- Emergency Recovery Section -->
            <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b;">
                <h3 class="font-bold mb-4" style="color: #92400e;">üö® Notfall-Wiederherstellung</h3>
                <p class="mb-4" style="color: #92400e;">Falls die App abst√ºrzt, wird beim n√§chsten Start automatisch die letzte Sicherung angeboten.</p>
                
                <div style="color: #92400e; font-size: 14px;">
                    <div style="margin-bottom: 8px;"><strong>üìã So funktioniert es:</strong></div>
                    <div style="margin-bottom: 4px;">1Ô∏è‚É£ App erkennt unerwarteten Neustart</div>
                    <div style="margin-bottom: 4px;">2Ô∏è‚É£ Pr√ºft, ob aktuelle Sicherung verf√ºgbar ist (max. 24h alt)</div>
                    <div style="margin-bottom: 4px;">3Ô∏è‚É£ Bietet automatisch Wiederherstellung an</div>
                    <div>4Ô∏è‚É£ Ihre Daten sind sicher! üõ°Ô∏è</div>
                </div>
            </div>
            
            <div class="flex justify-center mt-6">
                <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
            </div>
        </div>

        <!-- üë• Tempor√§re Bewohner/Besuch Page -->
        <div id="temporaryResidents" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Tempor√§re Bewohner - Besuch oder tempor√§re Personen zum Putzplan hinzuf√ºgen
            </div>
            
            <div class="card gradient-bg" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <h1 class="font-bold text-2xl mb-2" style="color: white;">üë• Tempor√§re Bewohner</h1>
                <p style="color: white; opacity: 0.9;">Besuch oder tempor√§re Mitbewohner f√ºr bestimmte Zeitr√§ume hinzuf√ºgen</p>
            </div>

            <!-- Neue tempor√§re Person hinzuf√ºgen -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #f59e0b;">‚ûï Neue tempor√§re Person hinzuf√ºgen</h3>
                
                <div style="display: grid; gap: 16px;">
                    <div class="form-group">
                        <label class="font-bold">üë§ Name der Person</label>
                        <input type="text" id="tempPersonName" placeholder="z.B. Lisa (Besuch), Max (Zwischenmieter)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="font-bold">üìÖ Von (Start-Datum)</label>
                            <input type="date" id="tempPersonStartDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="font-bold">üìÖ Bis (End-Datum)</label>
                            <input type="date" id="tempPersonEndDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="font-bold">üé≠ Icon ausw√§hlen</label>
                        <div id="tempPersonIconSelector" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 8px;">
                            <button type="button" onclick="selectTempPersonIcon('üë§')" class="icon-btn temp-icon-btn" data-icon="üë§">üë§</button>
                            <button type="button" onclick="selectTempPersonIcon('üßë')" class="icon-btn temp-icon-btn" data-icon="üßë">üßë</button>
                            <button type="button" onclick="selectTempPersonIcon('üë©')" class="icon-btn temp-icon-btn" data-icon="üë©">üë©</button>
                            <button type="button" onclick="selectTempPersonIcon('üë®')" class="icon-btn temp-icon-btn" data-icon="üë®">üë®</button>
                            <button type="button" onclick="selectTempPersonIcon('üßë‚Äçüéì')" class="icon-btn temp-icon-btn" data-icon="üßë‚Äçüéì">üßë‚Äçüéì</button>
                            <button type="button" onclick="selectTempPersonIcon('üë®‚Äçüíº')" class="icon-btn temp-icon-btn" data-icon="üë®‚Äçüíº">üë®‚Äçüíº</button>
                            <button type="button" onclick="selectTempPersonIcon('üë©‚Äçüíº')" class="icon-btn temp-icon-btn" data-icon="üë©‚Äçüíº">üë©‚Äçüíº</button>
                            <button type="button" onclick="selectTempPersonIcon('üßë‚Äçüç≥')" class="icon-btn temp-icon-btn" data-icon="üßë‚Äçüç≥">üßë‚Äçüç≥</button>
                            <button type="button" onclick="selectTempPersonIcon('üè†')" class="icon-btn temp-icon-btn" data-icon="üè†">üè†</button>
                            <button type="button" onclick="selectTempPersonIcon('‚úàÔ∏è')" class="icon-btn temp-icon-btn" data-icon="‚úàÔ∏è">‚úàÔ∏è</button>
                            <button type="button" onclick="selectTempPersonIcon('üéí')" class="icon-btn temp-icon-btn" data-icon="üéí">üéí</button>
                            <button type="button" onclick="selectTempPersonIcon('üõèÔ∏è')" class="icon-btn temp-icon-btn" data-icon="üõèÔ∏è">üõèÔ∏è</button>
                        </div>
                        <input type="hidden" id="selectedTempIcon" value="üë§">
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 16px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-calculator" style="color: #d97706;"></i>
                            <span class="font-bold" style="color: #92400e;">Punkte-Anpassung</span>
                        </div>
                        <div style="color: #92400e; font-size: 14px;">
                            üìà <strong>Automatische Erh√∂hung:</strong> Die Gesamtpunkte aller Tasks werden f√ºr den gew√§hlten Zeitraum um <strong>1/6 (‚âà16.7%)</strong> erh√∂ht, um die zus√§tzliche Person zu ber√ºcksichtigen.
                        </div>
                    </div>
                    
                    <button onclick="addTemporaryPerson()" class="btn" style="padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 16px; font-weight: bold;">
                        <i class="fas fa-user-plus"></i> Person hinzuf√ºgen
                    </button>
                </div>
            </div>

            <!-- Aktuelle tempor√§re Personen -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #6366f1;">üìã Aktuelle tempor√§re Bewohner</h3>
                <div id="temporaryPersonsList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Vergangene tempor√§re Personen -->
            <div class="card">
                <h3 class="font-bold mb-4" style="color: #6b7280;">üìú Vergangene tempor√§re Bewohner</h3>
                <div id="pastTemporaryPersonsList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
            
            <div class="flex justify-center mt-6">
                <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
            </div>
        </div>

        <!-- Task Management Page -->
        <div id="taskManagement" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Task-Verwaltung - Bearbeiten von Namen, Pausen und Checklisten
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">‚öôÔ∏è Tasks bearbeiten</h1>
                <p>Namen √§ndern, Mindestabst√§nde anpassen und Checklisten erstellen</p>
            </div>

            <div class="card">
                <div id="taskManagementList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                
                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="saveTaskChanges()">√Ñnderungen speichern</button>
                        <button class="btn btn-primary" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rating Overview Page -->
        <div id="ratingOverview" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Bewertungs√ºbersicht - Aufgaben bewerten und Statistiken einsehen
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">‚≠ê Bewertungs√ºbersicht</h1>
                <p>Monatliche Leistungs√ºbersicht und Task-Qualit√§tsbewertung</p>
            </div>

            <!-- User Identity Selection -->
            <div class="card">
                <h3 class="font-bold mb-4">ÔøΩ Wer bist du?</h3>
                <div class="form-group">
                    <label>W√§hle deinen Namen, um Tasks bewerten zu k√∂nnen:</label>
                    <select id="ratingUserSelect" class="form-control" onchange="updateRatingInterface()">
                        <option value="">-- W√§hle deinen Namen --</option>
                        <!-- Wird dynamisch gef√ºllt -->
                    </select>
                </div>
            </div>

            <!-- Monthly Performance Overview -->
            <div class="card">
                <h3 class="font-bold mb-4">üìä Monatliche Leistungs√ºbersicht</h3>
                <div id="monthlyPerformanceOverview">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Recent Completed Tasks -->
            <div class="card">
                <h3 class="font-bold mb-4">üïí Letzte 10 erledigte Tasks</h3>
                <p class="text-sm text-gray-600 mb-4">Klicke auf einen Task, um ihn zu bewerten (nur m√∂glich nach Benutzerauswahl)</p>
                <div id="recentCompletedTasks">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
            
            <div class="flex justify-center mt-4">
                <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
            </div>
        </div>

        <!-- Profile Edit Page -->
        <div id="profileEdit" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Profil bearbeiten - Name, Mitglieder und Icons √§ndern
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">‚úèÔ∏è Profil bearbeiten</h1>
                <p>WG-Name, Mitglieder und Icons anpassen</p>
            </div>

            <!-- Profile Name -->
            <div class="card">
                <h3 class="font-bold mb-4">üè† WG-Name</h3>
                <div class="form-group">
                    <label>Name der WG:</label>
                    <input type="text" id="editProfileName" class="form-control" placeholder="Meine WG">
                </div>
            </div>

            <!-- WhatsApp Kontakt -->
            <div class="card">
                <h3 class="font-bold mb-4">üì± WhatsApp-Benachrichtigungen</h3>
                <div class="form-group">
                    <label>WhatsApp-Kontakt f√ºr Alerts:</label>
                    <input type="text" id="editProfileWhatsapp" class="form-control" placeholder="z.B. 'Max Mustermann' oder 'WG Gruppe'">
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        üí° Verwenden Sie den exakten Namen wie er in WhatsApp angezeigt wird
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 12px;">
                    <div style="font-size: 14px; color: #1e40af;">
                        <div style="font-weight: bold; margin-bottom: 8px;"><i class="fas fa-info-circle"></i> So funktioniert es:</div>
                        <div>‚Ä¢ üö® Alert-Button klicken ‚Üí WhatsApp Web √∂ffnet sich automatisch</div>
                        <div>‚Ä¢ üìù Nachricht wird automatisch in den Chat eingef√ºgt</div>
                        <div>‚Ä¢ üì§ Einfach Enter dr√ºcken zum Senden</div>
                    </div>
                </div>
            </div>

            <!-- Members Management -->
            <div class="card">
                <h3 class="font-bold mb-4">üë• Mitglieder verwalten</h3>
                <div id="memberEditList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="addNewMember()">
                        <i class="fas fa-plus"></i> Mitglied hinzuf√ºgen
                    </button>
                </div>
            </div>

            <!-- Current User Selection -->
            <div class="card">
                <h3 class="font-bold mb-4">üë§ Aktueller Benutzer</h3>
                <div class="form-group">
                    <label>Wer bist du in dieser WG?</label>
                    <select id="editCurrentUser" class="form-control">
                        <!-- Wird dynamisch gef√ºllt -->
                    </select>
                </div>
            </div>
            
            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="cancelProfileEdit()">‚Üê Abbrechen</button>
                <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="saveProfileChanges()">
                        <i class="fas fa-save"></i> √Ñnderungen speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Rate Tasks Page -->
        <div id="rateTasks" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Rate Tasks - Jedes Mitglied bewertet alle Tasks
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">‚≠ê Tasks bewerten</h1>
                <p>Jedes WG-Mitglied soll alle Tasks bewerten (Minuten, Pain, Importance, H√§ufigkeit)</p>
            </div>

            <!-- Member Selection -->
            <div class="card">
                <h3 class="font-bold mb-4">üë• Wer soll bewerten?</h3>
                <p class="mb-4">W√§hle ein Mitglied aus, das die Tasks bewerten soll:</p>
                
                <div id="rateMemberGrid" class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-bold text-blue-800 mb-2">üìä Bewertungsfortschritt</h4>
                    <div id="ratingProgress">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
                <button id="calculatePointsBtn" class="btn btn-success" onclick="calculateMonthlyPointsFromRatings()" style="display: none;">
                    <i class="fas fa-calculator"></i> Monatspunkte berechnen
                </button>
            </div>
        </div>

        <!-- Individual Task Rating Page -->
        <div id="individualTaskRating" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> <span id="currentRaterName">Mitglied</span> bewertet Tasks
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2"><span id="raterNameTitle">Mitglied</span> bewertet</h1>
                <p>Bewerte jeden Task nach Aufwand, Nerv-Faktor, Wichtigkeit und H√§ufigkeit</p>
                <div id="taskProgressIndicator" class="mt-2">
                    <!-- Zeigt Fortschritt an -->
                </div>
            </div>

            <!-- Current Task Rating -->
            <div class="card" id="currentTaskRatingCard">
                <div class="task-header">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <span id="currentTaskEmoji" style="font-size: 2rem;">üßπ</span>
                        <div>
                            <h3 id="currentTaskName" class="font-bold text-xl">Task Name</h3>
                            <p id="currentTaskDescription" class="text-gray-600">Beschreibung</p>
                        </div>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">‚è±Ô∏è Wie viele Minuten dauert das? (<span id="currentMinutesValue">30</span> min)</label>
                    <input type="range" class="slider" min="1" max="180" value="30" id="currentMinutesSlider"
                           onchange="updateCurrentValue('currentMinutesValue', this.value)" />
                    <div class="slider-labels">
                        <span>1 min</span>
                        <span>3 Stunden</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">üò§ Wie nervig ist das? (<span id="currentPainValue">5</span>/10)</label>
                    <input type="range" class="slider" min="1" max="10" value="5" id="currentPainSlider"
                           onchange="updateCurrentValue('currentPainValue', this.value)" />
                    <div class="slider-labels">
                        <span>üòä Entspannt</span>
                        <span>üò§ Sehr nervig</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">‚≠ê Wie wichtig ist das? (<span id="currentImportanceValue">7</span>/10)</label>
                    <input type="range" class="slider" min="1" max="10" value="7" id="currentImportanceSlider"
                           onchange="updateCurrentValue('currentImportanceValue', this.value)" />
                    <div class="slider-labels">
                        <span>Kann warten</span>
                        <span>Sehr wichtig</span>
                    </div>
                </div>

                <div class="rating-section">
                    <label class="font-bold mb-2">üìÖ Wie oft pro Monat? (<span id="currentFrequencyValue">4</span>x)</label>
                    <input type="range" class="slider" min="1" max="30" value="4" id="currentFrequencySlider"
                           onchange="updateCurrentValue('currentFrequencyValue', this.value)" />
                    <div class="slider-labels">
                        <span>1x</span>
                        <span>T√§glich</span>
                    </div>
                </div>

                <div class="preview">
                    <h3 class="font-bold mb-2">üí∞ Berechnete Punkte:</h3>
                    <div class="flex justify-between">
                        <span>Punkte pro Task: <strong id="currentTaskPoints">38</strong></span>
                        <span>Punkte pro Monat: <strong id="currentMonthlyPoints">152</strong></span>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="cancelTaskRating()">‚Üê Zur√ºck zur Auswahl</button>
                <div class="flex gap-2">
                    <button id="prevTaskBtn" class="btn btn-secondary" onclick="previousTask()" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Vorheriger
                    </button>
                    <button id="nextTaskBtn" class="btn btn-primary" onclick="nextTask()">
                        N√§chster <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Task Table Page -->
        <div id="taskTable" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Task-Tabelle - Tasks erledigen und verfolgen
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üìã Task-Tabelle</h1>
                <p>Klicke auf einen Task-Namen um ihn zu erledigen</p>
            </div>

            <!-- üö® Alarm Button -->
            <div class="card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-left: 4px solid #ef4444;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: #ef4444; padding: 8px; border-radius: 50%; animation: pulse-red 2s infinite;">
                            <i class="fas fa-exclamation-triangle" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div>
                            <div class="font-bold" style="color: #dc2626;">üö® Dringender Task-Alarm</div>
                            <div style="color: #991b1b; font-size: 14px;">Task als sehr dringend markieren</div>
                        </div>
                    </div>
                    <button onclick="showUrgentTaskModal()" class="btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; animation: glow-red 2s ease-in-out infinite alternate;">
                        <i class="fas fa-bell"></i> ALARM AUSL√ñSEN
                    </button>
                </div>
            </div>

            <div class="card">
                <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <table id="taskTableGrid" style="width: 100%; border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <!-- Wird dynamisch gef√ºllt -->
                    </table>
                </div>
                
                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
                    <div class="flex gap-2">
                        <button class="btn btn-debug" onclick="addRandomTaskExecution()">üêõ Random Task hinzuf√ºgen</button>
                        <button class="btn btn-primary" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absence Manager Page -->
        <div id="absenceManager" class="phase hidden">
            <div class="debug-info">
                <strong>üèñÔ∏è ABWESENHEIT:</strong> Urlaub, Gesch√§ftsreisen oder Familien-Angelegenheiten verwalten
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üèñÔ∏è Abwesenheit melden</h1>
                <p>Trage deine Abwesenheitszeiten ein f√ºr faire Punkteverteilung</p>
            </div>

            <!-- User Selection -->
            <div class="card" id="absenceUserSelection">
                <h3 class="font-bold mb-3">üë§ Wer war/ist abwesend?</h3>
                <div class="avatar-grid" id="absenceUserGrid">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Date Selection with Calendar -->
            <div class="card hidden" id="absenceDateSelection">
                <h3 class="font-bold mb-3">üìÖ Abwesenheitszeitraum</h3>
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Grund der Abwesenheit</label>
                    <select id="absenceReason" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                        <option value="vacation">üèñÔ∏è Urlaub</option>
                        <option value="work">üíº Gesch√§ftsreise</option>
                        <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie/Besuch</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Von Datum</label>
                        <input type="date" id="absenceStartDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Bis Datum</label>
                        <input type="date" id="absenceEndDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
                    </div>
                </div>

                <div id="absenceSummary" class="hidden" style="background: #f0f9ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 16px;">
                    <h4 style="font-weight: 600; margin-bottom: 8px;">üìä Auswirkung auf Zielpunkte</h4>
                    <div id="absenceImpact"></div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="cancelAbsenceEntry()">Abbrechen</button>
                    <button class="btn btn-primary" onclick="saveAbsence()">Abwesenheit speichern</button>
                </div>
            </div>

            <!-- Absence Overview -->
            <div class="card">
                <h3 class="font-bold mb-3">üìã Aktuelle Abwesenheiten</h3>
                <div id="absenceList">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>

            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
                <div class="flex gap-2">
                    <button class="btn btn-debug" onclick="cleanupDuplicateAbsences()">üßπ Duplikate bereinigen</button>
                    <button class="btn btn-debug" onclick="addDemoAbsences()">üêõ Demo-Abwesenheiten</button>
                </div>
            </div>
        </div>

        <!-- Period Settings Page -->
        <div id="periodSettings" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ DEBUG:</strong> Zeitraum-Einstellungen - Start- und Enddatum f√ºr den Putzplan definieren
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üìÖ Zeitraum-Einstellungen</h1>
                <p>Definiere den Start- und Endtermin f√ºr deinen Putzplan-Zeitraum</p>
            </div>

            <!-- Current Period Info -->
            <div class="card">
                <h3 class="font-bold mb-4">üìä Aktueller Zeitraum</h3>
                <div style="display: flex; gap: 8px; align-items: center; background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                    <div class="text-sm">
                        <div><strong>Zeitraum:</strong> <span id="currentPeriodDisplay">1. M√§rz - 31. M√§rz (31 Tage)</span></div>
                        <div><strong>Tagesdurchschnitt:</strong> <span id="dailyAverageDisplay">3.2 Punkte</span></div>
                    </div>
                </div>
            </div>

            <!-- Period Configuration -->
            <div class="card">
                <h3 class="font-bold mb-4">‚öôÔ∏è Zeitraum konfigurieren</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="periodStartDate">Startdatum:</label>
                        <input type="date" id="periodStartDate" class="form-control">
                        <div class="text-sm text-gray-600" style="margin-top: 4px;">
                            Beginn des Putzplan-Zeitraums
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="periodEndDate">Enddatum:</label>
                        <input type="date" id="periodEndDate" class="form-control">
                        <div class="text-sm text-gray-600" style="margin-top: 4px;">
                            Ende des Putzplan-Zeitraums
                        </div>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="text-sm font-medium" style="display: block; margin-bottom: 8px;">Schnellauswahl:</label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <button class="btn btn-secondary" onclick="setPeriodPreset('thisMonth')" style="font-size: 12px; padding: 8px;">üìÖ Dieser Monat</button>
                        <button class="btn btn-secondary" onclick="setPeriodPreset('nextMonth')" style="font-size: 12px; padding: 8px;">üìÜ N√§chster Monat</button>
                        <button class="btn btn-secondary" onclick="setPeriodPreset('4weeks')" style="font-size: 12px; padding: 8px;">üóìÔ∏è 1 Monat ab heute</button>
                        <button class="btn btn-secondary" onclick="setPeriodPreset('2weeks')" style="font-size: 12px; padding: 8px;">üìã 2 Wochen</button>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="resetPeriodDates()">Zur√ºcksetzen</button>
                    <button class="btn btn-primary" onclick="savePeriodDates()">Zeitraum speichern</button>
                </div>
            </div>

            <div class="flex justify-between mt-4">
                <button class="btn btn-secondary" onclick="showDashboard()">‚Üê Zur√ºck zum Dashboard</button>
                <button class="btn btn-primary" onclick="showMasterOverview()">üéõÔ∏è Master-√úbersicht</button>
            </div>
        </div>

        <!-- Master Overview Page -->
        <div id="masterOverview" class="phase hidden">
            <div class="debug-info">
                <strong>üêõ MASTER:</strong> Vollzugriff auf alle Bereiche des Workflows
            </div>
            
            <div class="card gradient-bg">
                <h1 class="font-bold text-2xl mb-2">üéõÔ∏è Master-√úbersicht</h1>
                <p>Vollst√§ndige Navigation durch den gesamten Workflow</p>
            </div>

            <!-- Setup Bereich -->
            <div class="card">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-cogs"></i>
                    Setup & Konfiguration
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="showPhase('phase0')" style="padding: 12px;">
                        <div class="text-left">
                            <div class="font-bold">üìù WG Setup</div>
                            <div class="text-sm opacity-80">Namen & Mitglieder</div>
                        </div>
                    </button>
                    <button class="btn btn-secondary" onclick="showPhase('phase1b')" style="padding: 12px;">
                        <div class="text-left">
                            <div class="font-bold">üë§ Profile</div>
                            <div class="text-sm opacity-80">Avatars & E-Mails</div>
                        </div>
                    </button>
                    <button class="btn btn-secondary" onclick="showPhase('phase2')" style="padding: 12px;">
                        <div class="text-left">
                            <div class="font-bold">üìã Tasks</div>
                            <div class="text-sm opacity-80">Task-Erstellung</div>
                        </div>
                    </button>
                    <button class="btn btn-secondary" onclick="showPhase('phase2_5')" style="padding: 12px;">
                        <div class="text-left">
                            <div class="font-bold">üë• Bewertungen</div>
                            <div class="text-sm opacity-80">User-√úbersicht</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Hauptbereiche -->
            <div class="card">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-home"></i>
                    Hauptbereiche
                </h3>
                <div style="display: grid; gap: 12px;">
                    <button class="btn btn-primary" onclick="showDashboard()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-tachometer-alt" style="width: 20px;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">üè† Dashboard</div>
                                <div class="text-sm opacity-80">Haupt√ºbersicht mit Statistiken</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-primary" onclick="showTaskTable()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-table" style="width: 20px;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">üìä Task-Tabelle</div>
                                <div class="text-sm opacity-80">Tasks erledigen & verfolgen</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button class="btn btn-primary" onclick="showTaskManagement()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-edit" style="width: 20px;"></i>
                            <div style="text-align: left;">
                                <div class="font-bold">‚öôÔ∏è Task-Verwaltung</div>
                                <div class="text-sm opacity-80">Tasks bearbeiten & Checklisten</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Status & Debug -->
            <div class="card">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    Status & Debug
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="card bg-blue-50" style="padding: 12px;">
                        <div class="text-sm font-bold">WG</div>
                        <div id="masterWgName" class="text-lg">-</div>
                    </div>
                    <div class="card bg-green-50" style="padding: 12px;">
                        <div class="text-sm font-bold">Mitglieder</div>
                        <div id="masterMemberCount" class="text-lg">-</div>
                    </div>
                    <div class="card bg-yellow-50" style="padding: 12px;">
                        <div class="text-sm font-bold">Tasks</div>
                        <div id="masterTaskCount" class="text-lg">-</div>
                    </div>
                    <div class="card bg-purple-50" style="padding: 12px;">
                        <div class="text-sm font-bold">Bewertungen</div>
                        <div id="masterRatingsCount" class="text-lg">-</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-debug" onclick="location.reload()">üîÑ Komplett neu starten</button>
                    <button class="btn btn-debug" onclick="debugFillAllData()">üêõ Alle Daten f√ºllen</button>
                </div>
            </div>
            
            <div class="flex justify-center mt-4">
                <button class="btn btn-secondary" onclick="goBack()">‚Üê Zur√ºck</button>
            </div>
        </div>
    </div>

    <!-- Task Execution Modal -->
    <div id="taskExecutionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">Task erledigen</h2>
            </div>
            <div class="modal-body">
                <div id="taskInfoSection" class="task-info">
                    <div class="task-title">
                        <span id="modalTaskEmoji">üßπ</span>
                        <span id="modalTaskName">K√ºche putzen</span>
                    </div>
                    <p id="modalTaskDescription" style="margin: 0; opacity: 0.9;">Sp√ºlmaschine ausr√§umen, Oberfl√§chen wischen</p>
                </div>

                <div id="userSelectionSection">
                    <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: 600;">Wer erledigt diesen Task?</h3>
                    <p style="margin: 0 0 16px; color: #6b7280; font-size: 14px;">W√§hle dein Profil aus:</p>
                    <div id="modalUserGrid" class="user-selection-grid">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <div id="checklistSection" style="display: none;">
                    <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600;">üìã Checklist abarbeiten</h3>
                    <div id="modalChecklist">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modalCancelBtn" class="btn btn-secondary">Abbrechen</button>
                <button id="modalExecuteBtn" class="btn btn-primary" disabled>Task erledigt! ‚úì</button>
            </div>
        </div>
    </div>

    <script>
        let wgName = 'WG Darius & Co';
        let memberNames = ['Darius', 'Lilly', 'Hendrik I', 'Hendrik II', 'Hamza Hamza', 'Sofia'];
        let currentMemberIndex = 0;
        let memberProfiles = [];
        let selectedAvatar = 'üòä';
        let tasks = [];
        let currentTaskIndex = 0;
        let currentRatingMemberIndex = 0;
        let allRatings = {};

        // Debug-Daten f√ºr schnelle Navigation
        const debugProfiles = [
            { name: 'Darius', avatar: 'ÔøΩ', email: 'darius@wg-darius.de' },
            { name: 'Lilly', avatar: 'üå∏', email: 'lilly@wg-darius.de' },
            { name: 'Hendrik I', avatar: 'ü§ì', email: 'hendrik1@wg-darius.de' },
            { name: 'Hendrik II', avatar: 'ÔøΩ', email: 'hendrik2@wg-darius.de' },
            { name: 'Hamza Hamza', avatar: 'üöÄ', email: 'hamza@wg-darius.de' },
            { name: 'Sofia', avatar: '‚ú®', email: 'sofia@wg-darius.de' }
        ];

        const debugTasks = [
            { 
                title: 'Hallway', 
                description: 'Flur und Eingangsbereich reinigen', 
                emoji: 'üè†', 
                minDaysBetween: 7,
                checklist: [
                    'Boden fegen und wischen',
                    'Schuhe ordnen',
                    'Garderobe aufr√§umen',
                    'Spiegel putzen',
                    'Pflanzen gie√üen falls vorhanden'
                ]
            },
            { 
                title: 'Big bathroom + shower', 
                description: 'Gro√ües Bad und Dusche gr√ºndlich reinigen', 
                emoji: 'üõÅ', 
                minDaysBetween: 7,
                checklist: [
                    'Dusche entkalken und schrubben',
                    'Toilette innen und au√üen reinigen',
                    'Waschbecken und Armaturen putzen',
                    'Spiegel und Fliesen wischen',
                    'Boden wischen und Handt√ºcher wechseln'
                ]
            },
            { 
                title: 'Small bath + livingroom', 
                description: 'Kleines Bad und Wohnzimmer s√§ubern', 
                emoji: 'üõãÔ∏è', 
                minDaysBetween: 7,
                checklist: [
                    'G√§ste-WC reinigen',
                    'Wohnzimmer staubsaugen',
                    'Oberfl√§chen abstauben',
                    'Kissen aufsch√ºtteln',
                    'Ordnung schaffen'
                ]
            },
            { 
                title: 'Kitchen', 
                description: 'K√ºche komplett reinigen', 
                emoji: 'üç≥', 
                minDaysBetween: 3,
                checklist: [
                    'Sp√ºlmaschine ausr√§umen',
                    'Arbeitsfl√§chen desinfizieren',
                    'Herd und Backofen s√§ubern',
                    'Sp√ºle und Wasserhahn putzen',
                    'Boden wischen'
                ]
            },
            { 
                title: 'Plastic trash tuesday', 
                description: 'Plastikm√ºll am Dienstag rausbringen', 
                emoji: '‚ôªÔ∏è', 
                minDaysBetween: 7,
                checklist: [
                    'Alle Plastikm√ºlleimer leeren',
                    'Gelben Sack bereitstellen',
                    'Zur Stra√üe bringen (Dienstag morgens)',
                    'Neue M√ºllbeutel einsetzen',
                    'M√ºlltonne zur√ºckstellen'
                ]
            },
            { 
                title: 'Wg clothes clean + hang', 
                description: 'WG-W√§sche waschen und aufh√§ngen', 
                emoji: 'ÔøΩ', 
                minDaysBetween: 14,
                checklist: [
                    'Handt√ºcher und Bettw√§sche sammeln',
                    'Waschmaschine starten',
                    'W√§sche aufh√§ngen',
                    'Getrocknete W√§sche abh√§ngen',
                    'W√§schek√∂rbe zur√ºck an Pl√§tze'
                ]
            },
            { 
                title: 'Vg clothes put away', 
                description: 'WG-W√§sche zusammenlegen und wegr√§umen', 
                emoji: 'üëî', 
                minDaysBetween: 14,
                checklist: [
                    'Trockene W√§sche abnehmen',
                    'Handt√ºcher zusammenlegen',
                    'Bettw√§sche sortieren',
                    'Alles an richtige Pl√§tze r√§umen',
                    'W√§schek√∂rbe aufr√§umen'
                ]
            },
            { 
                title: 'Wg shopping', 
                description: 'Gemeinsame WG-Eink√§ufe erledigen', 
                emoji: 'üõí', 
                minDaysBetween: 7,
                checklist: [
                    'Einkaufsliste erstellen',
                    'Putzmittel und Toilettenpapier kaufen',
                    'K√ºchenverbrauchsgegenst√§nde besorgen',
                    'Gl√ºhbirnen und Batterien checken',
                    'Bon sammeln f√ºr Abrechnung'
                ]
            },
            { 
                title: 'Unclogging shower', 
                description: 'Duschablauf von Verstopfungen befreien', 
                emoji: 'üöø', 
                minDaysBetween: 30,
                checklist: [
                    'Duschsieb entfernen',
                    'Haare und Schmutz entfernen',
                    'Abfluss mit Rohrreiniger behandeln',
                    'Mit hei√üem Wasser sp√ºlen',
                    'Sieb wieder einsetzen'
                ]
            },
            { 
                title: 'Biotrash + clean', 
                description: 'Biom√ºll entsorgen und Beh√§lter reinigen', 
                emoji: 'üóëÔ∏è', 
                minDaysBetween: 7,
                checklist: [
                    'Biom√ºll-Eimer leeren',
                    'Eimer gr√ºndlich auswaschen',
                    'Neue T√ºte einlegen',
                    'Biom√ºll zur Tonne bringen',
                    'Tonne zur√ºckstellen nach Abholung'
                ]
            },
            { 
                title: 'Restm√ºll + clean', 
                description: 'Restm√ºll entsorgen und s√§ubern', 
                emoji: 'üóëÔ∏è', 
                minDaysBetween: 14,
                checklist: [
                    'Alle Restm√ºlleimer leeren',
                    'M√ºlleimer auswischen',
                    'Neue M√ºllbeutel einsetzen',
                    'Zur Stra√üe bringen',
                    'Tonne nach Abholung zur√ºckholen'
                ]
            },
            { 
                title: 'Plastic', 
                description: 'Plastikm√ºll sortieren und entsorgen', 
                emoji: '‚ôªÔ∏è', 
                minDaysBetween: 14,
                checklist: [
                    'Plastikverpackungen sammeln',
                    'Sauber aussp√ºlen',
                    'In gelben Sack sortieren',
                    'Zur Abholung bereitstellen',
                    'Neue Sammelbeh√§lter aufstellen'
                ]
            },
            { 
                title: 'Paper', 
                description: 'Altpapier sammeln und entsorgen', 
                emoji: 'üìÑ', 
                minDaysBetween: 21,
                checklist: [
                    'Altpapier aus allen R√§umen sammeln',
                    'Kartons zerkleinern',
                    'In Papiertonne sortieren',
                    'Zur Abholung bereitstellen',
                    'Papierk√∂rbe leeren'
                ]
            },
            { 
                title: 'Pfand', 
                description: 'Pfandflaschen sammeln und zur√ºckbringen', 
                emoji: 'üçæ', 
                minDaysBetween: 14,
                checklist: [
                    'Leere Flaschen aus K√ºche sammeln',
                    'Pfandkisten bef√ºllen',
                    'Zum Supermarkt bringen',
                    'Pfandbon einl√∂sen',
                    'Geld in WG-Kasse'
                ]
            },
            { 
                title: 'dishwasher', 
                description: 'Sp√ºlmaschine bedienen und warten', 
                emoji: 'ÔøΩÔ∏è', 
                minDaysBetween: 2,
                checklist: [
                    'Sp√ºlmaschine ausr√§umen',
                    'Neu beladen',
                    'Tabs und Klarsp√ºler pr√ºfen',
                    'Programm starten',
                    'Filter regelm√§√üig reinigen'
                ]
            },
            { 
                title: 'Attik clean', 
                description: 'Dachboden/Speicher aufr√§umen', 
                emoji: 'üè†', 
                minDaysBetween: 90,
                checklist: [
                    'Staub wischen und fegen',
                    'Kartons sortieren',
                    'Ungenutztes aussortieren',
                    'Ordnung schaffen',
                    'Sch√§dlinge kontrollieren'
                ]
            },
            { 
                title: 'Fridge', 
                description: 'K√ºhlschrank reinigen und sortieren', 
                emoji: '‚ùÑÔ∏è', 
                minDaysBetween: 30,
                checklist: [
                    'Abgelaufene Produkte entfernen',
                    'F√§cher herausnehmen und waschen',
                    'Innenraum desinfizieren',
                    'Gem√ºsefach s√§ubern',
                    'Wieder ordentlich einr√§umen'
                ]
            },
            { 
                title: 'Sp√ºlrack', 
                description: 'Abtropfgestell reinigen und ordnen', 
                emoji: 'üßΩ', 
                minDaysBetween: 7,
                checklist: [
                    'Abtropfgestell komplett leeren',
                    'Mit Sp√ºlmittel reinigen',
                    'Wasserf√§cher s√§ubern',
                    'Geschirr richtig einsortieren',
                    'Umgebung trocken wischen'
                ]
            }
        ];

        // Debug-Bewertungen (verschiedene Profile haben verschiedene Pr√§ferenzen)
        const debugRatings = {
            'Anna': {
                'K√ºche putzen': { minutes: 25, pain: 3, importance: 9, frequency: 6 },
                'Bad putzen': { minutes: 35, pain: 7, importance: 8, frequency: 4 },
                'M√ºll rausbringen': { minutes: 10, pain: 2, importance: 7, frequency: 8 },
                'Staubsaugen': { minutes: 20, pain: 4, importance: 6, frequency: 2 },
                'Pflanzen gie√üen': { minutes: 15, pain: 1, importance: 5, frequency: 12 }
            },
            'Ben': {
                'K√ºche putzen': { minutes: 30, pain: 4, importance: 8, frequency: 6 },
                'Bad putzen': { minutes: 40, pain: 8, importance: 9, frequency: 3 },
                'M√ºll rausbringen': { minutes: 8, pain: 1, importance: 6, frequency: 10 },
                'Staubsaugen': { minutes: 25, pain: 3, importance: 7, frequency: 2 },
                'Pflanzen gie√üen': { minutes: 12, pain: 2, importance: 4, frequency: 15 }
            },
            'Clara': {
                'K√ºche putzen': { minutes: 35, pain: 5, importance: 9, frequency: 5 },
                'Bad putzen': { minutes: 30, pain: 6, importance: 8, frequency: 4 },
                'M√ºll rausbringen': { minutes: 12, pain: 3, importance: 8, frequency: 7 },
                'Staubsaugen': { minutes: 18, pain: 2, importance: 8, frequency: 3 },
                'Pflanzen gie√üen': { minutes: 20, pain: 1, importance: 6, frequency: 10 }
            }
        };

        function selectAvatar(element, avatar) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = avatar;
        }

        function selectAvatarIcon(element, iconClass) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = `<i class="${iconClass}" style="font-size: 18px;"></i>`;
        }

        function toggleIconSelector(button) {
            const taskItem = button.closest('.task-item');
            const selector = taskItem.querySelector('.extended-icon-selector');
            
            if (selector.style.display === 'none' || !selector.style.display) {
                selector.style.display = 'block';
                button.innerHTML = 'üîº Weniger Icons';
            } else {
                selector.style.display = 'none';
                button.innerHTML = 'üìã Mehr Icons';
            }
        }

        function setupRealWG() {
            console.log('üè† setupRealWG() - Darius WG Setup gestartet!');
            try {
                if (!confirm('üè† Darius WG Setup starten?\n\nDas richtet eure echte WG ein:\n‚Ä¢ Darius, Lilly, Hendrik I, Hendrik II, Hamza Hamza, Sofia\n‚Ä¢ Alle echten Tasks aus eurem Plan\n‚Ä¢ Realistische Profile und Ratings\n\nDanach gehts direkt zum Dashboard!')) {
                    return;
                }

                showSuccessToast('üè† Darius WG wird eingerichtet...');

                // Echte WG-Daten setzen
                wgName = 'WG Darius & Co';
                memberNames = ['Darius', 'Lilly', 'Hendrik I', 'Hendrik II', 'Hamza Hamza', 'Sofia'];
                
                // Echte Profile erstellen
                memberProfiles = [
                    { name: 'Darius', avatar: 'üòé', email: 'darius@wg-darius.de' },
                    { name: 'Lilly', avatar: 'üå∏', email: 'lilly@wg-darius.de' },
                    { name: 'Hendrik I', avatar: 'ü§ì', email: 'hendrik1@wg-darius.de' },
                    { name: 'Hendrik II', avatar: 'üòä', email: 'hendrik2@wg-darius.de' },
                    { name: 'Hamza Hamza', avatar: 'üöÄ', email: 'hamza@wg-darius.de' },
                    { name: 'Sofia', avatar: '‚ú®', email: 'sofia@wg-darius.de' }
                ];

                // Echte Tasks setzen (aus debugTasks √ºbernehmen)
                tasks = debugTasks.map(task => ({...task}));

                // Realistische und personalisierte Ratings f√ºr alle Mitglieder und Tasks
                ratings = {};
                allRatings = {};
                memberTaskRatings = {};
                
                // Definiere Pers√∂nlichkeitsprofile f√ºr realistische Bewertungen
                const personalityProfiles = {
                    'Darius': { efficiency: 0.8, cleanliness: 0.7, patience: 0.6, strength: 0.8 }, // Technik-orientiert, effizient
                    'Lilly': { efficiency: 0.9, cleanliness: 0.9, patience: 0.8, strength: 0.6 },  // Perfektionistin, organisiert
                    'Hendrik I': { efficiency: 0.6, cleanliness: 0.6, patience: 0.9, strength: 0.7 }, // Entspannt, gr√ºndlich
                    'Hendrik II': { efficiency: 0.7, cleanliness: 0.5, patience: 0.7, strength: 0.8 }, // Pragmatisch
                    'Hamza Hamza': { efficiency: 0.8, cleanliness: 0.8, patience: 0.5, strength: 0.9 }, // Schnell, kraftvoll
                    'Sofia': { efficiency: 0.7, cleanliness: 0.8, patience: 0.8, strength: 0.5 }   // Sorgf√§ltig, methodisch
                };
                
                memberProfiles.forEach(member => {
                    ratings[member.name] = {};
                    allRatings[member.name] = {};
                    memberTaskRatings[member.name] = {};
                    
                    const profile = personalityProfiles[member.name] || { efficiency: 0.7, cleanliness: 0.7, patience: 0.7, strength: 0.7 };
                    
                    tasks.forEach(task => {
                        let minutes, pain, importance, frequency;
                        
                        // Task-spezifische Bewertungen basierend auf Pers√∂nlichkeit
                        if (task.title.toLowerCase().includes('trash') || task.title.toLowerCase().includes('m√ºll')) {
                            // M√ºll rausbringen - schnell aber oft
                            minutes = Math.round(8 - (profile.efficiency * 3)); // 5-8 min
                            pain = Math.round(1 + (1 - profile.patience) * 2);  // 1-3 pain
                            importance = 4; // wichtig f√ºr Hygiene
                            frequency = 1;
                        } else if (task.title.toLowerCase().includes('bathroom') || task.title.toLowerCase().includes('bad') || task.title.toLowerCase().includes('toilet')) {
                            // Badezimmer - aufwendig, eklig f√ºr manche
                            minutes = Math.round(25 + (profile.cleanliness * 15)); // 25-40 min
                            pain = Math.round(4 + (1 - profile.cleanliness) * 2);  // 4-6 pain  
                            importance = Math.round(4 + profile.cleanliness);      // 4-5 importance
                            frequency = 2;
                        } else if (task.title.toLowerCase().includes('kitchen') || task.title.toLowerCase().includes('k√ºche') || task.title.toLowerCase().includes('dishwasher') || task.title.toLowerCase().includes('sp√ºl')) {
                            // K√ºche - t√§glich wichtig
                            minutes = Math.round(20 + (profile.cleanliness * 10)); // 20-30 min
                            pain = Math.round(2 + (1 - profile.efficiency) * 2);   // 2-4 pain
                            importance = 5; // sehr wichtig - t√§glich genutzt
                            frequency = 1;
                        } else if (task.title.toLowerCase().includes('vacuum') || task.title.toLowerCase().includes('saugen') || task.title.toLowerCase().includes('floor') || task.title.toLowerCase().includes('boden')) {
                            // Staubsaugen - k√∂rperlich anstrengend
                            minutes = Math.round(15 + (1 - profile.efficiency) * 20); // 15-35 min
                            pain = Math.round(3 + (1 - profile.strength) * 3);        // 3-6 pain
                            importance = Math.round(3 + profile.cleanliness * 2);     // 3-5 importance
                            frequency = 2;
                        } else if (task.title.toLowerCase().includes('dust') || task.title.toLowerCase().includes('staub') || task.title.toLowerCase().includes('wipe') || task.title.toLowerCase().includes('wisch')) {
                            // Staubwischen - Detailarbeit
                            minutes = Math.round(12 + profile.cleanliness * 18); // 12-30 min
                            pain = Math.round(2 + (1 - profile.patience) * 2);   // 2-4 pain
                            importance = Math.round(3 + profile.cleanliness);    // 3-4 importance
                            frequency = 2;
                        } else if (task.title.toLowerCase().includes('window') || task.title.toLowerCase().includes('fenster')) {
                            // Fenster putzen - zeitaufwendig, anstrengend
                            minutes = Math.round(30 + (1 - profile.efficiency) * 25); // 30-55 min
                            pain = Math.round(4 + (1 - profile.strength) * 2);        // 4-6 pain
                            importance = Math.round(2 + profile.cleanliness);         // 2-3 importance
                            frequency = 4; // seltener
                        } else {
                            // Generische Tasks
                            minutes = Math.round(15 + Math.random() * 25); // 15-40 min
                            pain = Math.round(2 + Math.random() * 3);      // 2-5 pain
                            importance = Math.round(3 + Math.random() * 2); // 3-5 importance
                            frequency = Math.round(2 + Math.random() * 2); // 2-4
                        }
                        
                        // Kleine zuf√§llige Variationen f√ºr Realismus
                        minutes += Math.round((Math.random() - 0.5) * 4);
                        pain = Math.max(1, Math.min(10, pain + Math.round((Math.random() - 0.5) * 2)));
                        importance = Math.max(1, Math.min(10, importance + Math.round((Math.random() - 0.5) * 1)));
                        
                        const rating = {
                            minutes: Math.max(1, minutes),
                            pain: Math.max(1, Math.min(10, pain)),
                            importance: Math.max(1, Math.min(10, importance)),
                            frequency: Math.max(1, Math.min(5, frequency)),
                            points: Math.round((minutes + (minutes * pain / 10)) * importance)
                        };
                        
                        ratings[member.name][task.title] = rating;
                        allRatings[member.name][task.title] = rating;
                        memberTaskRatings[member.name][task.title] = rating;
                    });
                });

                // Task executions initialisieren
                taskExecutions = {};
                memberProfiles.forEach(member => {
                    taskExecutions[member.name] = {};
                    tasks.forEach(task => {
                        taskExecutions[member.name][task.title] = [];
                    });
                });

                // Speichern
                saveCurrentState();
                
                showSuccessToast('‚úÖ Darius WG erfolgreich eingerichtet! Zum Dashboard...');
                
                // Direkt zum Dashboard
                setTimeout(() => {
                    showDashboard();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Fehler in setupRealWG:', error);
                alert('‚ùå Fehler beim WG-Setup: ' + error.message);
            }
        }

        function completeAutoSetup() {
            console.log('üî• completeAutoSetup() aufgerufen!');
            try {
                if (!confirm('‚ö° Komplett-Auto-Setup starten?\n\nDas f√ºllt automatisch ALLES aus:\n‚Ä¢ WG-Name & Mitglieder\n‚Ä¢ Alle Profile mit zuf√§lligen Avatars\n‚Ä¢ Alle Task-Ratings\n‚Ä¢ Tasks mit Icons\n\nDanach gehts direkt zum Dashboard!')) {
                    return;
                }

                showSuccessToast('‚ö° Auto-Setup gestartet...');

            // Phase 0: WG-Setup 
            wgName = document.getElementById('wgName').value || 'Auto-WG';
            
            // Sammle alle Member-Namen
            memberNames = [];
            const memberInputs = document.querySelectorAll('.member-name');
            memberInputs.forEach(input => {
                if (input.value.trim()) {
                    memberNames.push(input.value.trim());
                }
            });
            
            if (memberNames.length === 0) {
                memberNames = ['Anna', 'Ben', 'Clara'];
            }

            // Auto-Profile erstellen
            memberProfiles = memberNames.map((name, index) => {
                const avatars = ['üòä', 'üòé', 'ü§ì', 'ü•≥', 'üòá', 'ü§î', 'üòã', 'üôÉ', 'ü§™', 'üòå'];
                const icons = ['fas fa-user-circle', 'fas fa-star', 'fas fa-crown', 'fas fa-heart', 'fas fa-bolt'];
                const useIcon = Math.random() > 0.5;
                
                return {
                    name: name,
                    email: `${name.toLowerCase()}@auto-wg.de`,
                    avatar: useIcon ? 
                        `<i class="${icons[index % icons.length]}" style="font-size: 18px; color: #3b82f6;"></i>` : 
                        avatars[index % avatars.length]
                };
            });

            // Sicherstellen dass Tasks existieren
            if (!tasks || tasks.length === 0) {
                tasks = [
                    {title: 'K√ºche putzen', emoji: 'üßπ', description: 'Sp√ºlmaschine ausr√§umen, Oberfl√§chen wischen'},
                    {title: 'Bad putzen', emoji: 'üõÅ', description: 'Toilette, Dusche, Waschbecken reinigen'},
                    {title: 'M√ºll rausbringen', emoji: 'üóëÔ∏è', description: 'Alle M√ºlleimer leeren und neue Beutel einsetzen'},
                    {title: 'Staubsaugen', emoji: 'üßπ', description: 'Alle R√§ume durchsaugen'},
                    {title: 'Pflanzen gie√üen', emoji: 'üå±', description: 'Alle Zimmerpflanzen bew√§ssern'}
                ];
            }

            // Auto-Ratings f√ºr alle Mitglieder und Tasks
            ratings = {};
            allRatings = {};
            memberProfiles.forEach(member => {
                ratings[member.name] = {};
                allRatings[member.name] = {};
                
                tasks.forEach(task => {
                    const rating = {
                        minutes: Math.floor(Math.random() * 50) + 10,
                        pain: Math.floor(Math.random() * 5) + 1,
                        importance: Math.floor(Math.random() * 5) + 1,
                        frequency: Math.floor(Math.random() * 4) + 1
                    };
                    
                    rating.points = Math.round((rating.minutes + (rating.minutes * rating.pain / 10)) * rating.importance);
                    
                    ratings[member.name][task.title] = rating;
                    allRatings[member.name][task.title] = rating;
                });
            });

            // Speichern
            saveCurrentState();
            
            showSuccessToast('‚úÖ Komplett-Setup abgeschlossen! Zum Dashboard...');
            
            // Direkt zum Dashboard
            setTimeout(() => {
                showDashboard();
            }, 2000);
            } catch (error) {
                console.error('‚ùå Fehler in completeAutoSetup:', error);
                alert('‚ùå Fehler beim Auto-Setup: ' + error.message);
            }
        }

        function selectEmoji(element, emoji) {
            const taskItem = element.closest('.task-item');
            taskItem.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            taskItem.dataset.emoji = emoji;
        }

        function selectIcon(element, iconClass, fallbackEmoji) {
            const taskItem = element.closest('.task-item');
            taskItem.querySelectorAll('.emoji-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            // Store both icon and fallback emoji
            taskItem.dataset.icon = iconClass;
            taskItem.dataset.emoji = fallbackEmoji;
        }

        function updateMemberCount() {
            const count = parseInt(document.getElementById('memberCount').value);
            const container = document.getElementById('memberNames');
            
            container.innerHTML = '<h3 class="font-bold mb-4">Namen der WG-Mitglieder:</h3>';
            
            for (let i = 1; i <= count; i++) {
                const name = debugProfiles[i-1]?.name || ['Diana', 'Emil', 'Fiona'][i-4] || `Person${i}`;
                container.innerHTML += `
                    <div class="form-group">
                        <label>Person ${i}</label>
                        <input type="text" class="member-name" value="${name}" />
                    </div>
                `;
            }
            
            // Update memberNames array
            memberNames = [];
            for (let i = 0; i < count; i++) {
                memberNames.push(debugProfiles[i]?.name || `Person${i+1}`);
            }
        }

        function debugFillAndSkip(targetPhase) {
            if (targetPhase === 1) {
                // Skip WG setup
                wgName = 'Villa Kunterbunt';
                memberNames = ['Anna', 'Ben', 'Clara'];
                document.getElementById('wgNameDisplay').textContent = wgName;
                nextPhase(1);
            } else if (targetPhase === 2) {
                // Skip all profiles - fill with debug data and jump to tasks
                memberProfiles = [...debugProfiles];
                memberNames = debugProfiles.map(p => p.name);
                
                // Save profiles to localStorage
                localStorage.setItem('wgMembers', JSON.stringify(memberProfiles));
                localStorage.setItem('wgName', wgName || 'Villa Kunterbunt');
                
                // Update WG display if needed
                const wgDisplay = document.getElementById('wgNameDisplay');
                if (wgDisplay && !wgName) {
                    wgName = 'Villa Kunterbunt';
                    wgDisplay.textContent = wgName;
                }
                
                showSuccessToast('üêõ Alle Profile √ºbersprungen - direkt zu Tasks!');
                
                // Hide current phase and show phase 2 (tasks)
                document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
                document.getElementById('phase2').classList.remove('hidden');
            } else if (targetPhase === 3) {
                // Skip task creation
                tasks = [...debugTasks];
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('totalMembers').textContent = memberProfiles.length;
                document.getElementById('ratingMemberName').textContent = memberProfiles[0].name;
                document.getElementById('currentRatingMember').textContent = 1;
                
                currentRatingMemberIndex = 0;
                currentTaskIndex = 0;
                allRatings = {};
                
                loadTask(0);
                nextPhase(3);
            }
        }

        function debugFillAllData() {
            // Fill WG data
            wgName = 'Villa Kunterbunt';
            memberNames = ['Anna', 'Ben', 'Clara'];
            
            // Fill member profiles
            memberProfiles = [...debugProfiles];
            
            // Fill tasks with checklists
            tasks = [...debugTasks];
            
            // Fill ratings
            allRatings = { ...debugRatings };
            
            // Save to localStorage
            localStorage.setItem('wgName', wgName);
            localStorage.setItem('wgMembers', JSON.stringify(memberNames.map((name, i) => ({
                name: name,
                avatar: debugProfiles[i]?.avatar || 'üòä',
                email: debugProfiles[i]?.email || `${name.toLowerCase()}@example.com`
            }))));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // Save ratings to localStorage
            memberProfiles.forEach(member => {
                tasks.forEach(task => {
                    const key = `rating_${member.name}_${task.title}`;
                    const rating = debugRatings[member.name]?.[task.title];
                    if (rating) {
                        localStorage.setItem(key, JSON.stringify(rating));
                    }
                });
            });
            
            // Initialize task executions
            taskExecutions = {};
            memberProfiles.forEach(member => {
                taskExecutions[member.name] = {};
                tasks.forEach(task => {
                    taskExecutions[member.name][task.title] = [];
                });
            });
            
            showSuccessToast('üêõ Debug-Daten vollst√§ndig geladen! Alle Tasks haben jetzt Checklisten.');
            showDashboard();
        }

        function debugAutoRate() {
            console.log('üî• debugAutoRate() aufgerufen!');
            console.log('memberProfiles:', memberProfiles);
            console.log('tasks:', tasks);
            try {
                // Auto-Rate f√ºr ALLE Profile und ALLE Tasks
                if (!memberProfiles || memberProfiles.length === 0) {
                    alert('‚ùå Keine Profile vorhanden! Bitte zuerst Profile anlegen.');
                    return;
                }
                if (!tasks || tasks.length === 0) {
                    alert('‚ùå Keine Tasks vorhanden! Bitte zuerst Tasks anlegen.');
                    return;
                }
                memberProfiles.forEach((member, memberIdx) => {
                tasks.forEach((task, taskIdx) => {
                    // Generiere zuf√§llige realistische Werte
                    const randomRating = {
                        minutes: Math.floor(Math.random() * 50) + 10, // 10-60 Minuten
                        pain: Math.floor(Math.random() * 5) + 1,      // 1-5 Schmerz
                        importance: Math.floor(Math.random() * 5) + 1, // 1-5 Wichtigkeit
                        frequency: Math.floor(Math.random() * 4) + 1   // 1-4 H√§ufigkeit
                    };
                    
                    // Speichere Rating
                    if (!ratings[member.name]) ratings[member.name] = {};
                    if (!allRatings[member.name]) allRatings[member.name] = {};
                    
                    const ratingData = {
                        minutes: randomRating.minutes,
                        pain: randomRating.pain,
                        importance: randomRating.importance,
                        frequency: randomRating.frequency,
                        points: Math.round((randomRating.minutes + (randomRating.minutes * randomRating.pain / 10)) * randomRating.importance)
                    };
                    
                    ratings[member.name][task.title] = ratingData;
                    allRatings[member.name][task.title] = ratingData;
                });
            });
            
            // Speichern und direkt zum n√§chsten Schritt
            saveCurrentState();
            showSuccessToast('üéØ Auto-Rate abgeschlossen! Alle Profile haben zuf√§llige Ratings erhalten.');
            
            // Direkt zu Phase 3 (Task-Setup) gehen - aber erst alle Ratings komplett abschlie√üen
            setTimeout(() => {
                // Alle Rating-Phasen als abgeschlossen markieren
                currentRatingMemberIndex = memberProfiles.length;
                currentTaskIndex = tasks.length;
                
                // Direkt zum Task-Setup
                nextPhase(3);
            }, 1500);
            } catch (error) {
                console.error('‚ùå Fehler in debugAutoRate:', error);
                alert('‚ùå Fehler beim Auto-Rate: ' + error.message);
            }
        }

        function addTask() {
            const taskList = document.getElementById('taskList');
            const newTask = document.createElement('div');
            newTask.className = 'task-item';
            newTask.innerHTML = `
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" placeholder="z.B. W√§sche waschen" />
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <input type="text" placeholder="W√§sche sortieren, waschen, aufh√§ngen..." />
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="minDaysEnabled_${taskId}" onchange="toggleMinDays('${taskId}', this.checked)">
                        <label for="minDaysEnabled_${taskId}" style="margin: 0;">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                    </div>
                    <div id="minDaysSlider_${taskId}" style="margin-left: 24px; display: none;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>Mindestens </span>
                            <input type="range" class="min-days-range" min="1" max="30" value="3" style="width: 150px;" oninput="updateMinDays('${taskId}', this.value)">
                            <span id="minDaysValue_${taskId}">3</span>
                            <span> Tage Pause</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <label style="margin: 0;">Icon w√§hlen</label>
                        <button type="button" onclick="toggleIconSelector(this)" style="background: none; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px;">üìã Mehr Icons</button>
                    </div>
                    
                    <!-- Quick Icons -->
                    <div class="emoji-grid" style="margin-bottom: 8px;">
                        <div class="emoji-option selected" onclick="selectIcon(this, 'fas fa-broom', 'üßπ')" data-icon="fas fa-broom"><i class="fas fa-broom"></i></div>
                        <div class="emoji-option" onclick="selectIcon(this, 'fas fa-utensils', 'üçΩÔ∏è')" data-icon="fas fa-utensils"><i class="fas fa-utensils"></i></div>
                        <div class="emoji-option" onclick="selectIcon(this, 'fas fa-shower', 'üõÅ')" data-icon="fas fa-shower"><i class="fas fa-shower"></i></div>
                        <div class="emoji-option" onclick="selectIcon(this, 'fas fa-trash', 'üóëÔ∏è')" data-icon="fas fa-trash"><i class="fas fa-trash"></i></div>
                        <div class="emoji-option" onclick="selectIcon(this, 'fas fa-tools', 'üîß')" data-icon="fas fa-tools"><i class="fas fa-tools"></i></div>
                        <div class="emoji-option" onclick="selectIcon(this, 'fas fa-seedling', 'üå±')" data-icon="fas fa-seedling"><i class="fas fa-seedling"></i></div>
                    </div>
                    
                    <!-- Erweiterte Icon-Auswahl (versteckt) -->
                    <div class="extended-icon-selector" style="display: none; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f8fafc;">
                        <div style="margin-bottom: 8px;"><h4 style="font-size: 12px; margin: 0; color: #374151;">üßπ Putzen & Hygiene</h4></div>
                        <div class="emoji-grid">
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-soap', 'üßΩ')" data-icon="fas fa-soap"><i class="fas fa-soap"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-spray-can', 'üß¥')" data-icon="fas fa-spray-can"><i class="fas fa-spray-can"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-toilet-paper', 'üßª')" data-icon="fas fa-toilet-paper"><i class="fas fa-toilet-paper"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-bath', 'ÔøΩ')" data-icon="fas fa-bath"><i class="fas fa-bath"></i></div>
                        </div>
                        <div style="margin: 8px 0;"><h4 style="font-size: 12px; margin: 0; color: #374151;">üçΩÔ∏è K√ºche</h4></div>
                        <div class="emoji-grid">
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-coffee', '‚òï')" data-icon="fas fa-coffee"><i class="fas fa-coffee"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-wine-glass', 'ÔøΩ')" data-icon="fas fa-wine-glass"><i class="fas fa-wine-glass"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-blender', 'ü•§')" data-icon="fas fa-blender"><i class="fas fa-blender"></i></div>
                        </div>
                        <div style="margin: 8px 0;"><h4 style="font-size: 12px; margin: 0; color: #374151;">üè† Haushalt</h4></div>
                        <div class="emoji-grid">
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-home', 'üè†')" data-icon="fas fa-home"><i class="fas fa-home"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-box', 'üì¶')" data-icon="fas fa-box"><i class="fas fa-box"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-recycle', '‚ôªÔ∏è')" data-icon="fas fa-recycle"><i class="fas fa-recycle"></i></div>
                            <div class="emoji-option" onclick="selectIcon(this, 'fas fa-couch', 'üõãÔ∏è')" data-icon="fas fa-couch"><i class="fas fa-couch"></i></div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="this.closest('.task-item').remove()">Task entfernen</button>
            `;
            taskList.appendChild(newTask);
        }

        function toggleMinDays(taskId, enabled) {
            const slider = document.getElementById(`minDaysSlider_${taskId}`);
            if (slider) {
                if (enabled) {
                    slider.style.display = 'block';
                } else {
                    slider.style.display = 'none';
                }
            }
        }

        function toggleTaskMinDays(taskIndex, enabled) {
            const slider = document.getElementById(`taskMinDaysSlider_${taskIndex}`);
            if (slider) {
                slider.style.display = enabled ? 'block' : 'none';
            }
            
            // Sofort aktualisieren f√ºr bessere UX
            if (tasks[taskIndex]) {
                if (!enabled) {
                    tasks[taskIndex].minDaysBetween = 0;
                }
            }
        }

        function updateMinDays(taskId, value) {
            const valueElement = document.getElementById(`minDaysValue_${taskId}`);
            if (valueElement) {
                valueElement.textContent = value;
            }
        }

        function updateTaskMinDays(taskIndex, value) {
            const display = document.getElementById(`taskMinDaysValue_${taskIndex}`);
            if (display) {
                display.textContent = value;
            }
            
            // Update im tasks Array f√ºr Live-Vorschau
            if (tasks[taskIndex]) {
                tasks[taskIndex].minDaysBetween = parseInt(value);
            }
        }

        function updateDialMinDays(taskId, value) {
            // Update Kreisregler Visualisierung
            const progress = document.getElementById(`dialProgress_${taskId}`);
            const text = document.getElementById(`dialText_${taskId}`);
            const label = document.getElementById(`dialLabel_${taskId}`);
            
            if (progress && text && label) {
                // Berechne Kreisbogen (157 ist Umfang, 0-150 ist Range)
                const percentage = (value - 1) / 29; // 1-30 auf 0-1 normalisieren
                const offset = 157 - (157 * percentage);
                progress.style.strokeDashoffset = offset;
                
                // Update Text im Kreis
                text.textContent = value;
                
                // Update Label
                const dayText = value === '1' ? 'Tag' : 'Tage';
                label.textContent = `${value} ${dayText}`;
                
                // Farbwechsel basierend auf Wert
                const color = value <= 3 ? '#10b981' : value <= 7 ? '#3b82f6' : '#f59e0b';
                progress.style.stroke = color;
            }
        }

        function generateStrokeDisplay(count) {
            if (count === 0) return '';
            
            let result = '';
            let remaining = count;
            
            // Moderne Strich-Darstellung: n√§her beieinander, letzter Strich quer durch alle
            while (remaining >= 5) {
                result += `
                    <span class="tally-group" style="
                        display: inline-block;
                        position: relative;
                        margin-right: 8px;
                        width: 24px;
                        height: 18px;
                    ">
                        <span style="
                            position: absolute;
                            left: 2px;
                            top: 0;
                            width: 2px;
                            height: 16px;
                            background: #374151;
                            border-radius: 1px;
                        "></span>
                        <span style="
                            position: absolute;
                            left: 6px;
                            top: 0;
                            width: 2px;
                            height: 16px;
                            background: #374151;
                            border-radius: 1px;
                        "></span>
                        <span style="
                            position: absolute;
                            left: 10px;
                            top: 0;
                            width: 2px;
                            height: 16px;
                            background: #374151;
                            border-radius: 1px;
                        "></span>
                        <span style="
                            position: absolute;
                            left: 14px;
                            top: 0;
                            width: 2px;
                            height: 16px;
                            background: #374151;
                            border-radius: 1px;
                        "></span>
                        <span style="
                            position: absolute;
                            left: 0;
                            top: 6px;
                            width: 20px;
                            height: 2px;
                            background: #dc2626;
                            border-radius: 1px;
                            transform: rotate(-25deg);
                            transform-origin: center;
                        "></span>
                    </span>
                `;
                remaining -= 5;
            }
            
            // Einzelne Striche (n√§her beieinander)
            if (remaining > 0) {
                const width = remaining * 4;
                result += `<span style="display: inline-block; position: relative; width: ${width}px; height: 16px; margin-right: 4px;">`;
                for (let i = 0; i < remaining; i++) {
                    result += `
                        <span style="
                            position: absolute;
                            left: ${i * 4}px;
                            top: 0;
                            width: 2px;
                            height: 16px;
                            background: #374151;
                            border-radius: 1px;
                        "></span>
                    `;
                }
                result += `</span>`;
            }
            
            return result;
        }

        function nextPhase(phase) {
            if (phase === 1) {
                wgName = document.getElementById('wgName').value.trim();
                if (!wgName) {
                    alert('Bitte gib einen Namen f√ºr die WG ein!');
                    return;
                }
                
                memberNames = [];
                document.querySelectorAll('.member-name').forEach(input => {
                    if (input.value.trim()) {
                        memberNames.push(input.value.trim());
                    }
                });
                
                if (memberNames.length === 0) {
                    alert('Bitte gib mindestens einen Namen ein!');
                    return;
                }
                
                currentMemberIndex = 0;
                document.getElementById('currentMember').textContent = memberNames[0];
                document.getElementById('wgNameDisplay').textContent = wgName;
                
                // Debug: Setze erste Person mit Debug-Daten
                const debugProfile = debugProfiles[0];
                document.getElementById('userName').value = debugProfile.name;
                document.getElementById('userEmail').value = debugProfile.email;
            }

            if (phase === 2) {
                const userName = document.getElementById('userName').value.trim();
                if (!userName) {
                    alert('Bitte gib deinen Namen ein!');
                    return;
                }
                
                memberProfiles.push({
                    name: userName,
                    avatar: selectedAvatar,
                    email: document.getElementById('userEmail').value.trim()
                });
                
                currentMemberIndex++;
                if (currentMemberIndex < memberNames.length) {
                    const debugProfile = debugProfiles[currentMemberIndex];
                    document.getElementById('currentMember').textContent = memberNames[currentMemberIndex];
                    document.getElementById('userName').value = debugProfile.name;
                    document.getElementById('userEmail').value = debugProfile.email;
                    
                    const isLast = currentMemberIndex === memberNames.length - 1;
                    document.getElementById('profileButton').textContent = isLast ? 'Tasks erstellen ‚Üí' : 'N√§chste Person ‚Üí';
                    
                    // Avatar auf Debug-Wert setzen
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    document.querySelectorAll('.avatar-option').forEach(el => {
                        if (el.textContent === debugProfile.avatar) {
                            el.classList.add('selected');
                            selectedAvatar = debugProfile.avatar;
                        }
                    });
                    return;
                } else {
                    phase = 2; // Zu Task-Erstellung
                }
            }

            if (phase === '2_5') {
                // Tasks sammeln und zur Benutzer√ºbersicht
                tasks = [];
                document.querySelectorAll('.task-item').forEach((item, index) => {
                    const title = item.querySelector('input[placeholder*="z.B."]')?.value || item.querySelector('input[type="text"]')?.value || '';
                    const description = item.querySelector('input[placeholder*="..."]')?.value || item.querySelectorAll('input[type="text"]')[1]?.value || '';
                    const emoji = item.dataset.emoji || 'üßπ';
                    
                    // Pr√ºfe neue Checkbox/Range-Logik
                    const checkbox = item.querySelector(`input[id*="minDaysEnabled"]`);
                    let minDays = 0;
                    if (checkbox && checkbox.checked) {
                        const range = item.querySelector('.min-days-range');
                        minDays = parseInt(range?.value) || 3;
                    }
                    
                    if (title.trim()) {
                        tasks.push({ 
                            title: title.trim(), 
                            description: description.trim(), 
                            emoji,
                            minDaysBetween: minDays
                        });
                    }
                });

                if (tasks.length === 0) {
                    alert('Bitte f√ºge mindestens einen Task hinzu!');
                    return;
                }

                // Initialize ratings status
                userRatingsStatus = {};
                memberProfiles.forEach(profile => {
                    userRatingsStatus[profile.name] = false;
                });

                // Zeige Benutzer√ºbersicht
                buildUserOverview();
            }

            if (phase === 3) {
                // Start ratings for specific user or first user
                if (typeof currentRatingMemberIndex === 'undefined') {
                    currentRatingMemberIndex = 0;
                }
                currentTaskIndex = 0;
                if (!allRatings) allRatings = {};
                
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('totalMembers').textContent = memberProfiles.length;
                document.getElementById('ratingMemberName').textContent = memberProfiles[0].name;
                document.getElementById('currentRatingMember').textContent = 1;
                
                loadTask(0);
            }

            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById(`phase${phase}`).classList.remove('hidden');
            
            // Update user overview if returning to it
            if (phase === '2_5') {
                buildUserOverview();
            }
        }

        function loadTask(index) {
            const task = tasks[index];
            document.getElementById('taskEmoji').textContent = task.emoji;
            document.getElementById('taskTitle').textContent = task.title;
            document.getElementById('taskDescription').textContent = task.description;
            document.getElementById('currentTask').textContent = index + 1;
            
            // Debug: Auto-fill mit realistischen Werten
            const memberName = memberProfiles[currentRatingMemberIndex].name;
            if (debugRatings[memberName] && debugRatings[memberName][task.title]) {
                const rating = debugRatings[memberName][task.title];
                document.querySelector('input[onchange*="minutesValue"]').value = rating.minutes;
                document.querySelector('input[onchange*="painValue"]').value = rating.pain;
                document.querySelector('input[onchange*="importanceValue"]').value = rating.importance;
                document.querySelector('input[onchange*="frequencyValue"]').value = rating.frequency;
                
                updateValue('minutesValue', rating.minutes);
                updateValue('painValue', rating.pain);
                updateValue('importanceValue', rating.importance);
                updateValue('frequencyValue', rating.frequency);
            } else {
                // Default values
                document.querySelectorAll('.slider').forEach(slider => {
                    slider.value = slider.defaultValue;
                    updateValue(slider.onchange.toString().match(/updateValue\('(\w+)'/)[1], slider.value);
                });
            }
            
            updateTaskPoints();
        }

        function updateValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
            updateTaskPoints();
        }

        function updateTaskPoints() {
            const minutesEl = document.getElementById('minutesValue');
            const painEl = document.getElementById('painValue');
            const importanceEl = document.getElementById('importanceValue');
            const frequencyEl = document.getElementById('frequencyValue');
            
            if (!minutesEl || !painEl || !importanceEl || !frequencyEl) return;
            
            const minutes = parseInt(minutesEl.textContent);
            const pain = parseInt(painEl.textContent);
            const importance = parseInt(importanceEl.textContent);
            const frequency = parseInt(frequencyEl.textContent);
            
            const points = Math.round((minutes + minutes * pain * 0.1) * (importance / 10));
            const monthlyPoints = points * frequency;
            
            const taskPointsEl = document.getElementById('taskPoints');
            const monthlyPointsEl = document.getElementById('monthlyPoints');
            
            if (taskPointsEl) taskPointsEl.textContent = points;
            if (monthlyPointsEl) monthlyPointsEl.textContent = monthlyPoints;
        }

        function previousTask() {
            if (currentTaskIndex > 0) {
                saveCurrentRating();
                currentTaskIndex--;
                loadTask(currentTaskIndex);
            }
        }

        function nextTask() {
            saveCurrentRating();
            
            if (currentTaskIndex < tasks.length - 1) {
                currentTaskIndex++;
                loadTask(currentTaskIndex);
            } else {
                // User finished rating all tasks, mark as completed and go back to overview
                const currentUser = memberProfiles[currentRatingMemberIndex].name;
                userRatingsStatus[currentUser] = true;
                
                // Go back to user overview
                nextPhase('2_5');
            }
        }

        function saveCurrentRating() {
            const memberName = memberProfiles[currentRatingMemberIndex].name;
            const taskTitle = tasks[currentTaskIndex].title;
            
            if (!allRatings[memberName]) {
                allRatings[memberName] = {};
            }
            
            allRatings[memberName][taskTitle] = {
                minutes: parseInt(document.getElementById('minutesValue').textContent),
                pain: parseInt(document.getElementById('painValue').textContent),
                importance: parseInt(document.getElementById('importanceValue').textContent),
                frequency: parseInt(document.getElementById('frequencyValue').textContent)
            };
        }

        // User Overview Functions
        let userRatingsStatus = {};

        function buildUserOverview() {
            const container = document.getElementById('userOverviewList');
            container.innerHTML = '';
            
            console.log('Building user overview. userRatingsStatus:', userRatingsStatus);
            console.log('memberProfiles:', memberProfiles);
            
            memberProfiles.forEach((profile, index) => {
                // Check if user has completed all tasks by checking allRatings
                const hasCompletedRatings = allRatings[profile.name] && 
                    Object.keys(allRatings[profile.name]).length === tasks.length;
                
                const isCompleted = userRatingsStatus[profile.name] || hasCompletedRatings;
                const statusIcon = isCompleted ? '‚úÖ' : '‚è≥';
                const statusText = isCompleted ? 'Fertig bewertet' : 'Noch nicht bewertet';
                const buttonText = isCompleted ? 'Bewertungen √§ndern' : 'Jetzt bewerten';
                
                console.log(`Profile ${profile.name}: completed=${isCompleted}, ratingsCount=${allRatings[profile.name] ? Object.keys(allRatings[profile.name]).length : 0}/${tasks.length}`);
                
                const userCard = document.createElement('div');
                userCard.className = `card ${isCompleted ? 'bg-green-50' : 'bg-gray-50'} mb-3`;
                userCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 32px;">${profile.avatar}</div>
                            <div>
                                <h3 class="font-bold">${profile.name}</h3>
                                <p class="text-gray-600">${profile.email || 'Keine E-Mail'}</p>
                                <p class="text-sm ${isCompleted ? 'text-green-600' : 'text-gray-500'}">${statusIcon} ${statusText}</p>
                            </div>
                        </div>
                        <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" onclick="startRatingFor(${index})">
                            ${buttonText}
                        </button>
                    </div>
                `;
                container.appendChild(userCard);
            });
            
            // Check if all users completed
            const allCompleted = memberProfiles.every(profile => userRatingsStatus[profile.name]);
            document.getElementById('startAllBtn').style.display = allCompleted ? 'block' : 'none';
        }

        function startRatingFor(memberIndex) {
            currentRatingMemberIndex = memberIndex;
            nextPhase(3);
        }

        function startAllRatings() {
            // Go to final completion phase
            showCompletion();
        }

        function debugFillAllRatings() {
            // Mark all as completed
            memberProfiles.forEach(profile => {
                userRatingsStatus[profile.name] = true;
                // Fill with debug ratings if available
                if (!allRatings[profile.name] && debugRatings[profile.name]) {
                    allRatings[profile.name] = debugRatings[profile.name];
                }
            });
            buildUserOverview();
        }

        // Dashboard Functions
        let taskExecutions = {}; // Store task executions per user
        let taskQualityRatings = {}; // Store quality ratings for completed tasks
        
        function showCompletion() {
            showDashboard();
        }

        function showDashboard() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('phaseComplete').classList.remove('hidden');
            
            // Update dashboard stats (with null checks)
            const dashboardWgName = document.getElementById('dashboardWgName');
            if (dashboardWgName) {
                dashboardWgName.textContent = wgName;
            }
            
            // Initialize task executions if needed
            if (Object.keys(taskExecutions).length === 0) {
                memberProfiles.forEach(profile => {
                    taskExecutions[profile.name] = {};
                    tasks.forEach(task => {
                        taskExecutions[profile.name][task.title] = [];
                    });
                });
            }
            
            // Update all dashboard statistics
            updateDashboardStats();
            
            // Update pending ratings badge
            updatePendingRatingsBadge();
        }

        function updatePendingRatingsBadge() {
            const currentUser = getCurrentUser();
            let pendingCount = 0;
            
            // Count pending ratings
            Object.entries(taskExecutions).forEach(([userName, userTasks]) => {
                if (userName === currentUser) return; // Don't rate your own tasks
                
                Object.entries(userTasks).forEach(([taskName, executions]) => {
                    executions.forEach(execution => {
                        if (execution.id && canUserRateTask(execution.id)) {
                            pendingCount++;
                        }
                    });
                });
            });
            
            const badge = document.getElementById('pendingRatingsBadge');
            if (pendingCount > 0) {
                badge.style.display = 'inline';
                badge.textContent = pendingCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // Period Settings Functions
        function loadPeriodDates() {
            const settings = localStorage.getItem('periodSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                if (parsed.startDate && parsed.endDate) {
                    document.getElementById('periodStartDate').value = parsed.startDate;
                    document.getElementById('periodEndDate').value = parsed.endDate;
                    return;
                }
            }
            
            // Default: Current month
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('periodStartDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('periodEndDate').value = endOfMonth.toISOString().split('T')[0];
        }

        function savePeriodDates() {
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Bitte w√§hle sowohl Start- als auch Enddatum aus.');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start >= end) {
                alert('Das Enddatum muss nach dem Startdatum liegen.');
                return;
            }
            
            const settings = {
                startDate: startDate,
                endDate: endDate
            };
            
            localStorage.setItem('periodSettings', JSON.stringify(settings));
            updatePeriodDisplay();
            updateDashboardStats(); // Refresh dashboard with new period
            
            // Show success feedback
            const saveButton = document.querySelector('button[onclick="savePeriodDates()"]');
            if (saveButton) {
                const originalText = saveButton.textContent;
                saveButton.textContent = '‚úÖ Gespeichert!';
                saveButton.style.background = '#10b981';
                setTimeout(() => {
                    saveButton.textContent = originalText;
                    saveButton.style.background = '';
                }, 2000);
            }
        }

        function resetPeriodDates() {
            localStorage.removeItem('periodSettings');
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('periodStartDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('periodEndDate').value = endOfMonth.toISOString().split('T')[0];
            updatePeriodDisplay();
            updateDashboardStats();
        }

        function getCurrentPeriod() {
            const settings = localStorage.getItem('periodSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                if (parsed.startDate && parsed.endDate) {
                    const start = new Date(parsed.startDate);
                    const end = new Date(parsed.endDate);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    
                    return {
                        start: start,
                        end: end,
                        days: days
                    };
                }
            }
            
            // Default: Current month
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            return {
                start: start,
                end: end,
                days: days
            };
        }

        function updatePeriodInfo() {
            const period = getCurrentPeriod();
            const options = { day: 'numeric', month: 'long' };
            const startStr = period.start.toLocaleDateString('de-DE', options);
            const endStr = period.end.toLocaleDateString('de-DE', options);
            
            const currentPeriodInfo = document.getElementById('currentPeriodInfo');
            if (currentPeriodInfo) {
                currentPeriodInfo.textContent = `${startStr} - ${endStr} (${period.days} Tage)`;
            }
            
            // Calculate daily average based on total target points
            const totalTargetPoints = 100; // This could be configurable later
            const dailyAverage = (totalTargetPoints / period.days).toFixed(1);
            const dailyAverageInfo = document.getElementById('dailyAverageInfo');
            if (dailyAverageInfo) {
                dailyAverageInfo.textContent = `${dailyAverage} Punkte`;
            }
        }



        function showPeriodSettings() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('periodSettings').classList.remove('hidden');
            loadPeriodDates();
            updatePeriodDisplay();
        }

        function updatePeriodDisplay() {
            const period = getCurrentPeriod();
            const options = { day: 'numeric', month: 'long' };
            const startStr = period.start.toLocaleDateString('de-DE', options);
            const endStr = period.end.toLocaleDateString('de-DE', options);
            
            // Update in period settings page
            const currentPeriodDisplay = document.getElementById('currentPeriodDisplay');
            if (currentPeriodDisplay) {
                currentPeriodDisplay.textContent = `${startStr} - ${endStr} (${period.days} Tage)`;
            }
            
            // Calculate daily average based on total target points
            const totalTargetPoints = 100; // This could be configurable later
            const dailyAverage = (totalTargetPoints / period.days).toFixed(1);
            const dailyAverageDisplay = document.getElementById('dailyAverageDisplay');
            if (dailyAverageDisplay) {
                dailyAverageDisplay.textContent = `${dailyAverage} Punkte`;
            }
        }

        function setPeriodPreset(preset) {
            const now = new Date();
            let startDate, endDate;
            
            switch (preset) {
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'nextMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 2, 0);
                    break;
                case '4weeks':
                    startDate = new Date(now); // Heute
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate()); // Genau 1 Monat sp√§ter
                    break;
                case '2weeks':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - startDate.getDay()); // Start of current week
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 13); // 2 weeks = 14 days - 1
                    break;
            }
            
            document.getElementById('periodStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('periodEndDate').value = endDate.toISOString().split('T')[0];
            updatePeriodDisplay();
        }

        function showTaskManagement() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('taskManagement').classList.remove('hidden');
            buildTaskManagementList();
        }

        function showTaskTable() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('taskTable').classList.remove('hidden');
            buildTaskTable();
        }

        function showMasterOverview() {
            // Hide all phases first
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            
            // Show master overview
            document.getElementById('masterOverview').classList.remove('hidden');
            
            // Update master statistics
            updateMasterStatistics();
        }

        function updateMasterStatistics() {
            const wgName = localStorage.getItem('wgName') || 'Nicht konfiguriert';
            const members = JSON.parse(localStorage.getItem('wgMembers') || '[]');
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            
            // Count ratings
            let totalRatings = 0;
            members.forEach(member => {
                tasks.forEach(task => {
                    const rating = localStorage.getItem(`rating_${member.name}_${task.name}`);
                    if (rating) totalRatings++;
                });
            });
            
            // Update display
            document.getElementById('masterWgName').textContent = wgName;
            document.getElementById('masterMemberCount').textContent = members.length;
            document.getElementById('masterTaskCount').textContent = tasks.length;
            document.getElementById('masterRatingsCount').textContent = totalRatings;
        }

        // Navigation history for back button
        let navigationHistory = [];

        function showPhase(phaseId) {
            // Save current page to history
            const currentPhase = document.querySelector('.phase:not(.hidden)');
            if (currentPhase) {
                navigationHistory.push(currentPhase.id);
            }

            // Hide all phases
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            
            // Show target phase
            document.getElementById(phaseId).classList.remove('hidden');
            
            // Initialize specific phases
            if (phaseId === 'temporaryResidents') {
                // Initialize temporary residents page
                if (typeof buildTemporaryResidentsList === 'function') {
                    buildTemporaryResidentsList();
                }
                // Set default icon selection
                if (typeof selectTempPersonIcon === 'function') {
                    selectTempPersonIcon('üë§');
                }
            }
        }

        function goBack() {
            if (navigationHistory.length > 0) {
                const previousPhase = navigationHistory.pop();
                
                // Hide all phases
                document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
                
                // Show previous phase
                document.getElementById(previousPhase).classList.remove('hidden');
            } else {
                // Fallback to Dashboard (Schnell√ºbersicht)
                showDashboard();
            }
        }

        function buildTaskManagementList() {
            const container = document.getElementById('taskManagementList');
            container.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskCard = document.createElement('div');
                taskCard.className = 'card mb-4';
                taskCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="font-size: 24px;">${task.emoji}</div>
                        <div style="flex: 1;">
                            <input type="text" value="${task.title}" class="task-edit-name" style="font-weight: bold; border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 100%;">
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label>Beschreibung:</label>
                        <input type="text" value="${task.description}" class="task-edit-description" style="border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 100%;">
                    </div>
                    
                    <div class="form-group mb-3">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="taskMinDays_${index}" ${task.minDaysBetween > 0 ? 'checked' : ''} onchange="toggleTaskMinDays(${index}, this.checked)">
                            <label for="taskMinDays_${index}">‚è≥ Mindestabstand zwischen Ausf√ºhrungen</label>
                        </div>
                        <div id="taskMinDaysSlider_${index}" style="margin-left: 24px; ${task.minDaysBetween > 0 ? '' : 'display: none;'}">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>Mindestens </span>
                                <input type="range" min="1" max="30" value="${task.minDaysBetween || 1}" style="width: 150px;" oninput="updateTaskMinDays(${index}, this.value)">
                                <span id="taskMinDaysValue_${index}">${task.minDaysBetween || 1}</span>
                                <span> Tage Pause</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üìã Checkliste f√ºr diesen Task:</label>
                        <div id="checklistItems_${index}" class="mt-2">
                            ${(task.checklist || []).map((item, itemIndex) => `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" value="${item}" class="checklist-item" style="flex: 1; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                                    <button onclick="removeChecklistItem(${index}, ${itemIndex})" class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addChecklistItem(${index})" class="btn btn-secondary mt-2" style="font-size: 14px;">+ Punkt hinzuf√ºgen</button>
                    </div>
                `;
                container.appendChild(taskCard);
            });
        }

        function buildTaskTable() {
            // Get all members including temporary ones for current date
            const allCurrentMembers = getAllMembersForDate();
            const tempMembers = getActiveTemporaryResidents();
            const memberCount = allCurrentMembers.length;
            
            let memberDisplayText = `${memberProfiles.length} Mitglieder: ${memberProfiles.map(p => p.name).join(', ')}`;
            if (tempMembers.length > 0) {
                memberDisplayText += `<br><span style="color: #f59e0b; font-weight: bold;">+ ${tempMembers.length} tempor√§re: ${tempMembers.map(t => t.name).join(', ')}</span>`;
            }
            
            summary.innerHTML = `
                <div class="card mb-4" style="background: #fef3c7;">
                    <h3 class="font-bold mb-2">üè† ${wgName}</h3>
                    <p>${memberDisplayText}</p>
                    ${tempMembers.length > 0 ? `<div style="background: rgba(245, 158, 11, 0.2); padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 14px; color: #92400e;"><i class="fas fa-calculator"></i> <strong>Punkte angepasst:</strong> +${Math.round((tempMembers.length / 6) * 100)}% f√ºr tempor√§re Bewohner</div>` : ''}
                </div>
            ` + tasks.map(task => {
                const taskRatings = [];
                Object.keys(allRatings).forEach(memberName => {
                    if (allRatings[memberName][task.title]) {
                        taskRatings.push(allRatings[memberName][task.title]);
                    }
                });
                
                if (taskRatings.length === 0) return '';
                
                const avgMinutes = Math.round(taskRatings.reduce((sum, r) => sum + r.minutes, 0) / taskRatings.length);
                const avgPain = Math.round(taskRatings.reduce((sum, r) => sum + r.pain, 0) / taskRatings.length);
                const avgImportance = Math.round(taskRatings.reduce((sum, r) => sum + r.importance, 0) / taskRatings.length);
                const avgFrequency = Math.round(taskRatings.reduce((sum, r) => sum + r.frequency, 0) / taskRatings.length);
                
                const basePoints = Math.round((avgMinutes + avgMinutes * avgPain * 0.1) * (avgImportance / 10));
                const period = getCurrentPeriod();
                const periodRatio = period.days / 30; // Ratio compared to standard 30-day month
                
                // Apply temporary residents adjustment to points
                const adjustedPoints = calculateAdjustedTaskPoints(basePoints);
                const periodPoints = Math.round(adjustedPoints * avgFrequency * periodRatio);
                
                let minDaysText = '';
                if (task.minDaysBetween === 0) {
                    minDaysText = 'üîÑ T√§glich m√∂glich';
                } else if (task.minDaysBetween === 1) {
                    minDaysText = 'üîÑ Min. 1 Tag Pause';
                } else if (task.minDaysBetween === 7) {
                    minDaysText = 'üîÑ Min. 1 Woche Pause';
                } else if (task.minDaysBetween === 14) {
                    minDaysText = 'üîÑ Min. 2 Wochen Pause';
                } else if (task.minDaysBetween === 30) {
                    minDaysText = 'üîÑ Nur 1x/Monat';
                } else {
                    minDaysText = `üîÑ Min. ${task.minDaysBetween} Tage Pause`;
                }
                
                return `
                    <div class="task-item">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span style="font-size: 24px; margin-right: 12px;">${task.emoji}</span>
                                <div>
                                    <strong>${task.title}</strong><br>
                                    <small class="text-gray-600">${task.description}</small><br>
                                    <small class="text-gray-600">‚è±Ô∏è ${avgMinutes}min ¬∑ üò§ ${avgPain}/10 ¬∑ ‚≠ê ${avgImportance}/10 ¬∑ üìÖ ${avgFrequency}x/Monat</small><br>
                                    <small class="text-gray-600">${minDaysText}</small>
                                </div>
                            </div>
                            <div class="text-right">
                                <div><strong>${points}</strong> Punkte</div>
                                <div class="text-sm text-gray-600">${periodPoints}/Periode</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buildTaskTable() {
            // Debug: Clear old absences data if it contains outdated dates
            if (absences && Object.keys(absences).length > 0) {
                const today = new Date();
                let hasOldData = false;
                
                Object.values(absences).forEach(userAbsences => {
                    userAbsences.forEach(absence => {
                        const endDate = new Date(absence.endDate);
                        if (endDate.getFullYear() < today.getFullYear()) {
                            hasOldData = true;
                        }
                    });
                });
                
                if (hasOldData) {
                    console.log('üßπ Bereinige veraltete Abwesenheitsdaten...');
                    absences = {};
                    saveCurrentState();
                }
            }
            
            const table = document.getElementById('taskTableGrid');
            
            // Header erstellen
            let headerHtml = '<thead><tr><th style="border: 1px solid #e5e7eb; padding: 16px 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-align: left; font-weight: 600; color: #334155; font-size: 14px;">Task</th>';
            memberProfiles.forEach(profile => {
                headerHtml += `<th style="border: 1px solid #e5e7eb; padding: 16px 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-align: center; font-weight: 600; color: #334155; font-size: 14px; min-width: 120px;">${profile.avatar} ${profile.name}</th>`;
            });
            headerHtml += '</tr></thead>';
            
            // Body erstellen
            let bodyHtml = '<tbody>';
            tasks.forEach((task, taskIndex) => {
                const isUrgent = isTaskUrgent(task.title);
                const urgentClass = isUrgent ? 'urgent-task' : '';
                const urgentBg = isUrgent ? '#fef2f2' : '#ffffff';
                const urgentHoverBg = isUrgent ? '#fee2e2' : '#f8fafc';
                const urgentBorder = isUrgent ? '2px solid #ef4444' : '1px solid #e5e7eb';
                
                // Get task points and next execution info
                const taskPoints = calculateTaskPointsForDisplay(task);
                let nextExecutionInfo = '';
                
                if (task.minInterval && task.minInterval > 0) {
                    const nextDate = getNextExecutionDate(task.title);
                    if (nextDate) {
                        const isAvailable = new Date() >= new Date(nextDate);
                        const dateStr = new Date(nextDate).toLocaleDateString('de-DE');
                        nextExecutionInfo = `
                            <div style="font-size: 11px; color: ${isAvailable ? '#10b981' : '#ef4444'}; margin-top: 2px;">
                                <i class="fas fa-clock" style="font-size: 10px;"></i> ${isAvailable ? 'Verf√ºgbar' : dateStr}
                            </div>
                        `;
                    }
                }

                bodyHtml += `<tr style="transition: all 0.2s ease;" class="${urgentClass}">
                    <td style="border: ${urgentBorder}; padding: 16px 20px; font-weight: 500; cursor: pointer; background: ${urgentBg}; hover:background-color: ${urgentHoverBg};" onclick="selectTaskToExecute(\`${task.title}\`, ${taskIndex})" onmouseover="this.style.backgroundColor='${urgentHoverBg}'" onmouseout="this.style.backgroundColor='${urgentBg}'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${isUrgent ? '<i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 16px; animation: urgent-flash 2s infinite;"></i>' : ''}
                            <span style="font-size: 18px;">${task.emoji}</span>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: ${isUrgent ? '#dc2626' : '#334155'}; font-size: 15px; font-weight: ${isUrgent ? '700' : '500'};">${task.title}</span>
                                    <span style="background: #f3f4f6; color: #059669; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: bold;">${taskPoints}P</span>
                                    ${isUrgent ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold; text-transform: uppercase;">DRINGEND</span>' : ''}
                                </div>
                                ${nextExecutionInfo}
                            </div>
                        </div>
                    </td>`;
                
                memberProfiles.forEach(profile => {
                    const executions = taskExecutions[profile.name]?.[task.title] || [];
                    const executionCount = executions.length;
                    const strokesDisplay = generateStrokeDisplay(executionCount);
                    const totalPoints = executions.reduce((sum, exec) => sum + (exec.points || 0), 0);
                    
                    // Check if user is currently absent
                    const isAbsent = isUserCurrentlyAbsent(profile.name);
                    
                    if (isAbsent) {
                        const goneFishingSymbol = getGoneFishingSymbol();
                        bodyHtml += `<td style="border: 1px solid #e5e7eb; padding: 16px 20px; text-align: center; font-family: 'SF Mono', Monaco, monospace; font-size: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-width: 120px;">
                            <div class="gone-fishing" title="${profile.name} ist aktuell abwesend">${goneFishingSymbol}</div>
                            <div style="font-size: 10px; color: #0891b2; font-family: system-ui; margin-top: 2px;">Abwesend</div>
                        </td>`;
                    } else {
                        bodyHtml += `<td style="border: 1px solid #e5e7eb; padding: 16px 20px; text-align: center; font-family: 'SF Mono', Monaco, monospace; font-size: 16px; background: #ffffff; min-width: 120px;">
                            <div style="color: #1f2937; font-weight: 500;">${strokesDisplay || '-'}</div>
                            <div style="font-size: 11px; color: #64748b; font-family: system-ui; margin-top: 4px;">(${totalPoints}P)</div>
                        </td>`;
                    }
                });
                
                bodyHtml += '</tr>';
            });
            bodyHtml += '</tbody>';
            
            // Add totals row
            let totalsHtml = '<tfoot><tr><td style="border: 1px solid #e5e7eb; padding: 16px 20px; font-weight: 700; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); color: #475569; font-size: 14px;">GESAMT</td>';
            
            memberProfiles.forEach(profile => {
                const isAbsent = isUserCurrentlyAbsent(profile.name);
                
                if (isAbsent) {
                    // Show Gone Fishing for currently absent users
                    const goneFishingSymbol = getGoneFishingSymbol();
                    totalsHtml += `<td style="border: 1px solid #e5e7eb; padding: 16px 20px; text-align: center; font-weight: 600; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-width: 120px;">
                        <div class="gone-fishing" style="font-size: 24px;" title="${profile.name} ist aktuell abwesend">${goneFishingSymbol}</div>
                        <div style="font-size: 10px; color: #0891b2; margin-top: 2px;">Gone Fishing</div>
                    </td>`;
                } else {
                    // Calculate total points for this user
                    let userTotalPoints = 0;
                    let userTotalTasks = 0;
                    
                    Object.entries(taskExecutions[profile.name] || {}).forEach(([taskTitle, executions]) => {
                        userTotalPoints += executions.reduce((sum, exec) => sum + (exec.points || 0), 0);
                        userTotalTasks += executions.length;
                    });
                    
                    // Calculate monthly target points (considering absences)
                    const baseMonthlyTarget = calculateMonthlyTargetPoints();
                    const absenceDays = getAbsenceDaysThisMonth(profile.name);
                    const adjustedTarget = absenceDays > 0 ? calculateAdjustedTarget(baseMonthlyTarget, absenceDays) : baseMonthlyTarget;
                    const percentage = adjustedTarget > 0 ? Math.round((userTotalPoints / adjustedTarget) * 100) : 0;
                    
                    const absenceIndicator = absenceDays > 0 ? ` üèñÔ∏è` : '';
                    const targetDisplay = absenceDays > 0 ? `${adjustedTarget}P (${baseMonthlyTarget}P-${absenceDays}d)` : `${adjustedTarget}P`;
                    
                    totalsHtml += `<td style="border: 1px solid #e5e7eb; padding: 16px 20px; text-align: center; font-weight: 600; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); min-width: 120px;">
                        <div style="font-size: 15px; color: #059669; font-weight: 700;">${userTotalPoints}P${absenceIndicator}</div>
                        <div style="font-size: 11px; color: #64748b; margin: 2px 0;">${userTotalPoints}/${targetDisplay} (${percentage}%)</div>
                        <div style="font-size: 10px; color: #94a3b8;">${userTotalTasks} Tasks</div>
                    </td>`;
                }
            });
            
            totalsHtml += '</tr></tfoot>';
            
            table.innerHTML = headerHtml + bodyHtml + totalsHtml;
        }

        // Modal-basierte Task-Ausf√ºhrung
        let currentTaskData = null;
        let selectedUserIndex = null;

        function selectTaskToExecute(taskTitle, taskIndex) {
            currentTaskData = {
                task: tasks[taskIndex],
                taskIndex: taskIndex
            };
            
            showTaskExecutionModal();
        }
        
        // Check and reset urgent status after task execution
        function checkAndResetUrgentStatus(taskTitle) {
            const wasUrgent = isTaskUrgent(taskTitle);
            
            if (wasUrgent) {
                // Remove from urgent list
                urgentTasks = urgentTasks.filter(ut => 
                    !(ut.taskTitle === taskTitle && ut.profileId === getCurrentProfileId())
                );
                saveUrgentTasks();
                
                console.log(`üîÑ Task "${taskTitle}" removed from urgent list after execution`);
                showSuccessToast(`‚úÖ "${taskTitle}" ist nicht mehr als dringend markiert`);
                
                // Update task displays
                updateTaskDisplays();
            }
        }

        function showTaskExecutionModal() {
            const modal = document.getElementById('taskExecutionModal');
            const task = currentTaskData.task;
            
            // Task Info aktualisieren
            document.getElementById('modalTaskEmoji').textContent = task.emoji;
            document.getElementById('modalTaskName').textContent = task.title;
            document.getElementById('modalTaskDescription').textContent = task.description || 'Keine Beschreibung verf√ºgbar';
            
            // User Grid erstellen
            const userGrid = document.getElementById('modalUserGrid');
            userGrid.innerHTML = memberProfiles.map((profile, index) => `
                <div class="user-card" data-user-index="${index}" onclick="selectUser(${index})">
                    <div class="user-avatar">${profile.avatar}</div>
                    <div class="user-name">${profile.name}</div>
                </div>
            `).join('');
            
            // Reset state
            selectedUserIndex = null;
            document.getElementById('userSelectionSection').style.display = 'block';
            document.getElementById('checklistSection').style.display = 'none';
            const executeBtn = document.getElementById('modalExecuteBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'Task erledigt! ‚úì';
            executeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            // Clear user card selections
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Modal anzeigen
            modal.classList.add('show');
            
            // Event Listeners
            document.getElementById('modalCancelBtn').onclick = closeTaskModal;
            document.getElementById('modalExecuteBtn').onclick = executeTask;
        }

        function selectUser(userIndex) {
            selectedUserIndex = userIndex;
            
            // Visual feedback
            document.querySelectorAll('.user-card').forEach((card, index) => {
                if (index === userIndex) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            const task = currentTaskData.task;
            const user = memberProfiles[userIndex];
            
            // Checklist zeigen falls vorhanden mit Animation
            if (task.checklist && task.checklist.length > 0) {
                // User-Auswahl ausblenden
                document.getElementById('userSelectionSection').style.display = 'none';
                
                // Zeige Best√§tigung
                showSuccessToast(`üë§ ${user.name} ausgew√§hlt! Jetzt Checklist abarbeiten:`);
                
                // Checklist nach kurzer Verz√∂gerung anzeigen
                setTimeout(() => {
                    showChecklistSection();
                }, 300);
            } else {
                // Direkt ausf√ºhren ohne Checklist
                document.getElementById('userSelectionSection').style.display = 'none';
                showSuccessToast(`üë§ ${user.name} ausgew√§hlt! Task kann erledigt werden:`);
                document.getElementById('modalExecuteBtn').disabled = false;
                
                // Button text anpassen
                document.getElementById('modalExecuteBtn').textContent = `‚úÖ Task f√ºr ${user.name} erledigen!`;
            }
        }

        function showChecklistSection() {
            const checklistSection = document.getElementById('checklistSection');
            checklistSection.style.display = 'block';
            
            const checklistContainer = document.getElementById('modalChecklist');
            const task = currentTaskData.task;
            const user = memberProfiles[selectedUserIndex];
            
            // Besserer Header f√ºr Checklist
            const checklistTitle = checklistSection.querySelector('h3');
            if (checklistTitle) {
                checklistTitle.innerHTML = `üìã ${user.name}, arbeite die Checklist ab:`;
            }
            
            checklistContainer.innerHTML = task.checklist.map((item, index) => `
                <div class="checklist-item">
                    <input type="checkbox" id="checkItem_${index}" onchange="updateExecuteButton()">
                    <label for="checkItem_${index}" style="margin: 0; cursor: pointer; flex: 1;">${item}</label>
                </div>
            `).join('');
            
            // Scroll to checklist
            setTimeout(() => {
                checklistSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            updateExecuteButton();
        }

        function updateExecuteButton() {
            const checkboxes = document.querySelectorAll('#modalChecklist input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const executeBtn = document.getElementById('modalExecuteBtn');
            
            executeBtn.disabled = !allChecked;
            
            if (selectedUserIndex !== null) {
                const user = memberProfiles[selectedUserIndex];
                if (allChecked) {
                    executeBtn.textContent = `üéâ Task f√ºr ${user.name} erledigt!`;
                    executeBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                } else {
                    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                    executeBtn.textContent = `üìã ${checkedCount}/${checkboxes.length} abgehakt`;
                    executeBtn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
                }
            }
        }

        function executeTask() {
            if (selectedUserIndex === null) return;
            
            const user = memberProfiles[selectedUserIndex];
            const task = currentTaskData.task;
            
            // Execute the task
            completeTaskExecution(task.title, user.name, currentTaskData.taskIndex);
            
            // Reset urgent status if task was marked as urgent
            checkAndResetUrgentStatus(task.title);
            
            closeTaskModal();
        }

        function closeTaskModal() {
            document.getElementById('taskExecutionModal').classList.remove('show');
            currentTaskData = null;
            selectedUserIndex = null;
        }

        // Toast Notification System
        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 2 seconds
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 2000);
        }

        // Checklist Management Functions
        function saveCurrentTaskValues() {
            // Speichere alle aktuellen Input-Werte bevor rebuild
            tasks.forEach((task, index) => {
                const titleInput = document.querySelector(`input[value="${task.title}"]`);
                if (titleInput) {
                    tasks[index].title = titleInput.value;
                }
                
                const descInput = titleInput?.parentElement?.nextElementSibling?.querySelector('input');
                if (descInput) {
                    tasks[index].description = descInput.value;
                }
                
                // Speichere Checklist-Werte
                const checklistItems = document.querySelectorAll(`#checklistItems_${index} .checklist-item`);
                if (checklistItems.length > 0) {
                    tasks[index].checklist = Array.from(checklistItems).map(item => item.value);
                }
            });
        }

        function addChecklistItem(taskIndex) {
            if (!tasks[taskIndex]) return;
            
            // Speichere aktuelle Werte
            saveCurrentTaskValues();
            
            if (!tasks[taskIndex].checklist) {
                tasks[taskIndex].checklist = [];
            }
            
            tasks[taskIndex].checklist.push('Neuer Checklistenpunkt');
            
            // Rebuild task management list to reflect changes
            buildTaskManagementList();
            showSuccessToast('Checklistenpunkt hinzugef√ºgt! üìã');
        }

        function removeChecklistItem(taskIndex, itemIndex) {
            if (!tasks[taskIndex] || !tasks[taskIndex].checklist) return;
            
            // Speichere aktuelle Werte
            saveCurrentTaskValues();
            
            tasks[taskIndex].checklist.splice(itemIndex, 1);
            
            // Rebuild task management list to reflect changes
            buildTaskManagementList();
            showSuccessToast('Checklistenpunkt entfernt! üóëÔ∏è');
        }



        function completeTaskExecution(taskTitle, userName, taskIndex) {
            if (!taskExecutions[userName]) taskExecutions[userName] = {};
            if (!taskExecutions[userName][taskTitle]) taskExecutions[userName][taskTitle] = [];
            
            // Calculate points for this task
            const taskPoints = calculateTaskPoints(taskTitle);
            
            const execution = {
                date: new Date().toISOString(),
                timestamp: new Date().getTime(),
                points: taskPoints,
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9) // Unique ID for rating
            };
            
            taskExecutions[userName][taskTitle].push(execution);
            
            // Update dashboard stats
            updateDashboardStats();
            
            // Show simple success message without rating option
            showSuccessToast(`‚úÖ "${taskTitle}" erledigt! ${userName} erh√§lt ${taskPoints} Punkte!`);
            buildTaskTable();
        }

        function calculateTaskPoints(param1, param2, param3, param4) {
            // Handle different calling patterns
            if (typeof param1 === 'string' && param2 === undefined) {
                // Called with taskTitle only - find task and calculate average
                const taskTitle = param1;
                const task = tasks.find(t => t.title === taskTitle);
                if (!task) return 10;
                
                const taskRatings = [];
                memberProfiles.forEach(profile => {
                    // Use memberTaskRatings which has the correct structure
                    if (memberTaskRatings[profile.name] && memberTaskRatings[profile.name][taskTitle]) {
                        taskRatings.push(memberTaskRatings[profile.name][taskTitle]);
                    }
                });
                
                if (taskRatings.length === 0) {
                    // Fallback: use default points if no ratings exist
                    return 10;
                }
                
                const avgMinutes = taskRatings.reduce((sum, r) => sum + r.minutes, 0) / taskRatings.length;
                const avgPain = taskRatings.reduce((sum, r) => sum + r.pain, 0) / taskRatings.length;
                const avgImportance = taskRatings.reduce((sum, r) => sum + r.importance, 0) / taskRatings.length;
                
                // Neue Formel: (Minuten + (Minuten √ó Pain / 10)) √ó Wichtigkeit
                return Math.round((avgMinutes + (avgMinutes * avgPain / 10)) * avgImportance);
            } else {
                // Called with individual rating values (minutes, pain, importance, frequency)
                const minutes = param1 || 0;
                const pain = param2 || 0;
                const importance = param3 || 0;
                const frequency = param4 || 0;
                
                // Neue Formel: (Minuten + (Minuten √ó Pain / 10)) √ó Wichtigkeit
                return Math.round((minutes + (minutes * pain / 10)) * importance);
            }
        }

        function updateDashboardStats() {
            // Update Task Count im Dashboard
            const totalTasksElement = document.getElementById('totalTasksCount');
            if (totalTasksElement) {
                totalTasksElement.textContent = tasks.length;
            }
            
            // Update Today Count
            const today = new Date().toDateString();
            let todayCount = 0;
            Object.values(taskExecutions).forEach(userTasks => {
                Object.values(userTasks).forEach(executions => {
                    todayCount += executions.filter(exec => new Date(exec.date).toDateString() === today).length;
                });
            });
            
            const todayElement = document.getElementById('completedTasksToday');
            if (todayElement) {
                todayElement.textContent = todayCount;
            }
            
            // Update Task-Tabelle falls sie gerade angezeigt wird
            const taskTablePhase = document.getElementById('taskTable');
            if (taskTablePhase && !taskTablePhase.classList.contains('hidden')) {
                buildTaskTable();
            }
            
            // Update Task Management falls es gerade angezeigt wird
            const taskManagementPhase = document.getElementById('taskManagement');
            if (taskManagementPhase && !taskManagementPhase.classList.contains('hidden')) {
                buildTaskManagementList();
            }
            
            // Update Period Info if on dashboard
            const dashboardPhase = document.getElementById('phaseComplete');
            if (dashboardPhase && !dashboardPhase.classList.contains('hidden')) {
                updatePeriodInfo();
            }
            
            // Update temporary residents list if on that page
            const tempResidentsPhase = document.getElementById('temporaryResidents');
            if (tempResidentsPhase && !tempResidentsPhase.classList.contains('hidden')) {
                buildTemporaryResidentsList();
            }
        }

        function saveTaskChanges() {
            try {
                // Sammle alle √Ñnderungen aus den Eingabefeldern
                const taskCards = document.querySelectorAll('#taskManagementList .card');
                
                taskCards.forEach((card, index) => {
                    if (tasks[index]) {
                        // Task-Name
                        const nameInput = card.querySelector('.task-edit-name');
                        if (nameInput) {
                            tasks[index].title = nameInput.value;
                        }
                        
                        // Task-Beschreibung
                        const descInput = card.querySelector('.task-edit-description');
                        if (descInput) {
                            tasks[index].description = descInput.value;
                        }
                        
                        // Mindestabstand
                        const minDaysCheckbox = card.querySelector(`#taskMinDays_${index}`);
                        if (minDaysCheckbox) {
                            if (minDaysCheckbox.checked) {
                                const slider = card.querySelector(`input[type="range"]`);
                                if (slider) {
                                    tasks[index].minDaysBetween = parseInt(slider.value);
                                }
                            } else {
                                tasks[index].minDaysBetween = 0;
                            }
                        }
                        
                        // Checkliste
                        const checklistInputs = card.querySelectorAll('.checklist-item');
                        const newChecklist = [];
                        checklistInputs.forEach(input => {
                            if (input.value.trim()) {
                                newChecklist.push(input.value.trim());
                            }
                        });
                        tasks[index].checklist = newChecklist;
                    }
                });
                
                // Speichern in localStorage
                saveCurrentState();
                
                // Dashboard aktualisieren
                updateDashboardStats();
                
                // Success message und Navigation
                showSuccessToast('‚úÖ Alle Task-√Ñnderungen wurden gespeichert!');
                
                setTimeout(() => {
                    showDashboard();
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern der Task-√Ñnderungen:', error);
                showSuccessToast('‚ùå Fehler beim Speichern!');
            }
        }

        function calculateMonthlyTargetPoints() {
            // Calculate period target points based on task ratings, frequencies, and custom period
            const period = getCurrentPeriod();
            const periodRatio = period.days / 30; // Ratio compared to standard 30-day month
            
            let totalPeriodPoints = 0;
            
            tasks.forEach(task => {
                const taskRatings = [];
                memberProfiles.forEach(profile => {
                    // Use memberTaskRatings for consistency
                    if (memberTaskRatings[profile.name] && memberTaskRatings[profile.name][task.title]) {
                        taskRatings.push(memberTaskRatings[profile.name][task.title]);
                    }
                });
                
                if (taskRatings.length > 0) {
                    const avgMinutes = taskRatings.reduce((sum, r) => sum + r.minutes, 0) / taskRatings.length;
                    const avgPain = taskRatings.reduce((sum, r) => sum + r.pain, 0) / taskRatings.length;
                    const avgImportance = taskRatings.reduce((sum, r) => sum + r.importance, 0) / taskRatings.length;
                    const avgFrequency = taskRatings.reduce((sum, r) => sum + r.frequency, 0) / taskRatings.length;
                    
                    const taskPoints = Math.round((avgMinutes + (avgMinutes * avgPain / 10)) * avgImportance);
                    // Adjust frequency based on custom period length
                    const periodTaskPoints = Math.round(taskPoints * avgFrequency * periodRatio);
                    
                    totalPeriodPoints += periodTaskPoints;
                }
            });
            
            // Distribute among all members
            return Math.round(totalPeriodPoints / memberProfiles.length);
        }

        function addRandomTaskExecution() {
            const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
            const randomUser = memberProfiles[Math.floor(Math.random() * memberProfiles.length)];
            const taskIndex = tasks.findIndex(t => t.title === randomTask.title);
            completeTaskExecution(randomTask.title, randomUser.name, taskIndex);
        }

        // Initialize first avatar selection
        selectAvatar(document.querySelector('.avatar-option'), 'üòä');

        // Absence Management System
        let absences = {}; // Structure: {userName: [{reason, startDate, endDate, days}]}
        let selectedAbsenceUser = null;
        
        // Check if user is currently absent
        function isUserCurrentlyAbsent(userName) {
            const today = new Date();
            const userAbsences = absences[userName] || [];
            
            return userAbsences.some(absence => {
                const startDate = new Date(absence.startDate);
                const endDate = new Date(absence.endDate);
                return today >= startDate && today <= endDate;
            });
        }
        
        function getGoneFishingSymbol() {
            const symbols = ['üé£', 'üèñÔ∏è', '‚úàÔ∏è', 'üå¥', '‚õµ', 'üçπ', 'üòé'];
            return symbols[Math.floor(Math.random() * symbols.length)];
        }

        // Profile Management System
        let wgProfiles = {}; // Structure: {profileId: {name, memberProfiles, tasks, ratings, absences, created, lastUsed}}
        let currentProfileId = null;

        function hideAllPhases() {
            console.log('üîÑ Verstecke alle Phasen...');
            document.querySelectorAll('.phase').forEach(el => {
                el.classList.add('hidden');
                console.log('Hidden:', el.id);
            });
        }

        // Profile Management Functions
        function showProfileSelection() {
            console.log('üè† Zeige Profil-Auswahl');
            hideAllPhases();
            document.getElementById('profileSelection').classList.remove('hidden');
            loadProfileList();
        }

        function loadProfileList() {
            const profileList = document.getElementById('profileList');
            const noProfilesMessage = document.getElementById('noProfilesMessage');
            
            const profileIds = Object.keys(wgProfiles);
            
            if (profileIds.length === 0) {
                profileList.innerHTML = '';
                noProfilesMessage.classList.remove('hidden');
                return;
            }
            
            noProfilesMessage.classList.add('hidden');
            
            let html = '';
            profileIds.forEach(profileId => {
                const profile = wgProfiles[profileId];
                const memberCount = profile.memberProfiles ? profile.memberProfiles.length : 0;
                const taskCount = profile.tasks ? profile.tasks.length : 0;
                const lastUsed = profile.lastUsed ? new Date(profile.lastUsed).toLocaleDateString('de-DE') : 'Nie verwendet';
                
                html += `
                    <div class="profile-card" onclick="loadProfile('${profileId}')">
                        <div class="profile-info">
                            <h3>${profile.name}</h3>
                            <div class="profile-stats">
                                <span><i class="fas fa-users"></i> ${memberCount} Mitglieder</span>
                                <span><i class="fas fa-tasks"></i> ${taskCount} Tasks</span>
                                <span><i class="fas fa-calendar"></i> ${lastUsed}</span>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn-load" onclick="event.stopPropagation(); loadProfile('${profileId}')" title="Profil laden">
                                <i class="fas fa-play"></i> Laden
                            </button>
                            <button class="btn-edit" onclick="event.stopPropagation(); editProfile('${profileId}')" title="Profil bearbeiten">
                                <i class="fas fa-edit"></i> Bearbeiten
                            </button>
                            <button class="btn-delete" onclick="event.stopPropagation(); confirmDeleteProfile('${profileId}')" title="Profil l√∂schen">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            profileList.innerHTML = html;
        }

        function createNewProfile() {
            console.log('‚ûï Erstelle neues Profil');
            
            // Neues Profil initialisieren
            currentProfileId = 'profile_' + Date.now();
            
            // Default-Werte zur√ºcksetzen
            wgName = 'Meine WG';
            memberNames = [];
            memberProfiles = [];
            tasks = [];
            ratings = {};
            allRatings = {};
            absences = {};
            taskExecutions = {};
            
            // Setup-Workflow starten
            showPhase(0); // Phase 0: WG Setup
            showSuccessToast('üÜï Neues WG-Profil wird erstellt');
        }

        function loadDariusWG() {
            console.log('üöÄ Lade vorkonfigurierte Darius WG');
            
            currentProfileId = 'darius_wg_' + Date.now();
            
            // Direkt die setupRealWG Funktion verwenden
            setupRealWG();
            
            // Als Profil speichern
            setTimeout(() => {
                saveCurrentProfile();
                showSuccessToast('üè† Darius WG als Profil gespeichert!');
            }, 1000);
        }

        function loadProfile(profileId) {
            console.log('üìÇ Lade Profil:', profileId);
            
            const profile = wgProfiles[profileId];
            if (!profile) {
                alert('‚ùå Profil nicht gefunden!');
                return;
            }
            
            try {
                currentProfileId = profileId;
                
                // Profil-Daten laden
                wgName = profile.name || 'Meine WG';
                memberProfiles = profile.memberProfiles || [];
                memberNames = memberProfiles.map(p => p.name);
                tasks = profile.tasks || [];
                ratings = profile.ratings || {};
                allRatings = profile.allRatings || {};
                absences = profile.absences || {};
                taskExecutions = profile.taskExecutions || {};
                
                // Task executions initialisieren falls leer
                if (Object.keys(taskExecutions).length === 0 && memberProfiles.length > 0) {
                    taskExecutions = {};
                    memberProfiles.forEach(member => {
                        taskExecutions[member.name] = {};
                        tasks.forEach(task => {
                            taskExecutions[member.name][task.title] = [];
                        });
                    });
                }
                
                // Last used aktualisieren
                wgProfiles[profileId].lastUsed = new Date().toISOString();
                saveProfilesToStorage();
                
                // Direkt zum Dashboard
                showDashboard();
                showSuccessToast(`‚úÖ Profil "${profile.name}" geladen!`);
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden des Profils:', error);
                alert('‚ùå Fehler beim Laden des Profils: ' + error.message);
            }
        }

        function confirmDeleteProfile(profileId) {
            const profile = wgProfiles[profileId];
            if (!profile) return;
            
            const confirmMessage = `‚ö†Ô∏è ACHTUNG: Profil l√∂schen?\n\nProfil: "${profile.name}"\nMitglieder: ${profile.memberProfiles?.length || 0}\nTasks: ${profile.tasks?.length || 0}\n\nDiese Aktion kann NICHT r√ºckg√§ngig gemacht werden!`;
            
            if (confirm(confirmMessage)) {
                const doubleConfirm = `üö® LETZTE WARNUNG!\n\nProfile "${profile.name}" wird PERMANENT gel√∂scht!\n\nSind Sie ABSOLUT SICHER?`;
                
                if (confirm(doubleConfirm)) {
                    deleteProfile(profileId);
                }
            }
        }

        function deleteProfile(profileId) {
            console.log('üóëÔ∏è L√∂sche Profil:', profileId);
            
            const profileName = wgProfiles[profileId]?.name || 'Unbekannt';
            
            delete wgProfiles[profileId];
            saveProfilesToStorage();
            loadProfileList();
            
            showSuccessToast(`üóëÔ∏è Profil "${profileName}" wurde gel√∂scht`);
        }

        function saveCurrentProfile() {
            if (!currentProfileId) {
                console.warn('Kein aktuelles Profil zum Speichern');
                return;
            }
            
            console.log('üíæ Speichere aktuelles Profil:', currentProfileId);
            
            wgProfiles[currentProfileId] = {
                name: wgName,
                memberProfiles: JSON.parse(JSON.stringify(memberProfiles)),
                tasks: JSON.parse(JSON.stringify(tasks)),
                ratings: JSON.parse(JSON.stringify(ratings)),
                allRatings: JSON.parse(JSON.stringify(allRatings)),
                absences: JSON.parse(JSON.stringify(absences)),
                taskExecutions: JSON.parse(JSON.stringify(taskExecutions)),
                created: wgProfiles[currentProfileId]?.created || new Date().toISOString(),
                lastUsed: new Date().toISOString()
            };
            
            saveProfilesToStorage();
            console.log('‚úÖ Profil gespeichert');
        }

        function saveProfilesToStorage() {
            try {
                localStorage.setItem('wgProfiles', JSON.stringify(wgProfiles));
                localStorage.setItem('currentProfileId', currentProfileId || '');
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern der Profile:', error);
            }
        }

        function loadProfilesFromStorage() {
            try {
                const savedProfiles = localStorage.getItem('wgProfiles');
                const savedCurrentId = localStorage.getItem('currentProfileId');
                
                if (savedProfiles && savedProfiles !== 'undefined' && savedProfiles !== 'null') {
                    wgProfiles = JSON.parse(savedProfiles);
                    console.log('üìÇ Profile aus Storage geladen:', Object.keys(wgProfiles));
                } else {
                    wgProfiles = {};
                    console.log('üìÇ Keine gespeicherten Profile gefunden - leeres Objekt initialisiert');
                }
                
                if (savedCurrentId && savedCurrentId !== 'undefined' && savedCurrentId !== 'null' && savedCurrentId !== '') {
                    currentProfileId = savedCurrentId;
                    console.log('üéØ Aktuelles Profil ID:', currentProfileId);
                } else {
                    currentProfileId = null;
                    console.log('üéØ Keine aktuelle Profil ID gesetzt');
                }
                
                // Load task quality ratings
                const savedRatings = localStorage.getItem('taskQualityRatings');
                if (savedRatings && savedRatings !== 'undefined' && savedRatings !== 'null') {
                    taskQualityRatings = JSON.parse(savedRatings);
                    console.log('‚≠ê Task-Qualit√§tsbewertungen geladen:', Object.keys(taskQualityRatings).length);
                } else {
                    taskQualityRatings = {};
                    console.log('‚≠ê Keine Task-Qualit√§tsbewertungen gefunden');
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Profile:', error);
                wgProfiles = {};
                currentProfileId = null;
                taskQualityRatings = {};
            }
        }

        function clearAllProfiles() {
            if (confirm('üö® ALLE WG-Profile l√∂schen?\n\nDies l√∂scht ALLE gespeicherten Profile permanent!\n\nSind Sie sicher?')) {
                if (confirm('‚ö†Ô∏è LETZTE WARNUNG!\n\nALLE Profile werden unwiderruflich gel√∂scht!\n\nFortfahren?')) {
                    wgProfiles = {};
                    currentProfileId = null;
                    localStorage.removeItem('wgProfiles');
                    localStorage.removeItem('currentProfileId');
                    localStorage.removeItem('absences');
                    localStorage.removeItem('ratings');
                    localStorage.removeItem('allRatings');
                    
                    loadProfileList();
                    showSuccessToast('üóëÔ∏è Alle Profile wurden gel√∂scht');
                }
            }
        }

        function exportProfiles() {
            const exportData = {
                profiles: wgProfiles,
                currentProfileId: currentProfileId,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `putzplan-profile-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showSuccessToast('üì§ Profile exportiert');
        }

        function showAbsenceManager() {
            console.log('üî• showAbsenceManager() aufgerufen!');
            console.log('memberProfiles:', memberProfiles);
            
            // Pr√ºfen ob Profil-Daten vorhanden sind
            if (!memberProfiles || memberProfiles.length === 0) {
                console.log('‚ö†Ô∏è Keine Profile gefunden - verwende Debug-Profile');
                memberProfiles = debugProfiles;
            }
            
            try {
                hideAllPhases();
                document.getElementById('absenceManager').classList.remove('hidden');
                buildAbsenceUserGrid();
                displayAbsenceList();
            
            // Set default dates (today and tomorrow)
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('absenceStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('absenceEndDate').value = tomorrow.toISOString().split('T')[0];
            
            // Set up event listeners for date changes
            setTimeout(() => {
                const startDateInput = document.getElementById('absenceStartDate');
                const endDateInput = document.getElementById('absenceEndDate');
                
                if (startDateInput && endDateInput) {
                    startDateInput.addEventListener('change', updateAbsenceCalculation);
                    endDateInput.addEventListener('change', updateAbsenceCalculation);
                }
            }, 100);
            
            } catch (error) {
                console.error('‚ùå Fehler in showAbsenceManager:', error);
                alert('‚ùå Fehler beim √ñffnen der Abwesenheits-Verwaltung: ' + error.message);
            }
        }

        function buildAbsenceUserGrid() {
            const grid = document.getElementById('absenceUserGrid');
            grid.className = 'absence-user-grid'; // Spezielle Grid-Klasse
            grid.innerHTML = memberProfiles.map(profile => `
                <div class="absence-user-card" onclick="selectAbsenceUser('${profile.name}', this)">
                    <div style="font-size: 32px; margin-bottom: 4px;">${profile.avatar}</div>
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">${profile.name}</div>
                    <div style="font-size: 11px; color: #6b7280;">${getAbsenceDaysThisMonth(profile.name)} Tage</div>
                </div>
            `).join('');
        }

        function selectAbsenceUser(userName, element) {
            document.querySelectorAll('.absence-user-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAbsenceUser = userName;
            
            document.getElementById('absenceDateSelection').classList.remove('hidden');
            updateAbsenceCalculation();
        }

        function updateAbsenceCalculation() {
            const startDate = document.getElementById('absenceStartDate').value;
            const endDate = document.getElementById('absenceEndDate').value;
            
            if (startDate && endDate && selectedAbsenceUser) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                if (days > 0) {
                    const monthlyTarget = calculateMonthlyTargetPoints();
                    const daysInMonth = new Date(start.getFullYear(), start.getMonth() + 1, 0).getDate();
                    const dailyTarget = monthlyTarget / daysInMonth;
                    const reductionPoints = Math.round(dailyTarget * days);
                    const newTarget = Math.max(0, monthlyTarget - reductionPoints);
                    
                    document.getElementById('absenceSummary').classList.remove('hidden');
                    document.getElementById('absenceImpact').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 14px;">
                            <div><strong>${days}</strong> Tage abwesend</div>
                            <div><strong>-${reductionPoints}P</strong> Reduktion</div>
                            <div><strong>${newTarget}P</strong> neues Ziel</div>
                        </div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 8px;">
                            Urspr√ºngliches Monatsziel: ${monthlyTarget}P ‚Ä¢ T√§glicher Durchschnitt: ${Math.round(dailyTarget)}P
                        </div>
                    `;
                }
            }
        }

        function saveAbsence() {
            console.log('üî• saveAbsence() aufgerufen!');
            console.log('selectedAbsenceUser:', selectedAbsenceUser);
            try {
                const startDate = document.getElementById('absenceStartDate').value;
                const endDate = document.getElementById('absenceEndDate').value;
                const reason = document.getElementById('absenceReason').value;
            
            if (!selectedAbsenceUser || !startDate || !endDate) {
                alert('Bitte f√ºlle alle Felder aus!');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            if (days <= 0) {
                alert('Das End-Datum muss nach dem Start-Datum liegen!');
                return;
            }
            
            if (!absences[selectedAbsenceUser]) {
                absences[selectedAbsenceUser] = [];
            }
            
            // Bearbeitungsmodus pr√ºfen
            if (editingAbsence) {
                console.log('‚úèÔ∏è Bearbeitungsmodus - Update existierende Abwesenheit');
                
                // √úberlappungspr√ºfung - aber aktuelle Abwesenheit ausschlie√üen
                const newStart = new Date(startDate);
                const newEnd = new Date(endDate);
                
                const overlapping = absences[selectedAbsenceUser].find((existing, idx) => {
                    // Aktuelle Abwesenheit ausschlie√üen
                    if (idx === editingAbsence.index) return false;
                    
                    const existingStart = new Date(existing.startDate);
                    const existingEnd = new Date(existing.endDate);
                    
                    return (newStart <= existingEnd && newEnd >= existingStart);
                });
                
                if (overlapping) {
                    const overlapStart = new Date(overlapping.startDate).toLocaleDateString('de-DE');
                    const overlapEnd = new Date(overlapping.endDate).toLocaleDateString('de-DE');
                    alert(`‚ùå Zeitraum-√úberschneidung!\n\nDer neue Zeitraum √ºberschneidet sich mit:\n${overlapStart} - ${overlapEnd} (${overlapping.reason})\n\nBitte w√§hle einen anderen Zeitraum.`);
                    return;
                }
                
                // Update existierende Abwesenheit
                absences[selectedAbsenceUser][editingAbsence.index] = {
                    reason: reason,
                    startDate: startDate,
                    endDate: endDate,
                    days: days,
                    created: absences[selectedAbsenceUser][editingAbsence.index].created, // Original-Datum behalten
                    updated: new Date().toISOString()
                };
                
                showSuccessToast(`‚úÖ Abwesenheit von ${selectedAbsenceUser} aktualisiert (${days} Tage)`);
                editingAbsence = null;
                
            } else {
                console.log('‚ûï Neue Abwesenheit hinzuf√ºgen');
                
                // Pr√ºfung auf √ºberlappende Zeitr√§ume f√ºr neue Eintr√§ge
                const newStart = new Date(startDate);
                const newEnd = new Date(endDate);
                
                const overlapping = absences[selectedAbsenceUser].find(existing => {
                    const existingStart = new Date(existing.startDate);
                    const existingEnd = new Date(existing.endDate);
                    
                    return (newStart <= existingEnd && newEnd >= existingStart);
                });
                
                if (overlapping) {
                    const overlapStart = new Date(overlapping.startDate).toLocaleDateString('de-DE');
                    const overlapEnd = new Date(overlapping.endDate).toLocaleDateString('de-DE');
                    alert(`‚ùå Zeitraum-√úberschneidung!\n\nDer neue Zeitraum √ºberschneidet sich mit:\n${overlapStart} - ${overlapEnd} (${overlapping.reason})\n\nBitte w√§hle einen anderen Zeitraum.`);
                    return;
                }
                
                // Neue Abwesenheit hinzuf√ºgen
                absences[selectedAbsenceUser].push({
                    reason: reason,
                    startDate: startDate,
                    endDate: endDate,
                    days: days,
                    created: new Date().toISOString()
                });
                
                showSuccessToast(`‚úÖ Abwesenheit f√ºr ${selectedAbsenceUser} gespeichert (${days} Tage)`);
            }
            
            saveCurrentState();
            cancelAbsenceEntry();
            displayAbsenceList();
            buildAbsenceUserGrid();
            } catch (error) {
                console.error('‚ùå Fehler in saveAbsence:', error);
                alert('‚ùå Fehler beim Speichern der Abwesenheit: ' + error.message);
            }
        }

        function cancelAbsenceEntry() {
            selectedAbsenceUser = null;
            editingAbsence = null; // Edit-Modus zur√ºcksetzen
            
            document.getElementById('absenceDateSelection').classList.add('hidden');
            document.getElementById('absenceSummary').classList.add('hidden');
            document.querySelectorAll('.absence-user-card').forEach(el => el.classList.remove('selected'));
            
            // Button zur√ºcksetzen
            const saveButton = document.querySelector('button[onclick="saveAbsence()"]');
            if (saveButton) {
                saveButton.innerHTML = 'Abwesenheit speichern';
                saveButton.style.background = '';
            }
        }

        function displayAbsenceList() {
            const list = document.getElementById('absenceList');
            
            if (Object.keys(absences).length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Noch keine Abwesenheiten eingetragen</div>';
                return;
            }
            
            let html = '';
            Object.entries(absences).forEach(([userName, userAbsences]) => {
                userAbsences.forEach((absence, index) => {
                    const reasonIcons = {
                        vacation: 'üèñÔ∏è Urlaub',
                        work: 'üíº Gesch√§ftsreise',
                        family: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie'
                    };
                    
                    html += `
                        <div class="absence-entry ${absence.reason}">
                            <div>
                                <div style="font-weight: 600;">${userName} ‚Ä¢ ${reasonIcons[absence.reason] || '‚ùì Unbekannt'}</div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    ${formatDate(absence.startDate)} - ${formatDate(absence.endDate)} 
                                    (${absence.days} Tage)
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editAbsence(&quot;${userName}&quot;, ${index})" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 4px;" title="Bearbeiten">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAbsence(&quot;${userName}&quot;, ${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px;" title="L√∂schen">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            list.innerHTML = html;
        }

        function deleteAbsence(userName, index) {
            console.log('üóëÔ∏è deleteAbsence aufgerufen:', userName, index);
            try {
                if (confirm(`Abwesenheit von ${userName} wirklich l√∂schen?`)) {
                    if (absences[userName] && absences[userName][index]) {
                        absences[userName].splice(index, 1);
                        if (absences[userName].length === 0) {
                            delete absences[userName];
                        }
                        saveCurrentState();
                        displayAbsenceList();
                        buildAbsenceUserGrid();
                        showSuccessToast('Abwesenheit gel√∂scht');
                    } else {
                        alert('‚ùå Abwesenheit nicht gefunden!');
                    }
                }
            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen:', error);
                alert('‚ùå Fehler beim L√∂schen der Abwesenheit: ' + error.message);
            }
        }

        let editingAbsence = null;

        function editAbsence(userName, index) {
            console.log('‚úèÔ∏è editAbsence aufgerufen:', userName, index);
            try {
                if (!absences[userName] || !absences[userName][index]) {
                    alert('‚ùå Abwesenheit nicht gefunden!');
                    return;
                }

                const absence = absences[userName][index];
                editingAbsence = { userName, index };

                // User ausw√§hlen
                selectAbsenceUser(userName, document.querySelector(`.absence-user-card[onclick*="${userName}"]`));

                // Daten in Formular laden
                document.getElementById('absenceStartDate').value = absence.startDate;
                document.getElementById('absenceEndDate').value = absence.endDate;
                document.getElementById('absenceReason').value = absence.reason;

                // Update calculation
                updateAbsenceCalculation();

                // Button Text √§ndern
                const saveButton = document.querySelector('button[onclick="saveAbsence()"]');
                if (saveButton) {
                    saveButton.innerHTML = '√Ñnderungen speichern';
                    saveButton.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                }

                showSuccessToast(`‚úèÔ∏è Bearbeite Abwesenheit von ${userName}`);
            } catch (error) {
                console.error('‚ùå Fehler beim Bearbeiten:', error);
                alert('‚ùå Fehler beim Bearbeiten der Abwesenheit: ' + error.message);
            }
        }

        function getAbsenceDaysThisMonth(userName) {
            if (!absences[userName]) return 0;
            
            const period = getCurrentPeriod();
            
            return absences[userName].reduce((total, absence) => {
                const start = new Date(absence.startDate);
                const end = new Date(absence.endDate);
                
                // Check if absence overlaps with current period
                if ((start <= period.end && end >= period.start)) {
                    // Calculate overlapping days within the period
                    const overlapStart = new Date(Math.max(start.getTime(), period.start.getTime()));
                    const overlapEnd = new Date(Math.min(end.getTime(), period.end.getTime()));
                    const overlapDays = Math.max(0, Math.ceil((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                    return total + overlapDays;
                }
                return total;
            }, 0);
        }

        function addDemoAbsences() {
            absences = {
                'Anna': [{
                    reason: 'vacation',
                    startDate: '2025-10-15',
                    endDate: '2025-10-22',
                    days: 8,
                    created: new Date().toISOString()
                }],
                'Ben': [{
                    reason: 'business', 
                    startDate: '2025-09-29',
                    endDate: '2025-10-01',
                    days: 3,
                    created: new Date().toISOString()
                }]
            };
            
            saveCurrentState();
            displayAbsenceList();
            buildAbsenceUserGrid();
            showSuccessToast('üêõ Demo-Abwesenheiten hinzugef√ºgt');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function cleanupDuplicateAbsences() {
            console.log('üßπ Bereinige doppelte Abwesenheits-Eintr√§ge...');
            let removedCount = 0;
            
            Object.keys(absences).forEach(userName => {
                const userAbsences = absences[userName];
                const unique = [];
                
                userAbsences.forEach(absence => {
                    const isDuplicate = unique.some(existing => 
                        existing.startDate === absence.startDate &&
                        existing.endDate === absence.endDate &&
                        existing.reason === absence.reason
                    );
                    
                    if (!isDuplicate) {
                        unique.push(absence);
                    } else {
                        removedCount++;
                        console.log(`Entfernt: ${userName} - ${absence.startDate} bis ${absence.endDate}`);
                    }
                });
                
                absences[userName] = unique;
            });
            
            if (removedCount > 0) {
                saveCurrentState();
                displayAbsenceList();
                buildAbsenceUserGrid();
                showSuccessToast(`üßπ ${removedCount} doppelte Eintr√§ge entfernt`);
                console.log(`‚úÖ ${removedCount} doppelte Abwesenheits-Eintr√§ge entfernt`);
            } else {
                showSuccessToast('‚úÖ Keine doppelten Eintr√§ge gefunden');
            }
        }

        function calculateAdjustedTarget(baseTarget, absenceDays) {
            const period = getCurrentPeriod();
            const dailyTarget = baseTarget / period.days;
            const reduction = Math.round(dailyTarget * absenceDays);
            return Math.max(0, baseTarget - reduction);
        }

        function saveCurrentState() {
            // Save all current state to localStorage
            try {
                if (wgName) localStorage.setItem('wgName', wgName);
                if (memberProfiles && memberProfiles.length > 0) {
                    localStorage.setItem('wgMembers', JSON.stringify(memberProfiles));
                }
                if (tasks && tasks.length > 0) {
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                }
                if (Object.keys(ratings).length > 0) {
                    localStorage.setItem('ratings', JSON.stringify(ratings));
                }
                if (Object.keys(allRatings).length > 0) {
                    localStorage.setItem('allRatings', JSON.stringify(allRatings));
                }
                
                // Aktuelles Profil speichern (neue Funktion)
                if (currentProfileId) {
                    saveCurrentProfile();
                }
                if (Object.keys(taskExecutions).length > 0) {
                    localStorage.setItem('taskExecutions', JSON.stringify(taskExecutions));
                }
                if (Object.keys(absences).length > 0) {
                    localStorage.setItem('absences', JSON.stringify(absences));
                }
                
                // üíæ Auto-Backup nach dem Speichern
                if (typeof performAutoBackup === 'function') {
                    performAutoBackup('save_current_state');
                }
                
            } catch(e) {
                console.error('Fehler beim Speichern:', e);
            }
        }

        // Initialize profiles variable (alias for wgProfiles for compatibility)
        let profiles = wgProfiles;
        
        // Sync profiles with wgProfiles
        function syncProfiles() {
            profiles = wgProfiles;
            if (Object.keys(profiles).length === 0) {
                // Initialize with default profile
                profiles.default = {
                    name: 'Standard WG',
                    members: ['User1', 'User2'],
                    currentUser: 'User1',
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                };
                wgProfiles = profiles;
                localStorage.setItem('wgProfiles', JSON.stringify(profiles));
            }
        }
        
        // Event listeners werden in showAbsenceManager() gesetzt
        
        // Load data from localStorage if available  
        try {
            // Load profiles
            const savedProfiles = localStorage.getItem('wgProfiles');
            if (savedProfiles && savedProfiles !== 'undefined') {
                wgProfiles = JSON.parse(savedProfiles);
                syncProfiles();
            } else {
                syncProfiles();
            }
            
        } catch(e) {
            console.log('Keine Profil-Daten gefunden, verwende Default');
            syncProfiles();
        }
        
        try {
            const savedAbsences = localStorage.getItem('absences');
            if (savedAbsences && savedAbsences !== 'undefined') {
                absences = JSON.parse(savedAbsences);
                
                // Automatische Bereinigung bei Laden der Daten
                setTimeout(() => {
                    cleanupDuplicateAbsences();
                }, 1000);
            }
            
            const savedRatings = localStorage.getItem('ratings');
            if (savedRatings && savedRatings !== 'undefined') {
                ratings = JSON.parse(savedRatings);
            }
            
            const savedAllRatings = localStorage.getItem('allRatings');
            if (savedAllRatings && savedAllRatings !== 'undefined') {
                allRatings = JSON.parse(savedAllRatings);
            }
        } catch(e) {
            console.log('Keine gespeicherten Daten gefunden oder Fehler beim Laden');
        }

        // Sofort starten statt setTimeout verwenden
        console.log('üöÄ App wird gestartet...');
        try {
            // Profile Management System initialisieren
            loadProfilesFromStorage();
            syncProfiles(); // Profile synchronisieren
            
            // Direkt starten
            showProfileSelection();
            console.log('‚úÖ App erfolgreich gestartet');
        } catch (error) {
            console.error('‚ùå FEHLER beim App-Start:', error);
            alert('JavaScript Fehler: ' + error.message);
        }

        // Test ob JavaScript funktioniert
        console.log('üî• JavaScript geladen - Version:', new Date().toISOString());

        // Funktionen global verf√ºgbar machen
        window.showProfileSelection = showProfileSelection;
        window.createNewProfile = createNewProfile;
        window.loadDariusWG = loadDariusWG;
        window.loadProfile = loadProfile;
        window.confirmDeleteProfile = confirmDeleteProfile;
        window.clearAllProfiles = clearAllProfiles;
        window.exportProfiles = exportProfiles;
        // === HELPER FUNCTIONS ===
        function getCurrentUser() {
            // Get current user from profile system or fallback
            const profileId = getCurrentProfileId();
            const profileData = profiles[profileId];
            
            if (profileData && profileData.currentUser) {
                return profileData.currentUser;
            }
            // Fallback to first member if available
            if (profileData && profileData.members && profileData.members.length > 0) {
                return profileData.members[0];
            }
            // Last resort fallback
            return 'User1';
        }

        function getCurrentProfileId() {
            let profileId = localStorage.getItem('currentProfileId');
            if (!profileId || profileId === 'undefined' || profileId === 'null') {
                // Create default profile if none exists
                profileId = 'default';
                localStorage.setItem('currentProfileId', profileId);
                
                // Initialize default profile if it doesn't exist
                if (!profiles[profileId]) {
                    profiles[profileId] = {
                        name: 'Standard WG',
                        members: ['User1', 'User2'],
                        currentUser: 'User1',
                        created: new Date().toISOString(),
                        lastUsed: new Date().toISOString()
                    };
                    localStorage.setItem('wgProfiles', JSON.stringify(profiles));
                }
            }
            return profileId;
        }

        function showSetupSummary() {
            // Placeholder function - implement as needed
            console.log('Setup summary requested');
        }

        // === BEWERTUNGSSYSTEM ===
        let currentRatingTask = null;
        let selectedRating = 0;

        function openRatingModal(taskId, taskName, assignedTo) {
            currentRatingTask = { id: taskId, name: taskName, assignedTo: assignedTo };
            
            document.getElementById('ratingTaskTitle').textContent = `"${taskName}" bewerten`;
            document.getElementById('ratingTaskDetails').textContent = `Erledigt von: ${assignedTo}`;
            
            // Populate user dropdown
            const userSelect = document.getElementById('ratingUser');
            const profileId = getCurrentProfileId();
            const profileData = profiles[profileId];
            
            userSelect.innerHTML = '';
            if (profileData && profileData.members) {
                profileData.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    userSelect.appendChild(option);
                });
            }
            
            // Set current user as default
            const currentUser = getCurrentUser();
            userSelect.value = currentUser;
            
            // Reset form values
            document.getElementById('ratingMinutes').value = 30;
            document.getElementById('ratingPain').value = 5;
            document.getElementById('ratingImportance').value = 7;
            document.getElementById('ratingFrequency').value = 4;
            document.getElementById('ratingComment').value = '';
            
            // Update preview
            updatePointsPreview();
            
            document.getElementById('ratingModal').style.display = 'flex';
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').style.display = 'none';
            currentRatingTask = null;
            selectedRating = 0;
        }

        function submitDetailedRating() {
            if (!currentRatingTask) return;
            
            const raterUser = document.getElementById('ratingUser').value;
            const minutes = parseInt(document.getElementById('ratingMinutes').value) || 30;
            const pain = parseInt(document.getElementById('ratingPain').value) || 5;
            const importance = parseInt(document.getElementById('ratingImportance').value) || 7;
            const frequency = parseInt(document.getElementById('ratingFrequency').value) || 4;
            const comment = document.getElementById('ratingComment').value;
            const profileId = getCurrentProfileId();
            
            // Calculate points
            const points = calculateTaskPoints(minutes, pain, importance, frequency);
            
            // Initialize ratings structure if needed
            if (!allRatings[profileId]) {
                allRatings[profileId] = {};
            }
            if (!allRatings[profileId][currentRatingTask.name]) {
                allRatings[profileId][currentRatingTask.name] = [];
            }
            
            // Check if user already rated this task
            const existingRatingIndex = allRatings[profileId][currentRatingTask.name].findIndex(r => r.rater === raterUser);
            
            const rating = {
                rater: raterUser,
                minutes: minutes,
                pain: pain,
                importance: importance,
                frequency: frequency,
                points: points,
                comment: comment,
                date: new Date().toISOString(),
                taskName: currentRatingTask.name,
                assignedTo: currentRatingTask.assignedTo
            };
            
            if (existingRatingIndex >= 0) {
                // Update existing rating
                allRatings[profileId][currentRatingTask.name][existingRatingIndex] = rating;
            } else {
                // Add new rating
                allRatings[profileId][currentRatingTask.name].push(rating);
            }
            
            // Save to localStorage
            localStorage.setItem('allRatings', JSON.stringify(allRatings));
            
            alert(`Bewertung gespeichert! ${points} Punkte berechnet.`);
            closeRatingModal();
            
            // Refresh current view to show new rating
            if (document.getElementById('ratingOverview') && !document.getElementById('ratingOverview').classList.contains('hidden')) {
                showRatingOverview();
            }
            if (document.getElementById('phaseComplete') && !document.getElementById('phaseComplete').classList.contains('hidden')) {
                showDashboard();
            }
        }

        function getTaskRatings(taskName) {
            const profileId = getCurrentProfileId();
            if (!allRatings[profileId] || !allRatings[profileId][taskName]) {
                return [];
            }
            return allRatings[profileId][taskName];
        }

        function getAverageRating(taskName) {
            const taskRatings = getTaskRatings(taskName);
            if (taskRatings.length === 0) return 0;
            
            // Calculate average points instead of star rating
            const sum = taskRatings.reduce((acc, rating) => acc + (rating.points || 0), 0);
            return (sum / taskRatings.length).toFixed(1);
        }

        function getRatingStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return stars;
        }

        function canUserRateTask(taskId) {
            const currentUser = getCurrentUser();
            const taskRatings = getTaskRatings(taskId);
            
            // User can rate if they haven't rated this task yet
            return !taskRatings.some(rating => rating.rater === currentUser);
        }

        function getWhoNeedsToRate(taskId) {
            const profileData = profiles[getCurrentProfileId()];
            if (!profileData || !profileData.members) return [];
            
            const taskRatings = getTaskRatings(taskId);
            const whoRated = taskRatings.map(rating => rating.rater);
            
            return profileData.members.filter(member => !whoRated.includes(member));
        }

        function updatePointsPreview() {
            const minutes = parseInt(document.getElementById('ratingMinutes').value) || 30;
            const pain = parseInt(document.getElementById('ratingPain').value) || 5;
            const importance = parseInt(document.getElementById('ratingImportance').value) || 7;
            const frequency = parseInt(document.getElementById('ratingFrequency').value) || 4;
            
            const points = calculateTaskPoints(minutes, pain, importance, frequency);
            document.getElementById('pointsPreview').textContent = `${points} Punkte`;
            
            // Update slider displays
            document.getElementById('painValue').textContent = pain;
            document.getElementById('importanceValue').textContent = importance;
        }

        // Form input handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for live updates
            const inputs = ['ratingMinutes', 'ratingPain', 'ratingImportance', 'ratingFrequency'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', updatePointsPreview);
                }
            });
            
            // üö® Notfall-Wiederherstellung pr√ºfen
            setTimeout(() => {
                if (typeof checkForEmergencyRestore === 'function') {
                    checkForEmergencyRestore();
                }
            }, 1000); // Kurz warten bis alles geladen ist
        });

        window.showMasterOverview = showMasterOverview;
        window.setupRealWG = setupRealWG;
        window.completeAutoSetup = completeAutoSetup;

        // Weitere wichtige Funktionen global machen
        window.showDashboard = showDashboard;
        window.showAbsenceManager = showAbsenceManager;
        window.saveAbsence = saveAbsence;
        window.editAbsence = editAbsence;
        window.deleteAbsence = deleteAbsence;
        window.cleanupDuplicateAbsences = cleanupDuplicateAbsences;
        window.showTaskManagement = showTaskManagement;
        window.nextPhase = nextPhase;
        window.debugFillAndSkip = debugFillAndSkip;

        function showRatingOverview() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('ratingOverview').classList.remove('hidden');
            buildNewRatingOverview();
        }

        function buildNewRatingOverview() {
            populateRatingUserSelect();
            buildMonthlyPerformanceOverview();
            buildRecentCompletedTasks();
        }

        function populateRatingUserSelect() {
            const select = document.getElementById('ratingUserSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- W√§hle deinen Namen --</option>';
            
            memberProfiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.name;
                option.textContent = `${profile.avatar} ${profile.name}`;
                select.appendChild(option);
            });
            
            // Set current user if available
            const currentUser = getCurrentUser();
            if (currentUser) {
                select.value = currentUser;
            }
        }

        function updateRatingInterface() {
            const selectedUser = document.getElementById('ratingUserSelect').value;
            // Update interface based on selected user
            buildRecentCompletedTasks();
        }

        function buildMonthlyPerformanceOverview() {
            const container = document.getElementById('monthlyPerformanceOverview');
            if (!container) return;
            
            // Get past months (exclude current month) - only show COMPLETED periods
            const now = new Date();
            const pastMonths = [];
            
            // Check if we have any completed evaluation periods first
            const hasAnyCompletedData = false; // Will be set dynamically based on actual data
            
            // Generate last 6 months (excluding current month) - only completed periods
            for (let i = 1; i <= 6; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
                
                // Only add if period is completely finished (end date is in the past)
                if (monthEnd < now) {
                    pastMonths.push({
                        start: monthDate,
                        end: monthEnd,
                        name: monthDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })
                    });
                }
            }
            
            let html = `
                <div class="mb-4">
                    <h4 class="font-bold mb-2">üìä Leistungs√ºbersicht abgeschlossener Zeitr√§ume</h4>
                    <div class="text-sm text-gray-600">Zeigt Bewertungen nur von vollst√§ndig abgeschlossenen Perioden</div>
                </div>
            `;
            
            // Check if there are any past months to show
            if (pastMonths.length === 0) {
                html += `
                    <div class="card" style="padding: 24px; text-align: center; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div>
                        <h3 style="font-weight: bold; color: #0c4a6e; margin-bottom: 12px;">Noch keine abgeschlossenen Zeitr√§ume</h3>
                        <p style="color: #0369a1; margin-bottom: 16px;">Bewertungen werden erst angezeigt, wenn ein vollst√§ndiger Monat/Zeitraum vorbei ist.</p>
                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #bae6fd;">
                            <div style="font-size: 14px; color: #0c4a6e;">
                                <div><strong>üìã So funktioniert es:</strong></div>
                                <div>‚Ä¢ Am Ende jedes Monats werden die Bewertungen hier aufgelistet</div>
                                <div>‚Ä¢ Zeigt wer seine Ziele erreicht hat</div>
                                <div>‚Ä¢ Erm√∂glicht Vergleich der Leistungen √ºber Zeit</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            // Show each past month
            pastMonths.forEach(month => {
                const targetPoints = 100; // Standard monthly target
                
                html += `
                    <div class="card mb-4" style="padding: 16px; border-left: 4px solid #3b82f6;">
                        <h5 class="font-bold mb-3">${month.name}</h5>
                        <div style="display: grid; gap: 8px;">
                `;
                
                memberProfiles.forEach(profile => {
                    const userName = profile.name;
                    let monthPoints = 0;
                    
                    // Calculate points for this specific month
                    Object.entries(taskExecutions[userName] || {}).forEach(([taskTitle, executions]) => {
                        executions.forEach(exec => {
                            const execDate = new Date(exec.date);
                            if (execDate >= month.start && execDate <= month.end) {
                                monthPoints += (exec.points || 0);
                            }
                        });
                    });
                    
                    const percentage = targetPoints > 0 ? Math.round((monthPoints / targetPoints) * 100) : 0;
                    const achieved = percentage >= 80;
                    const statusIcon = achieved ? '‚úÖ' : '‚ùå';
                    const statusColor = achieved ? '#10b981' : '#ef4444';
                    const statusBg = achieved ? '#f0fdf4' : '#fef2f2';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: ${statusBg}; border-radius: 6px; border: 1px solid ${achieved ? '#dcfce7' : '#fee2e2'};">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">${profile.avatar}</span>
                                <span class="font-medium">${userName}</span>
                                <span>${statusIcon}</span>
                            </div>
                            <div style="text-align: right;">
                                <span class="font-bold" style="color: ${statusColor};">${monthPoints}P</span>
                                <span class="text-sm text-gray-500"> (${percentage}%)</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function buildRecentCompletedTasks() {
            const container = document.getElementById('recentCompletedTasks');
            if (!container) return;
            
            const selectedUser = document.getElementById('ratingUserSelect').value;
            console.log('Selected user for rating:', selectedUser);
            
            // Collect all task executions with dates
            const allExecutions = [];
            Object.entries(taskExecutions).forEach(([userName, userTasks]) => {
                Object.entries(userTasks).forEach(([taskTitle, executions]) => {
                    executions.forEach(execution => {
                        allExecutions.push({
                            ...execution,
                            taskTitle,
                            userName,
                            canRate: true // Make all tasks clickable for testing
                        });
                    });
                });
            });
            
            // Sort by date (newest first) and take last 10
            allExecutions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentTasks = allExecutions.slice(0, 10);
            
            let html = '';
            if (recentTasks.length === 0) {
                html = '<div class="text-center text-gray-500 py-8">Noch keine Tasks erledigt</div>';
            } else {
                recentTasks.forEach((task, index) => {
                    const taskDate = new Date(task.date);
                    const daysAgo = Math.floor((Date.now() - taskDate.getTime()) / (1000 * 60 * 60 * 24));
                    const timeAgoText = daysAgo === 0 ? 'Heute' : daysAgo === 1 ? 'Gestern' : `vor ${daysAgo} Tagen`;
                    
                    const canClickToRate = true; // Always make clickable for testing
                    const cursorStyle = 'cursor: pointer;';
                    const hoverBg = 'transition: background-color 0.2s; background: #f9fafb;';
                    const taskItemId = `task-item-${index}`;
                    
                    // Escape quotes in data for onclick handler
                    const safeTaskId = task.id.toString().replace(/'/g, "\\'");
                    const safeTaskTitle = task.taskTitle.replace(/'/g, "\\'");
                    const safeUserName = task.userName.replace(/'/g, "\\'");
                    
                    html += `
                        <div id="${taskItemId}" class="task-execution-item clickable-task" 
                             onclick="console.log('Direct click handler triggered'); openTaskRatingModal('${safeTaskId}', '${safeTaskTitle}', '${safeUserName}'); return false;"
                             style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin: 8px 0; border: 1px solid #e5e7eb; border-radius: 8px; ${cursorStyle} ${hoverBg}">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 20px;">${getTaskEmoji(task.taskTitle)}</div>
                                <div>
                                    <div class="font-bold">${task.taskTitle}</div>
                                    <div class="text-sm text-gray-600">von ${task.userName} ‚Ä¢ ${timeAgoText}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="text-align: right;">
                                    <div class="font-bold" style="color: #059669;">${task.points || 0}P</div>
                                    <div class="text-sm text-gray-600">${taskDate.toLocaleDateString('de-DE')}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; color: #fbbf24; font-size: 14px;"><i class="fas fa-star"></i><span>Bewerten</span></div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (!selectedUser) {
                html += '<div class="text-center text-amber-600 py-4 bg-amber-50 rounded-lg mt-4"><i class="fas fa-info-circle"></i> W√§hle deinen Namen aus, um Tasks bewerten zu k√∂nnen</div>';
            }
            
            container.innerHTML = html;
            
            // Tasks now use direct onclick handlers - no additional event listeners needed
            console.log('Tasks built with direct onclick handlers');
        }

        function getTaskEmoji(taskTitle) {
            const task = tasks.find(t => t.title === taskTitle);
            return task ? task.emoji : 'üìã';
        }

        function openTaskRatingModal(taskId, taskTitle, executorName) {
            console.log('Opening task rating modal for:', taskId, taskTitle, executorName);
            
            // Remove any existing modal first
            const existingModal = document.getElementById('taskRatingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create super simple modal that MUST be visible
            const modal = document.createElement('div');
            modal.id = 'taskRatingModal';
            modal.innerHTML = `
                <h2>TASK BEWERTEN</h2>
                <p><strong>Task:</strong> ${taskTitle}</p>
                <p><strong>Erledigt von:</strong> ${executorName}</p>
                <br>
                <button onclick="alert('Schlecht bewertet!'); closeTaskRatingModal();" style="margin: 5px; padding: 10px 15px; background: #ef4444; color: white; border: none; cursor: pointer;">üòû Schlecht</button>
                <button onclick="alert('Okay bewertet!'); closeTaskRatingModal();" style="margin: 5px; padding: 10px 15px; background: #f59e0b; color: white; border: none; cursor: pointer;">üòê Okay</button>
                <button onclick="alert('Gut bewertet!'); closeTaskRatingModal();" style="margin: 5px; padding: 10px 15px; background: #10b981; color: white; border: none; cursor: pointer;">üòä Gut</button>
                <button onclick="alert('Perfekt bewertet!'); closeTaskRatingModal();" style="margin: 5px; padding: 10px 15px; background: #059669; color: white; border: none; cursor: pointer;">ü§© Perfekt</button>
                <br><br>
                <button onclick="closeTaskRatingModal()" style="padding: 10px 20px; background: red; color: white; border: none; cursor: pointer; font-size: 16px;">‚úï SCHLIESSEN</button>
            `;
            
            // Apply CSS that will definitely make it visible
            Object.assign(modal.style, {
                position: 'fixed',
                top: '100px',
                left: '50%',
                transform: 'translateX(-50%)',
                width: '500px',
                height: 'auto',
                background: 'white',
                border: '5px solid red',
                borderRadius: '10px',
                boxShadow: '0 0 50px rgba(0,0,0,0.8)',
                zIndex: '999999',
                padding: '30px',
                display: 'block',
                fontSize: '16px',
                textAlign: 'center'
            });
            
            document.body.appendChild(modal);
            console.log('Simple modal created and added to DOM');
            
            // Scroll to make sure it's visible
            modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function setTaskRating(rating) {
            window.currentTaskRating.overallRating = rating;
            
            // Update button styles
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.fontWeight = 'normal';
            });
            
            const selectedBtn = document.querySelector(`[data-rating="${rating}"]`);
            if (selectedBtn) {
                selectedBtn.style.background = selectedBtn.style.borderColor;
                selectedBtn.style.color = 'white';
                selectedBtn.style.fontWeight = 'bold';
            }
        }

        function setChecklistItemRating(itemIndex, rating) {
            window.currentTaskRating.checklistRatings[itemIndex] = rating;
            
            // Update button styles for this item
            document.querySelectorAll(`[data-item="${itemIndex}"]`).forEach(btn => {
                btn.style.background = 'white';
                btn.style.fontWeight = 'normal';
            });
            
            const selectedBtn = document.querySelector(`[data-item="${itemIndex}"][data-rating="${rating}"]`);
            if (selectedBtn) {
                selectedBtn.style.background = selectedBtn.style.borderColor;
                selectedBtn.style.color = 'white';
                selectedBtn.style.fontWeight = 'bold';
            }
        }

        function closeTaskRatingModal() {
            console.log('Closing modal...');
            const modal = document.getElementById('taskRatingModal');
            if (modal) {
                modal.remove();
                console.log('Modal removed');
            }
        }

        function submitTaskRating(taskId, taskTitle, executorName) {
            const raterName = document.getElementById('ratingUserSelect').value;
            if (!raterName) {
                alert('Bitte w√§hle zuerst deinen Namen aus!');
                return;
            }
            
            if (!window.currentTaskRating.overallRating) {
                alert('Bitte gib eine Gesamtbewertung ab!');
                return;
            }
            
            const comments = document.getElementById('taskRatingComments').value;
            
            // Save rating data
            if (!taskQualityRatings) {
                window.taskQualityRatings = {};
            }
            
            if (!taskQualityRatings[taskId]) {
                taskQualityRatings[taskId] = {};
            }
            
            taskQualityRatings[taskId][raterName] = {
                overallRating: window.currentTaskRating.overallRating,
                checklistRatings: window.currentTaskRating.checklistRatings,
                comments: comments,
                ratedAt: new Date().toISOString(),
                executorName: executorName,
                taskTitle: taskTitle
            };
            
            // Save to localStorage
            localStorage.setItem('taskQualityRatings', JSON.stringify(taskQualityRatings));
            
            // üíæ Auto-Backup nach Qualit√§tsbewertung
            if (typeof performAutoBackup === 'function') {
                performAutoBackup('task_quality_rating');
            }
            
            closeTaskRatingModal();
            showSuccessToast(`‚úÖ Bewertung f√ºr "${taskTitle}" gespeichert!`);
            
            // Refresh the display
            buildRecentCompletedTasks();
        }

        function buildPendingRatingsList() {
            const container = document.getElementById('pendingRatingsList');
            const currentUser = getCurrentUser();
            const profileId = getCurrentProfileId();
            
            let pendingHtml = '';
            let pendingCount = 0;
            
            // Check all task executions for unrated tasks
            Object.entries(taskExecutions).forEach(([userName, userTasks]) => {
                if (userName === currentUser) return; // Don't rate your own tasks
                
                Object.entries(userTasks).forEach(([taskName, executions]) => {
                    executions.forEach(execution => {
                        if (execution.id && canUserRateTask(execution.id)) {
                            const daysAgo = Math.floor((Date.now() - new Date(execution.date).getTime()) / (1000 * 60 * 60 * 24));
                            pendingHtml += `
                                <div class="task-rating" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin: 10px 0; background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107;">
                                    <div>
                                        <div style="font-weight: bold;">${taskName}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.8;">Erledigt von ${userName} ‚Ä¢ vor ${daysAgo} Tag${daysAgo !== 1 ? 'en' : ''}</div>
                                    </div>
                                    <button class="rate-task-btn" onclick="openRatingModal('${execution.id}', '${taskName}', '${userName}')">
                                        <i class="fas fa-star"></i> Jetzt bewerten
                                    </button>
                                </div>
                            `;
                            pendingCount++;
                        }
                    });
                });
            });
            
            if (pendingCount === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">üéâ Alle Aufgaben bewertet!</div>';
            } else {
                container.innerHTML = `<div style="margin-bottom: 15px; font-weight: bold; color: #ffc107;">${pendingCount} ausstehende Bewertung${pendingCount !== 1 ? 'en' : ''}</div>` + pendingHtml;
            }
        }

        function buildRatingStatistics() {
            const container = document.getElementById('ratingStatistics');
            const profileId = getCurrentProfileId();
            const profileData = profiles[profileId];
            
            if (!profileData || !profileData.members) {
                container.innerHTML = '<div>Keine Statistiken verf√ºgbar</div>';
                return;
            }
            
            let statsHtml = '<div style="display: grid; gap: 15px;">';
            
            profileData.members.forEach(member => {
                const memberRatings = [];
                
                // Collect all ratings for this member
                if (allRatings[profileId]) {
                    Object.values(allRatings[profileId]).forEach(taskRatings => {
                        taskRatings.forEach(rating => {
                            if (rating.assignedTo === member) {
                                memberRatings.push(rating.rating);
                            }
                        });
                    });
                }
                
                const avgRating = memberRatings.length > 0 ? 
                    (memberRatings.reduce((sum, r) => sum + r, 0) / memberRatings.length).toFixed(1) : 
                    'N/A';
                
                const ratingCount = memberRatings.length;
                
                statsHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <div>
                            <div style="font-weight: bold;">${member}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${ratingCount} Bewertung${ratingCount !== 1 ? 'en' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="task-rating-stars" style="font-size: 1.2rem;">
                                ${avgRating !== 'N/A' ? getRatingStars(parseFloat(avgRating)) : '‚≠ê N/A'}
                            </div>
                            <div style="font-size: 0.9rem; font-weight: bold; color: #ffd700;">
                                ${avgRating !== 'N/A' ? avgRating + '/5' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            statsHtml += '</div>';
            container.innerHTML = statsHtml;
        }

        function buildRecentRatingsList() {
            const container = document.getElementById('recentRatingsList');
            const profileId = getCurrentProfileId();
            
            let allRecentRatings = [];
            
            if (allRatings[profileId]) {
                Object.values(allRatings[profileId]).forEach(taskRatings => {
                    allRecentRatings = allRecentRatings.concat(taskRatings);
                });
            }
            
            // Sort by date, newest first
            allRecentRatings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Take only last 10
            allRecentRatings = allRecentRatings.slice(0, 10);
            
            if (allRecentRatings.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.6;">Noch keine Bewertungen vorhanden</div>';
                return;
            }
            
            let recentHtml = '';
            allRecentRatings.forEach(rating => {
                const daysAgo = Math.floor((Date.now() - new Date(rating.date).getTime()) / (1000 * 60 * 60 * 24));
                recentHtml += `
                    <div style="padding: 15px; margin: 10px 0; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: bold;">${rating.taskName}</div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">
                                    ${rating.rater} bewertete ${rating.assignedTo} ‚Ä¢ vor ${daysAgo} Tag${daysAgo !== 1 ? 'en' : ''}
                                </div>
                                ${rating.comment ? `<div style="font-size: 0.9rem; margin-top: 5px; font-style: italic;">"${rating.comment}"</div>` : ''}
                            </div>
                            <div class="task-rating-stars">
                                ${getRatingStars(rating.rating)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = recentHtml;
        }

        // === PROFILE EDIT FUNCTIONS ===
        let currentEditProfileId = null;
        let editMemberCounter = 0;

        const defaultMemberIcons = ['üë®', 'üë©', 'üßë', 'üë¶', 'üëß', 'üßí', 'üë¥', 'üëµ', 'üôã‚Äç‚ôÇÔ∏è', 'üôã‚Äç‚ôÄÔ∏è', 'ü§µ', 'üë∞', 'üïµÔ∏è', 'üëÆ', 'üë∑', 'üíÇ', 'ü•∑', 'üë∏', 'ü§¥', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßö‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è'];

        function editProfile(profileId) {
            currentEditProfileId = profileId;
            const profile = wgProfiles[profileId];
            
            if (!profile) {
                alert('Profil nicht gefunden!');
                return;
            }
            
            // Show edit page
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('profileEdit').classList.remove('hidden');
            
            // Load profile data
            document.getElementById('editProfileName').value = profile.name || '';
            
            loadMemberEditList(profile);
            updateCurrentUserSelect(profile);
        }

        function loadMemberEditList(profile) {
            const container = document.getElementById('memberEditList');
            editMemberCounter = 0;
            
            let html = '';
            
            // Determine which member data to use
            let membersToLoad = [];
            
            // Check all possible data sources and use the most complete one
            if (profile.memberProfiles && Array.isArray(profile.memberProfiles) && profile.memberProfiles.length > 0) {
                // Use profile's memberProfiles if available and populated
                membersToLoad = profile.memberProfiles;
            } else if (window.memberProfiles && window.memberProfiles.length > 0) {
                // Use global memberProfiles if available
                membersToLoad = window.memberProfiles;
            } else if (profile.members && Array.isArray(profile.members) && profile.members.length > 0) {
                // Use profile's members array as fallback
                membersToLoad = profile.members;
            } else {
                // Last resort: create default members
                membersToLoad = ['Mitglied 1', 'Mitglied 2'];
            }
            
            // Load existing members
            if (membersToLoad.length > 0) {
                membersToLoad.forEach((member, index) => {
                    // Handle both object and string formats
                    let memberName, memberIcon;
                    
                    if (typeof member === 'string') {
                        memberName = member;
                        memberIcon = 'üë§';
                    } else if (member && typeof member === 'object') {
                        memberName = member.name || `Mitglied ${index + 1}`;
                        memberIcon = member.avatar || 'üë§';
                    } else {
                        memberName = `Mitglied ${index + 1}`;
                        memberIcon = 'üë§';
                    }
                    
                    // Ensure name is not empty
                    if (!memberName || memberName.trim() === '') {
                        memberName = `Mitglied ${index + 1}`;
                    }
                    
                    html += createMemberEditItem(editMemberCounter, memberName, memberIcon);
                    editMemberCounter++;
                });
            }
            
            // Add at least 2 members if none exist
            if (editMemberCounter === 0) {
                html += createMemberEditItem(editMemberCounter++, 'Mitglied 1', 'üë®');
                html += createMemberEditItem(editMemberCounter++, 'Mitglied 2', 'üë©');
            }
            
            container.innerHTML = html;
        }

        function createMemberEditItem(index, name = '', icon = 'üë§') {
            return `
                <div class="member-edit-item" data-member-index="${index}">
                    <div class="member-icon-selector">
                        <button class="member-icon-btn" onclick="toggleIconDropdown(${index})" data-icon="${icon}">
                            ${icon}
                        </button>
                        <div class="icon-dropdown" id="iconDropdown${index}">
                            <div class="icon-grid">
                                ${defaultMemberIcons.map(emoji => 
                                    `<div class="icon-option" onclick="selectMemberIcon(${index}, '${emoji}')">${emoji}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <input type="text" class="member-name-input" placeholder="Name des Mitglieds" value="${name}" data-member-name="${index}">
                    <button class="member-remove-btn" onclick="removeMember(${index})" ${editMemberCounter <= 2 ? 'disabled style="opacity: 0.5"' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function addNewMember() {
            const container = document.getElementById('memberEditList');
            const newMemberHtml = createMemberEditItem(editMemberCounter, `Mitglied ${editMemberCounter + 1}`, defaultMemberIcons[editMemberCounter % defaultMemberIcons.length]);
            container.insertAdjacentHTML('beforeend', newMemberHtml);
            editMemberCounter++;
            
            updateRemoveButtons();
            updateCurrentUserSelect();
        }

        function removeMember(index) {
            const memberItem = document.querySelector(`[data-member-index="${index}"]`);
            if (memberItem) {
                memberItem.remove();
                updateRemoveButtons();
                updateCurrentUserSelect();
            }
        }

        function updateRemoveButtons() {
            const memberItems = document.querySelectorAll('.member-edit-item');
            memberItems.forEach(item => {
                const removeBtn = item.querySelector('.member-remove-btn');
                if (memberItems.length <= 2) {
                    removeBtn.disabled = true;
                    removeBtn.style.opacity = '0.5';
                } else {
                    removeBtn.disabled = false;
                    removeBtn.style.opacity = '1';
                }
            });
        }

        function toggleIconDropdown(index) {
            // Close all other dropdowns
            document.querySelectorAll('.icon-dropdown').forEach(dropdown => {
                if (dropdown.id !== `iconDropdown${index}`) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            const dropdown = document.getElementById(`iconDropdown${index}`);
            dropdown.classList.toggle('show');
        }

        function selectMemberIcon(index, icon) {
            const button = document.querySelector(`[data-member-index="${index}"] .member-icon-btn`);
            button.textContent = icon;
            button.setAttribute('data-icon', icon);
            
            // Close dropdown
            document.getElementById(`iconDropdown${index}`).classList.remove('show');
        }

        function updateCurrentUserSelect(profile = null) {
            const select = document.getElementById('editCurrentUser');
            const memberItems = document.querySelectorAll('.member-edit-item');
            
            select.innerHTML = '';
            
            memberItems.forEach(item => {
                const nameInput = item.querySelector('.member-name-input');
                const memberName = nameInput.value.trim();
                
                if (memberName) {
                    const option = document.createElement('option');
                    option.value = memberName;
                    option.textContent = memberName;
                    select.appendChild(option);
                }
            });
            
            // Set current user if provided
            if (profile && profile.currentUser && select.querySelector(`option[value="${profile.currentUser}"]`)) {
                select.value = profile.currentUser;
            }
        }

        function saveProfileChanges() {
            if (!currentEditProfileId) return;
            
            const profileName = document.getElementById('editProfileName').value.trim();
            const whatsappContact = document.getElementById('editProfileWhatsapp').value.trim();
            const currentUser = document.getElementById('editCurrentUser').value;
            
            if (!profileName) {
                alert('Bitte gib einen Namen f√ºr die WG ein!');
                return;
            }
            
            // Collect members
            const memberItems = document.querySelectorAll('.member-edit-item');
            const members = [];
            const newMemberProfiles = [];
            
            memberItems.forEach(item => {
                const nameInput = item.querySelector('.member-name-input');
                const iconBtn = item.querySelector('.member-icon-btn');
                const memberName = nameInput.value.trim();
                const memberIcon = iconBtn.getAttribute('data-icon') || 'üë§';
                
                if (memberName) {
                    members.push(memberName);
                    newMemberProfiles.push({
                        name: memberName,
                        avatar: memberIcon
                    });
                }
            });
            
            if (members.length < 2) {
                alert('Eine WG braucht mindestens 2 Mitglieder!');
                return;
            }
            
            if (!members.includes(currentUser)) {
                alert('Der aktuelle Benutzer muss ein Mitglied der WG sein!');
                return;
            }
            
            // Preserve and merge existing ratings when names change
            const currentProfile = wgProfiles[currentEditProfileId];
            const oldMemberNames = currentProfile?.members || [];
            const newMemberNames = members;
            
            // Create mapping of old names to new names (by position/index)
            const nameMapping = {};
            oldMemberNames.forEach((oldName, index) => {
                if (newMemberNames[index] && oldName !== newMemberNames[index]) {
                    nameMapping[oldName] = newMemberNames[index];
                }
            });
            
            // Preserve and migrate ratings
            if (Object.keys(nameMapping).length > 0) {
                // Update memberTaskRatings
                Object.keys(nameMapping).forEach(oldName => {
                    const newName = nameMapping[oldName];
                    
                    if (memberTaskRatings[oldName]) {
                        // If new name already has ratings, merge them intelligently
                        if (memberTaskRatings[newName]) {
                            // Merge: Keep existing ratings for newName, add missing ones from oldName
                            Object.keys(memberTaskRatings[oldName]).forEach(taskTitle => {
                                if (!memberTaskRatings[newName][taskTitle]) {
                                    memberTaskRatings[newName][taskTitle] = memberTaskRatings[oldName][taskTitle];
                                }
                            });
                        } else {
                            // Simple rename: move all ratings to new name
                            memberTaskRatings[newName] = memberTaskRatings[oldName];
                        }
                        
                        // Remove old name entries
                        delete memberTaskRatings[oldName];
                    }
                });
                
                // Update allRatings structure as well
                Object.keys(nameMapping).forEach(oldName => {
                    const newName = nameMapping[oldName];
                    
                    if (allRatings[oldName]) {
                        if (allRatings[newName]) {
                            // Merge ratings intelligently
                            Object.keys(allRatings[oldName]).forEach(taskTitle => {
                                if (!allRatings[newName][taskTitle]) {
                                    allRatings[newName][taskTitle] = allRatings[oldName][taskTitle];
                                } else if (Array.isArray(allRatings[newName][taskTitle]) && Array.isArray(allRatings[oldName][taskTitle])) {
                                    // Merge arrays, avoiding duplicates
                                    allRatings[oldName][taskTitle].forEach(rating => {
                                        const exists = allRatings[newName][taskTitle].some(r => 
                                            r.rater === rating.rater && r.taskName === rating.taskName
                                        );
                                        if (!exists) {
                                            allRatings[newName][taskTitle].push({...rating, rater: newName});
                                        }
                                    });
                                }
                            });
                        } else {
                            allRatings[newName] = allRatings[oldName];
                            // Update rater names in the copied ratings
                            if (allRatings[newName]) {
                                Object.keys(allRatings[newName]).forEach(taskTitle => {
                                    if (Array.isArray(allRatings[newName][taskTitle])) {
                                        allRatings[newName][taskTitle].forEach(rating => {
                                            if (rating.rater === oldName) {
                                                rating.rater = newName;
                                            }
                                        });
                                    }
                                });
                            }
                        }
                        
                        delete allRatings[oldName];
                    }
                });
                
                // Save updated ratings
                localStorage.setItem('memberTaskRatings', JSON.stringify(memberTaskRatings));
                localStorage.setItem('allRatings', JSON.stringify(allRatings));
                
                // Show info about preserved ratings
                const renamedMembers = Object.keys(nameMapping);
                if (renamedMembers.length > 0) {
                    const renames = renamedMembers.map(old => `${old} ‚Üí ${nameMapping[old]}`).join(', ');
                    console.log(`‚ÑπÔ∏è Bewertungen √ºbertragen: ${renames}`);
                    
                    // Check if any ratings were merged (not just renamed)
                    const mergedCount = renamedMembers.filter(oldName => {
                        const newName = nameMapping[oldName];
                        return members.filter(m => m === newName).length > 1; // Name appears multiple times
                    });
                    
                    if (mergedCount.length > 0) {
                        alert(`‚ÑπÔ∏è Namen ge√§ndert und Bewertungen erhalten!\n\n√úbertragen: ${renames}\n\nBestehende Bewertungen wurden intelligent zusammengef√ºhrt - keine Daten verloren!`);
                    } else {
                        // Simple rename without conflicts
                        showSuccessToast(`‚úÖ Namen aktualisiert - alle Bewertungen erhalten!`);
                    }
                }
            }
            
            // Update profile
            wgProfiles[currentEditProfileId] = {
                ...wgProfiles[currentEditProfileId],
                name: profileName,
                whatsappContact: whatsappContact,
                members: members,
                memberProfiles: newMemberProfiles,
                currentUser: currentUser,
                lastUsed: new Date().toISOString()
            };
            
            // If this is the current active profile, update global variables too
            const currentActiveProfile = getCurrentProfileId();
            if (currentActiveProfile === currentEditProfileId) {
                // Update global variables
                wgName = profileName;
                memberNames = members;
                memberProfiles = [...newMemberProfiles];
                currentUserName = currentUser;
                
                // Update localStorage for global variables
                localStorage.setItem('wgName', wgName);
                localStorage.setItem('memberNames', JSON.stringify(memberNames));
                localStorage.setItem('memberProfiles', JSON.stringify(memberProfiles));
                localStorage.setItem('currentUserName', currentUserName);
            }
            
            // Save to localStorage
            localStorage.setItem('wgProfiles', JSON.stringify(wgProfiles));
            syncProfiles();
            
            alert('Profil erfolgreich gespeichert!');
            showProfileSelection();
        }

        function cancelProfileEdit() {
            showProfileSelection();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.member-icon-selector')) {
                document.querySelectorAll('.icon-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Update current user select when member names change
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('member-name-input')) {
                updateCurrentUserSelect();
            }
        });

        // Rating functions global
        window.openRatingModal = openRatingModal;
        window.closeRatingModal = closeRatingModal;
        window.submitDetailedRating = submitDetailedRating;
        window.showRatingOverview = showRatingOverview;
        window.updatePointsPreview = updatePointsPreview;
        
        // === RATE TASKS SYSTEM ===
        let currentRatingMember = null;
        let currentRatingTaskIndex = 0;
        let memberTaskRatings = {}; // Structure: {memberName: {taskName: {minutes, pain, importance, frequency, points}}}

        function showRateTasks() {
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('rateTasks').classList.remove('hidden');
            
            loadMemberRatingGrid();
            updateRatingProgress();
        }

        function loadMemberRatingGrid() {
            const grid = document.getElementById('rateMemberGrid');
            
            if (!memberProfiles || memberProfiles.length === 0) {
                grid.innerHTML = '<p>Keine Mitglieder gefunden. Bitte erst WG einrichten.</p>';
                return;
            }
            
            let html = '';
            memberProfiles.forEach(memberProfile => {
                const memberName = memberProfile.name;
                const avatar = memberProfile.avatar || 'üë§';
                
                // Check how many tasks this member has rated
                const ratedCount = getRatedTasksCount(memberName);
                const totalTasks = tasks ? tasks.length : 0;
                const isComplete = ratedCount >= totalTasks;
                
                const statusIcon = isComplete ? '‚úÖ' : (ratedCount > 0 ? '‚è≥' : '‚≠ï');
                const statusText = isComplete ? 'Abgeschlossen' : (ratedCount > 0 ? `${ratedCount}/${totalTasks} Tasks` : 'Nicht begonnen');
                
                html += `
                    <div class="member-rating-card ${isComplete ? 'completed' : ''}" onclick="startMemberRating('${memberName}')">
                        <div class="member-info">
                            <div class="member-avatar" style="font-size: 2rem;">${avatar}</div>
                            <div class="member-details">
                                <h4 class="font-bold">${memberName}</h4>
                                <div class="rating-status">
                                    ${statusIcon} ${statusText}
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalTasks > 0 ? (ratedCount / totalTasks) * 100 : 0}%"></div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function getRatedTasksCount(memberName) {
            // Count only ratings for this specific member
            if (!memberTaskRatings[memberName]) {
                return 0;
            }
            
            return Object.keys(memberTaskRatings[memberName]).length;
        }

        function updateRatingProgress() {
            const container = document.getElementById('ratingProgress');
            const profileId = getCurrentProfileId();
            const profileData = profiles[profileId];
            
            if (!profileData || !profileData.members) return;
            
            let totalMembers = profileData.members.length;
            let completedMembers = 0;
            let totalRatings = 0;
            
            profileData.members.forEach(memberName => {
                const ratedCount = getRatedTasksCount(memberName);
                totalRatings += ratedCount;
                if (ratedCount >= tasks.length) {
                    completedMembers++;
                }
            });
            
            const allCompleted = completedMembers >= totalMembers && totalMembers > 0;
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Abgeschlossene Mitglieder: ${completedMembers}/${totalMembers}</span>
                    <span>Gesamt Bewertungen: ${totalRatings}/${totalMembers * tasks.length}</span>
                </div>
                <div class="progress-bar" style="height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px;">
                    <div class="progress-fill" style="height: 100%; background: #10b981; border-radius: 4px; width: ${totalMembers > 0 ? (completedMembers / totalMembers) * 100 : 0}%"></div>
                </div>
                ${allCompleted ? '<div style="color: #10b981; font-weight: bold; margin-top: 10px;">üéâ Alle Bewertungen abgeschlossen!</div>' : ''}
            `;
            
            // Show calculate button if all completed
            const calcButton = document.getElementById('calculatePointsBtn');
            if (allCompleted) {
                calcButton.style.display = 'block';
            } else {
                calcButton.style.display = 'none';
            }
        }

        function startMemberRating(memberName) {
            currentRatingMember = memberName;
            currentRatingTaskIndex = 0;
            
            // Initialize member ratings if not exists - ensure it's separate per member
            if (!memberTaskRatings[memberName]) {
                memberTaskRatings[memberName] = {};
            }
            
            // Show individual rating page
            document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
            document.getElementById('individualTaskRating').classList.remove('hidden');
            
            // Update header
            document.getElementById('currentRaterName').textContent = memberName;
            document.getElementById('raterNameTitle').textContent = memberName;
            
            // Load first task
            loadCurrentTask();
        }

        function loadCurrentTask() {
            if (currentRatingTaskIndex < 0 || currentRatingTaskIndex >= tasks.length) return;
            
            const task = tasks[currentRatingTaskIndex];
            
            // Update task info
            document.getElementById('currentTaskEmoji').textContent = task.emoji || 'üìã';
            document.getElementById('currentTaskName').textContent = task.title;
            document.getElementById('currentTaskDescription').textContent = task.description || 'Keine Beschreibung';
            
            // Update progress
            document.getElementById('taskProgressIndicator').innerHTML = `
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                    Task ${currentRatingTaskIndex + 1} von ${tasks.length}
                    <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; margin-top: 5px;">
                        <div class="progress-fill" style="height: 100%; background: #10b981; border-radius: 3px; width: ${((currentRatingTaskIndex + 1) / tasks.length) * 100}%"></div>
                    </div>
                </div>
            `;
            
            // Load existing ratings or defaults - only for current member
            const existingRating = memberTaskRatings[currentRatingMember] && memberTaskRatings[currentRatingMember][task.title];
            
            if (existingRating) {
                // Load existing values for this specific member
                document.getElementById('currentMinutesSlider').value = existingRating.minutes || 30;
                document.getElementById('currentPainSlider').value = existingRating.pain || 5;
                document.getElementById('currentImportanceSlider').value = existingRating.importance || 7;
                document.getElementById('currentFrequencySlider').value = existingRating.frequency || 4;
            } else {
                // Default values (no existing rating for this member)
                document.getElementById('currentMinutesSlider').value = 30;
                document.getElementById('currentPainSlider').value = 5;
                document.getElementById('currentImportanceSlider').value = 7;
                document.getElementById('currentFrequencySlider').value = 4;
            }
            
            // Update all displays
            updateCurrentValue('currentMinutesValue', document.getElementById('currentMinutesSlider').value);
            updateCurrentValue('currentPainValue', document.getElementById('currentPainSlider').value);
            updateCurrentValue('currentImportanceValue', document.getElementById('currentImportanceSlider').value);
            updateCurrentValue('currentFrequencyValue', document.getElementById('currentFrequencySlider').value);
            
            // Update navigation buttons
            document.getElementById('prevTaskBtn').style.display = currentRatingTaskIndex > 0 ? 'block' : 'none';
            document.getElementById('nextTaskBtn').textContent = 
                currentRatingTaskIndex < tasks.length - 1 ? 'N√§chster' : 'Fertig';
        }

        function updateCurrentValue(elementId, value) {
            document.getElementById(elementId).textContent = value;
            updateCurrentTaskPoints();
        }

        function updateCurrentTaskPoints() {
            const minutes = parseInt(document.getElementById('currentMinutesSlider').value);
            const pain = parseInt(document.getElementById('currentPainSlider').value);
            const importance = parseInt(document.getElementById('currentImportanceSlider').value);
            const frequency = parseInt(document.getElementById('currentFrequencySlider').value);
            
            const taskPoints = calculateTaskPoints(minutes, pain, importance, frequency);
            const monthlyPoints = taskPoints * frequency;
            
            document.getElementById('currentTaskPoints').textContent = taskPoints;
            document.getElementById('currentMonthlyPoints').textContent = monthlyPoints;
        }

        function nextTask() {
            // Save current rating
            saveCurrentTaskRating();
            
            if (currentRatingTaskIndex < tasks.length - 1) {
                currentRatingTaskIndex++;
                loadCurrentTask();
            } else {
                // Finished all tasks
                finishMemberRating();
            }
        }

        function previousTask() {
            if (currentRatingTaskIndex > 0) {
                saveCurrentTaskRating();
                currentRatingTaskIndex--;
                loadCurrentTask();
            }
        }

        function saveCurrentTaskRating() {
            const task = tasks[currentRatingTaskIndex];
            const minutes = parseInt(document.getElementById('currentMinutesSlider').value);
            const pain = parseInt(document.getElementById('currentPainSlider').value);
            const importance = parseInt(document.getElementById('currentImportanceSlider').value);
            const frequency = parseInt(document.getElementById('currentFrequencySlider').value);
            
            const points = calculateTaskPoints(minutes, pain, importance, frequency);
            
            // Ensure member has their own separate rating object
            if (!memberTaskRatings[currentRatingMember]) {
                memberTaskRatings[currentRatingMember] = {};
            }
            
            // Save rating ONLY for the current member
            memberTaskRatings[currentRatingMember][task.title] = {
                minutes,
                pain,
                importance,
                frequency,
                points,
                date: new Date().toISOString(),
                ratedBy: currentRatingMember  // Add marker for who rated this
            };
            
            // Save to allRatings structure as well for compatibility
            const saveProfile = getCurrentProfileId();
            if (!allRatings[saveProfile]) allRatings[saveProfile] = {};
            if (!allRatings[saveProfile][task.title]) allRatings[saveProfile][task.title] = [];
            
            // Update or add rating
            const existingIndex = allRatings[saveProfile][task.title].findIndex(r => r.rater === currentRatingMember);
            const ratingData = {
                rater: currentRatingMember,
                minutes,
                pain,
                importance,
                frequency,
                points,
                date: new Date().toISOString(),
                taskName: task.title
            };
            
            if (existingIndex >= 0) {
                allRatings[saveProfile][task.title][existingIndex] = ratingData;
            } else {
                allRatings[saveProfile][task.title].push(ratingData);
            }
            
            // Save to localStorage
            localStorage.setItem('memberTaskRatings', JSON.stringify(memberTaskRatings));
            localStorage.setItem('allRatings', JSON.stringify(allRatings));
            
            // üíæ Auto-Backup nach Bewertungs-Update
            if (typeof performAutoBackup === 'function') {
                performAutoBackup('member_task_ratings');
            }
            
            // Update displays if visible
            const taskTablePhase = document.getElementById('taskTable');
            if (taskTablePhase && !taskTablePhase.classList.contains('hidden')) {
                buildTaskTable();
            }
            
            const dashboardPhase = document.getElementById('phaseComplete');
            if (dashboardPhase && !dashboardPhase.classList.contains('hidden')) {
                updateDashboardStats();
            }
        }

        function finishMemberRating() {
            alert(`‚úÖ ${currentRatingMember} hat alle Tasks bewertet!`);
            showRateTasks();
        }

        function cancelTaskRating() {
            showRateTasks();
        }

        function calculateMonthlyPointsFromRatings() {
            // Calculate average monthly points for each member based on all ratings
            const profileId = getCurrentProfileId();
            const profileData = profiles[profileId];
            
            if (!profileData) return;
            
            let memberMonthlyTargets = {};
            
            // Calculate for each task
            tasks.forEach(task => {
                let totalMonthlyPoints = 0;
                let ratingCount = 0;
                
                // Average all member ratings for this task
                profileData.members.forEach(memberName => {
                    if (memberTaskRatings[memberName] && memberTaskRatings[memberName][task.title]) {
                        const rating = memberTaskRatings[memberName][task.title];
                        totalMonthlyPoints += rating.points * rating.frequency;
                        ratingCount++;
                    }
                });
                
                if (ratingCount > 0) {
                    const avgMonthlyPoints = Math.round(totalMonthlyPoints / ratingCount);
                    
                    // Distribute among members
                    profileData.members.forEach(memberName => {
                        if (!memberMonthlyTargets[memberName]) memberMonthlyTargets[memberName] = 0;
                        memberMonthlyTargets[memberName] += Math.round(avgMonthlyPoints / profileData.members.length);
                    });
                }
            });
            
            // Save monthly targets
            localStorage.setItem(`monthlyTargets_${profileId}`, JSON.stringify(memberMonthlyTargets));
            
            // Show results
            let resultText = 'üéØ Monatliche Punkt-Ziele berechnet:\n\n';
            Object.entries(memberMonthlyTargets).forEach(([memberName, points]) => {
                resultText += `${memberName}: ${points} Punkte/Monat\n`;
            });
            
            alert(resultText);
            
            // Go back to dashboard
            showDashboard();
        }

        // Load existing ratings on startup
        try {
            const savedMemberRatings = localStorage.getItem('memberTaskRatings');
            if (savedMemberRatings) {
                memberTaskRatings = JSON.parse(savedMemberRatings);
            }
        } catch(e) {
            console.log('Keine gespeicherten Member-Ratings gefunden');
        }

        // Profile edit functions global
        window.editProfile = editProfile;
        window.addNewMember = addNewMember;
        window.removeMember = removeMember;
        window.toggleIconDropdown = toggleIconDropdown;
        window.selectMemberIcon = selectMemberIcon;
        window.saveProfileChanges = saveProfileChanges;
        window.cancelProfileEdit = cancelProfileEdit;
        
        // Rate tasks functions global
        window.showRateTasks = showRateTasks;
        window.startMemberRating = startMemberRating;
        window.nextTask = nextTask;
        window.previousTask = previousTask;
        window.cancelTaskRating = cancelTaskRating;
        window.updateCurrentValue = updateCurrentValue;
        window.calculateMonthlyPointsFromRatings = calculateMonthlyPointsFromRatings;

        console.log('üåç Alle Funktionen global verf√ºgbar gemacht');
        
        // ========================================
        // üíæ BACKUP & RESTORE SYSTEM
        // ========================================
        
        // Auto-Backup Configuration
        let autoBackupEnabled = true;
        const maxBackups = 10; // Keep last 10 auto-backups
        
        // Complete data collection for backup
        function collectAllAppData() {
            console.log('üìä Collecting all app data for backup...');
            
            const data = {
                // Metadata
                backupVersion: '1.0',
                appVersion: 'Putzplan PWA v2.0',
                timestamp: new Date().toISOString(),
                
                // Core data
                profiles: profiles || {},
                tasks: tasks || [],
                allRatings: allRatings || {},
                memberTaskRatings: memberTaskRatings || {},
                
                // Additional data
                completedTasks: JSON.parse(localStorage.getItem('completedTasks') || '[]'),
                taskQualityRatings: JSON.parse(localStorage.getItem('taskQualityRatings') || '[]'),
                
                // Settings and state
                currentProfileId: getCurrentProfileId(),
                navigationHistory: navigationHistory || [],
                
                // All localStorage data (as fallback)
                localStorage: {}
            };
            
            // Collect all relevant localStorage keys
            const relevantKeys = [
                'profiles', 'tasks', 'allRatings', 'memberTaskRatings',
                'completedTasks', 'taskQualityRatings', 'currentProfileId',
                'autoBackupEnabled'
            ];
            
            // Add monthly targets and absence data for all profiles
            Object.keys(profiles || {}).forEach(profileId => {
                relevantKeys.push(`monthlyTargets_${profileId}`);
                relevantKeys.push(`absence_${profileId}`);
            });
            
            // Collect localStorage data
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    data.localStorage[key] = value;
                }
            });
            
            console.log('üì¶ Backup data collected:', Object.keys(data));
            return data;
        }
        
        // Auto-backup function (called after important changes)
        function performAutoBackup(operation = 'unknown') {
            if (!autoBackupEnabled) return;
            
            try {
                console.log(`üíæ Performing auto-backup after: ${operation}`);
                
                const backupData = collectAllAppData();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupKey = `autoBackup_${timestamp}`;
                
                // Store backup
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Update backup list
                let backupList = JSON.parse(localStorage.getItem('backupList') || '[]');
                backupList.push({
                    key: backupKey,
                    timestamp: backupData.timestamp,
                    operation: operation,
                    size: JSON.stringify(backupData).length
                });
                
                // Keep only recent backups
                backupList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (backupList.length > maxBackups) {
                    const oldBackups = backupList.slice(maxBackups);
                    oldBackups.forEach(backup => {
                        localStorage.removeItem(backup.key);
                    });
                    backupList = backupList.slice(0, maxBackups);
                }
                
                localStorage.setItem('backupList', JSON.stringify(backupList));
                console.log(`‚úÖ Auto-backup created: ${backupKey}`);
                
            } catch (error) {
                console.error('‚ùå Auto-backup failed:', error);
            }
        }
        
        // Manual export function
        function exportAppData() {
            try {
                console.log('üì§ Starting manual data export...');
                
                const backupData = collectAllAppData();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `putzplan-backup-${timestamp}.json`;
                
                // Create download
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create temporary download link
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                URL.revokeObjectURL(url);
                
                showSuccessToast(`üì¶ Backup exportiert: ${filename}`);
                console.log('‚úÖ Export completed successfully');
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                showErrorToast('Export fehlgeschlagen: ' + error.message);
            }
        }
        
        // Import and restore function
        function importAppData(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            console.log('üì• Starting data import from:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup data
                    if (!backupData.backupVersion || !backupData.timestamp) {
                        throw new Error('Ung√ºltige Backup-Datei');
                    }
                    
                    // Show confirmation dialog
                    const confirmMessage = `
üîÑ Backup wiederherstellen?

üìÖ Erstellt: ${new Date(backupData.timestamp).toLocaleString()}
üì± App Version: ${backupData.appVersion || 'Unbekannt'}
üë• Profile: ${Object.keys(backupData.profiles || {}).length}
üìã Tasks: ${(backupData.tasks || []).length}

‚ö†Ô∏è WARNUNG: Alle aktuellen Daten werden √ºberschrieben!
                    `;
                    
                    if (!confirm(confirmMessage)) {
                        console.log('‚ùå Import cancelled by user');
                        return;
                    }
                    
                    // Create safety backup before import
                    performAutoBackup('before_import');
                    
                    // Restore data
                    restoreFromBackupData(backupData);
                    
                    showSuccessToast('üéâ Backup erfolgreich wiederhergestellt!');
                    
                    // Reload page to refresh everything
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Import failed:', error);
                    showErrorToast('Import fehlgeschlagen: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Restore data from backup object
        function restoreFromBackupData(backupData) {
            console.log('üîÑ Restoring data from backup...');
            
            try {
                // Restore core data structures
                if (backupData.profiles) {
                    profiles = backupData.profiles;
                    localStorage.setItem('profiles', JSON.stringify(profiles));
                }
                
                if (backupData.tasks) {
                    tasks = backupData.tasks;
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                }
                
                if (backupData.allRatings) {
                    allRatings = backupData.allRatings;
                    localStorage.setItem('allRatings', JSON.stringify(allRatings));
                }
                
                if (backupData.memberTaskRatings) {
                    memberTaskRatings = backupData.memberTaskRatings;
                    localStorage.setItem('memberTaskRatings', JSON.stringify(memberTaskRatings));
                }
                
                // Restore all localStorage data
                if (backupData.localStorage) {
                    Object.entries(backupData.localStorage).forEach(([key, value]) => {
                        localStorage.setItem(key, value);
                    });
                }
                
                console.log('‚úÖ Data restoration completed');
                
            } catch (error) {
                console.error('‚ùå Data restoration failed:', error);
                throw error;
            }
        }
        
        // Emergency restore function (offers latest backup on startup)
        function checkForEmergencyRestore() {
            try {
                const backupList = JSON.parse(localStorage.getItem('backupList') || '[]');
                const lastCrashCheck = localStorage.getItem('lastCrashCheck');
                const lastAppSession = localStorage.getItem('lastAppSession');
                const now = new Date().getTime();
                
                // Check if app was properly closed (set flag on beforeunload)
                const wasProperlyCloseds = localStorage.getItem('properlyCloseds');
                
                // More intelligent crash detection:
                // 1. Must not have been properly closed
                // 2. Must have backups available  
                // 3. Must be significant time gap (5+ minutes) since last session
                // 4. Must not have checked recently (prevent multiple prompts)
                
                const timeSinceLastSession = lastAppSession ? (now - parseInt(lastAppSession)) : 0;
                const timeSinceLastCheck = lastCrashCheck ? (now - parseInt(lastCrashCheck)) : Infinity;
                
                // Check if crash detection is disabled
                const crashDetectionDisabled = localStorage.getItem('disableCrashDetection') === 'true';
                
                const shouldOfferRestore = (
                    !crashDetectionDisabled &&
                    !wasProperlyCloseds && 
                    backupList.length > 0 && 
                    timeSinceLastSession > 5 * 60 * 1000 && // 5 minutes gap
                    timeSinceLastCheck > 60 * 60 * 1000     // 1 hour since last check
                );
                
                if (shouldOfferRestore) {
                    const latestBackup = backupList[0];
                    const backupAge = now - new Date(latestBackup.timestamp).getTime();
                    
                    // Only offer restore if backup is recent (within 24 hours) and older than 5 minutes
                    if (backupAge < 24 * 60 * 60 * 1000 && backupAge > 5 * 60 * 1000) {
                        const restoreMessage = `
üö® M√∂glicher App-Crash erkannt!

üì± Letzte Sicherung verf√ºgbar:
üìÖ ${new Date(latestBackup.timestamp).toLocaleString()}
üìÑ Operation: ${latestBackup.operation}

üíæ M√∂chten Sie die letzte Sicherung wiederherstellen?

‚ö†Ô∏è W√§hlen Sie "Abbrechen" wenn die App normal funktioniert.
                        `;
                        
                        if (confirm(restoreMessage)) {
                            const backupData = JSON.parse(localStorage.getItem(latestBackup.key));
                            restoreFromBackupData(backupData);
                            showSuccessToast('üîÑ Letzte Sicherung wiederhergestellt');
                            location.reload();
                            return;
                        }
                    }
                }
                
                // Set crash check timestamp and session marker
                localStorage.setItem('lastCrashCheck', now.toString());
                localStorage.setItem('lastAppSession', now.toString());
                
            } catch (error) {
                console.error('‚ùå Emergency restore check failed:', error);
            }
        }
        
        // Set proper close flag and update session
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('properlyCloseds', 'true');
            localStorage.setItem('lastAppSession', new Date().getTime().toString());
        });
        
        // Clear properly closed flag on app start (reset for next session)
        setTimeout(() => {
            localStorage.removeItem('properlyCloseds');
        }, 1000);
        
        // Debug functions for crash detection (available in console)
        window.disableCrashDetection = function() {
            localStorage.setItem('disableCrashDetection', 'true');
            console.log('‚úÖ Crash-Detection deaktiviert');
        };
        
        window.enableCrashDetection = function() {
            localStorage.removeItem('disableCrashDetection');
            console.log('‚úÖ Crash-Detection aktiviert');
        };
        
        window.resetCrashDetection = function() {
            localStorage.removeItem('lastCrashCheck');
            localStorage.removeItem('lastAppSession');
            localStorage.removeItem('properlyCloseds');
            console.log('üîÑ Crash-Detection zur√ºckgesetzt');
        };
        
        // Debug functions for rating system testing
        window.showRatingsSummary = function() {
            console.log('üìä BEWERTUNGS√úBERSICHT DARIUS WG');
            console.log('================================');
            
            if (!memberTaskRatings || Object.keys(memberTaskRatings).length === 0) {
                console.log('‚ùå Keine Bewertungen gefunden. F√ºhren Sie zuerst setupRealWG() aus.');
                return;
            }
            
            Object.keys(memberTaskRatings).forEach(memberName => {
                console.log(`\nüë§ ${memberName}:`);
                const memberRatings = memberTaskRatings[memberName];
                
                Object.keys(memberRatings).forEach(taskTitle => {
                    const rating = memberRatings[taskTitle];
                    console.log(`  üìã ${taskTitle}:`);
                    console.log(`     ‚è∞ ${rating.minutes}min | üò∞ Pain ${rating.pain}/10 | ‚≠ê Wichtigkeit ${rating.importance}/10 | üîÑ H√§ufigkeit ${rating.frequency} | üí∞ ${rating.points}P`);
                });
            });
            
            console.log('\nüí° Verwenden Sie testTaskPoints() f√ºr Punkteberechnung-Tests');
        };
        
        window.testTaskPoints = function() {
            console.log('üßÆ PUNKTEBERECHNUNG TEST');
            console.log('========================');
            
            const testCases = [
                { task: 'K√ºche putzen', member: 'Lilly' },
                { task: 'Badezimmer putzen', member: 'Darius' },
                { task: 'M√ºll rausbringen', member: 'Hamza Hamza' },
                { task: 'Staubsaugen', member: 'Sofia' }
            ];
            
            testCases.forEach(testCase => {
                if (memberTaskRatings[testCase.member] && memberTaskRatings[testCase.member][testCase.task]) {
                    const rating = memberTaskRatings[testCase.member][testCase.task];
                    const calculatedPoints = Math.round((rating.minutes + (rating.minutes * rating.pain / 10)) * rating.importance);
                    
                    console.log(`\n${testCase.member} ‚Üí ${testCase.task}:`);
                    console.log(`  Input: ${rating.minutes}min, Pain ${rating.pain}, Wichtigkeit ${rating.importance}`);
                    console.log(`  NEUE Formel: (${rating.minutes} + (${rating.minutes} √ó ${rating.pain} / 10)) √ó ${rating.importance} = ${calculatedPoints}P`);
                    console.log(`  Gespeichert: ${rating.points}P ${calculatedPoints === rating.points ? '‚úÖ' : '‚ùå'}`);
                }
            });
        };
        
        window.setupTestRatings = function() {
            console.log('üè† Richte Darius WG mit Test-Bewertungen ein...');
            setupRealWG();
            setTimeout(() => {
                showRatingsSummary();
                console.log('\n‚úÖ Test-Setup komplett! √úberpr√ºfen Sie die App!');
            }, 1000);
        };
        
        // Remove proper close flag on startup
        localStorage.removeItem('properlyCloseds');
        
        // Show backup list
        function showBackupList() {
            try {
                const backupList = JSON.parse(localStorage.getItem('backupList') || '[]');
                
                if (backupList.length === 0) {
                    alert('üì¶ Keine automatischen Sicherungen gefunden.');
                    return;
                }
                
                let listText = 'üíæ Verf√ºgbare Auto-Backups:\n\n';
                backupList.forEach((backup, index) => {
                    const date = new Date(backup.timestamp).toLocaleString();
                    const size = Math.round(backup.size / 1024);
                    listText += `${index + 1}. ${date}\n   üìÑ ${backup.operation} (${size} KB)\n\n`;
                });
                
                listText += '\nüí° Tipp: Verwenden Sie "Daten exportieren" f√ºr manuelle Backups.';
                alert(listText);
                
            } catch (error) {
                console.error('‚ùå Failed to show backup list:', error);
                alert('Fehler beim Laden der Backup-Liste.');
            }
        }
        
        // Test backup function
        function testAutoBackup() {
            try {
                console.log('üß™ Running backup test...');
                performAutoBackup('manual_test');
                
                // Show backup list after creating test backup
                setTimeout(() => {
                    const backupList = JSON.parse(localStorage.getItem('backupList') || '[]');
                    const latestBackup = backupList[0];
                    
                    if (latestBackup && latestBackup.operation === 'manual_test') {
                        showSuccessToast(`‚úÖ Test-Backup erfolgreich erstellt!\nüìÖ ${new Date(latestBackup.timestamp).toLocaleString()}`);
                    } else {
                        showErrorToast('‚ùå Test-Backup konnte nicht erstellt werden');
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Test backup failed:', error);
                showErrorToast('Test-Backup fehlgeschlagen: ' + error.message);
            }
        }
        
        // Override existing save functions to include auto-backup
        const originalSaveProfiles = window.saveProfiles || (() => {});
        const originalSaveTasks = window.saveTasks || (() => {});
        
        function saveProfilesWithBackup() {
            originalSaveProfiles();
            performAutoBackup('profile_update');
        }
        
        function saveTasksWithBackup() {
            originalSaveTasks();
            performAutoBackup('tasks_update');
        }
        
        // Make backup functions globally available
        window.exportAppData = exportAppData;
        window.importAppData = importAppData;
        window.showBackupList = showBackupList;
        window.testAutoBackup = testAutoBackup;
        window.performAutoBackup = performAutoBackup;
        window.checkForEmergencyRestore = checkForEmergencyRestore;
        
        console.log('üíæ Backup & Restore System loaded');
        
        // ========================================
        // üë• TEMPOR√ÑRE BEWOHNER SYSTEM
        // ========================================
        
        // Global variable for temporary residents
        let temporaryResidents = [];
        let selectedTempIcon = 'üë§';
        
        // Load temporary residents from localStorage
        function loadTemporaryResidents() {
            try {
                const saved = localStorage.getItem('temporaryResidents');
                if (saved) {
                    temporaryResidents = JSON.parse(saved);
                }
            } catch (error) {
                console.error('‚ùå Error loading temporary residents:', error);
                temporaryResidents = [];
            }
        }
        
        // Save temporary residents to localStorage
        function saveTemporaryResidents() {
            try {
                localStorage.setItem('temporaryResidents', JSON.stringify(temporaryResidents));
                
                // Auto-backup after changes
                if (typeof performAutoBackup === 'function') {
                    performAutoBackup('temporary_residents');
                }
            } catch (error) {
                console.error('‚ùå Error saving temporary residents:', error);
            }
        }
        
        // Icon selection for temporary person
        function selectTempPersonIcon(icon) {
            selectedTempIcon = icon;
            document.getElementById('selectedTempIcon').value = icon;
            
            // Update visual selection
            document.querySelectorAll('.temp-icon-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-icon="${icon}"]`).classList.add('selected');
        }
        
        // Add new temporary person
        function addTemporaryPerson() {
            const name = document.getElementById('tempPersonName').value.trim();
            const startDate = document.getElementById('tempPersonStartDate').value;
            const endDate = document.getElementById('tempPersonEndDate').value;
            const icon = selectedTempIcon;
            
            // Validation
            if (!name) {
                showErrorToast('‚ùå Bitte geben Sie einen Namen ein');
                return;
            }
            
            if (!startDate || !endDate) {
                showErrorToast('‚ùå Bitte w√§hlen Sie Start- und Enddatum');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                showErrorToast('‚ùå Enddatum muss nach Startdatum liegen');
                return;
            }
            
            // Check for name conflicts
            const currentProfile = getCurrentProfileId();
            const profile = profiles[currentProfile];
            if (profile && profile.members.some(member => member.toLowerCase() === name.toLowerCase())) {
                showErrorToast('‚ùå Name bereits als permanenter Bewohner vorhanden');
                return;
            }
            
            // Create temporary resident object
            const tempResident = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: name,
                icon: icon,
                startDate: startDate,
                endDate: endDate,
                profileId: currentProfile,
                addedAt: new Date().toISOString()
            };
            
            temporaryResidents.push(tempResident);
            saveTemporaryResidents();
            
            // Clear form
            document.getElementById('tempPersonName').value = '';
            document.getElementById('tempPersonStartDate').value = '';
            document.getElementById('tempPersonEndDate').value = '';
            selectTempPersonIcon('üë§');
            
            // Refresh display
            buildTemporaryResidentsList();
            updateDashboardStats(); // Update dashboard with new person
            
            showSuccessToast(`‚úÖ ${name} als tempor√§rer Bewohner hinzugef√ºgt!`);
        }
        
        // Check if temporary person is active on a specific date
        function isTemporaryPersonActive(tempResident, checkDate = new Date()) {
            const check = typeof checkDate === 'string' ? new Date(checkDate) : checkDate;
            const start = new Date(tempResident.startDate);
            const end = new Date(tempResident.endDate);
            
            return check >= start && check <= end;
        }
        
        // Get active temporary residents for current profile and date
        function getActiveTemporaryResidents(date = new Date()) {
            const currentProfile = getCurrentProfileId();
            return temporaryResidents.filter(resident => 
                resident.profileId === currentProfile && isTemporaryPersonActive(resident, date)
            );
        }
        
        // Get all temporary residents for current profile (active + past)
        function getAllTemporaryResidents() {
            const currentProfile = getCurrentProfileId();
            return temporaryResidents.filter(resident => resident.profileId === currentProfile);
        }
        
        // Build temporary residents list display
        function buildTemporaryResidentsList() {
            const activeContainer = document.getElementById('temporaryPersonsList');
            const pastContainer = document.getElementById('pastTemporaryPersonsList');
            
            if (!activeContainer || !pastContainer) return;
            
            const allResidents = getAllTemporaryResidents();
            const now = new Date();
            
            const activeResidents = allResidents.filter(r => isTemporaryPersonActive(r, now));
            const pastResidents = allResidents.filter(r => !isTemporaryPersonActive(r, now));
            
            // Active residents
            if (activeResidents.length === 0) {
                activeContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-user-clock" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <div>Keine aktiven tempor√§ren Bewohner</div>
                    </div>
                `;
            } else {
                let activeHtml = '<div style="display: grid; gap: 12px;">';
                activeResidents.forEach(resident => {
                    const daysLeft = Math.ceil((new Date(resident.endDate) - now) / (1000 * 60 * 60 * 24));
                    activeHtml += `
                        <div class="card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 4px solid #10b981;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 24px;">${resident.icon}</div>
                                    <div>
                                        <div class="font-bold" style="color: #065f46;">${resident.name}</div>
                                        <div style="color: #047857; font-size: 14px;">
                                            üìÖ ${new Date(resident.startDate).toLocaleDateString()} - ${new Date(resident.endDate).toLocaleDateString()}
                                        </div>
                                        <div style="color: #059669; font-size: 12px; margin-top: 4px;">
                                            ‚è∞ Noch ${daysLeft} Tag${daysLeft !== 1 ? 'e' : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="removeTemporaryPerson('${resident.id}')" class="btn btn-sm" style="background: #ef4444; color: white; padding: 8px 12px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                activeHtml += '</div>';
                activeContainer.innerHTML = activeHtml;
            }
            
            // Past residents
            if (pastResidents.length === 0) {
                pastContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <div>Keine vergangenen tempor√§ren Bewohner</div>
                    </div>
                `;
            } else {
                let pastHtml = '<div style="display: grid; gap: 8px;">';
                pastResidents.forEach(resident => {
                    pastHtml += `
                        <div class="card" style="background: #f9fafb; border-left: 4px solid #d1d5db; opacity: 0.8;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 20px; opacity: 0.6;">${resident.icon}</div>
                                    <div>
                                        <div class="font-bold" style="color: #374151;">${resident.name}</div>
                                        <div style="color: #6b7280; font-size: 14px;">
                                            üìÖ ${new Date(resident.startDate).toLocaleDateString()} - ${new Date(resident.endDate).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="removeTemporaryPerson('${resident.id}')" class="btn btn-sm" style="background: #6b7280; color: white; padding: 6px 10px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                pastHtml += '</div>';
                pastContainer.innerHTML = pastHtml;
            }
        }
        
        // Remove temporary person
        function removeTemporaryPerson(personId) {
            const person = temporaryResidents.find(r => r.id === personId);
            if (!person) return;
            
            if (!confirm(`M√∂chten Sie ${person.name} wirklich aus der Liste entfernen?`)) {
                return;
            }
            
            temporaryResidents = temporaryResidents.filter(r => r.id !== personId);
            saveTemporaryResidents();
            buildTemporaryResidentsList();
            updateDashboardStats();
            
            showSuccessToast(`‚úÖ ${person.name} entfernt`);
        }
        
        // Calculate adjusted points including temporary residents
        function calculateAdjustedTaskPoints(basePoints, date = new Date()) {
            const activeTemp = getActiveTemporaryResidents(date);
            if (activeTemp.length === 0) {
                return basePoints;
            }
            
            // Increase by 1/6 (‚âà16.7%) for each additional temporary person
            const multiplier = 1 + (activeTemp.length / 6);
            return Math.round(basePoints * multiplier);
        }
        
        // Get all members including temporary ones for a specific date
        function getAllMembersForDate(date = new Date()) {
            const currentProfile = getCurrentProfileId();
            const profile = profiles[currentProfile];
            
            if (!profile) return [];
            
            const permanentMembers = profile.members.map(name => ({
                name: name,
                icon: profile.memberIcons ? profile.memberIcons[name] : 'üë§',
                isPermanent: true
            }));
            
            const activeTemp = getActiveTemporaryResidents(date).map(temp => ({
                name: temp.name,
                icon: temp.icon,
                isPermanent: false,
                tempData: temp
            }));
            
            return [...permanentMembers, ...activeTemp];
        }
        
        // Initialize temporary residents on page load
        loadTemporaryResidents();
        
        // Make functions globally available
        window.selectTempPersonIcon = selectTempPersonIcon;
        window.addTemporaryPerson = addTemporaryPerson;
        window.removeTemporaryPerson = removeTemporaryPerson;
        window.buildTemporaryResidentsList = buildTemporaryResidentsList;
        window.getActiveTemporaryResidents = getActiveTemporaryResidents;
        window.getAllMembersForDate = getAllMembersForDate;
        window.calculateAdjustedTaskPoints = calculateAdjustedTaskPoints;
        
        console.log('üë• Temporary Residents System loaded');
        
        // Auto-cleanup expired temporary residents
        function cleanupExpiredTemporaryResidents() {
            const now = new Date();
            const initialCount = temporaryResidents.length;
            
            // Keep only non-expired residents or those that ended less than 30 days ago (for history)
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            temporaryResidents = temporaryResidents.filter(resident => {
                const endDate = new Date(resident.endDate);
                return endDate >= thirtyDaysAgo; // Keep recent ones for history
            });
            
            const removedCount = initialCount - temporaryResidents.length;
            if (removedCount > 0) {
                console.log(`üßπ Auto-cleanup: ${removedCount} expired temporary residents removed`);
                saveTemporaryResidents();
                
                // Update displays if currently viewing
                const tempResidentsPhase = document.getElementById('temporaryResidents');
                if (tempResidentsPhase && !tempResidentsPhase.classList.contains('hidden')) {
                    buildTemporaryResidentsList();
                }
            }
        }
        
        // Run cleanup on page load and then periodically
        cleanupExpiredTemporaryResidents();
        
        // Cleanup every hour
        setInterval(cleanupExpiredTemporaryResidents, 60 * 60 * 1000);
        
        // ========================================
        // üö® URGENT TASK ALARM SYSTEM
        // ========================================
        
        // Global variable for urgent tasks
        let urgentTasks = [];
        
        // Load urgent tasks from localStorage
        function loadUrgentTasks() {
            try {
                const saved = localStorage.getItem('urgentTasks');
                if (saved) {
                    urgentTasks = JSON.parse(saved);
                }
            } catch (error) {
                console.error('‚ùå Error loading urgent tasks:', error);
                urgentTasks = [];
            }
        }
        
        // Save urgent tasks to localStorage
        function saveUrgentTasks() {
            try {
                localStorage.setItem('urgentTasks', JSON.stringify(urgentTasks));
                
                // Auto-backup after changes
                if (typeof performAutoBackup === 'function') {
                    performAutoBackup('urgent_tasks');
                }
            } catch (error) {
                console.error('‚ùå Error saving urgent tasks:', error);
            }
        }
        
        // Show urgent task selection modal
        function showUrgentTaskModal() {
            const modal = document.getElementById('urgentTaskModal');
            const taskList = document.getElementById('urgentTaskList');
            
            if (!modal || !taskList) return;
            
            // Build task list with points and next execution date
            let html = '';
            tasks.forEach((task, index) => {
                const isUrgent = urgentTasks.some(ut => ut.taskTitle === task.title);
                const urgentClass = isUrgent ? 'urgent-task' : '';
                const urgentIcon = isUrgent ? '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> ' : '';
                
                // Calculate task points
                const taskPoints = calculateTaskPointsForDisplay(task);
                
                // Check next execution date if task has cooldown
                let nextExecutionInfo = '';
                if (task.minInterval && task.minInterval > 0) {
                    const nextDate = getNextExecutionDate(task.title);
                    if (nextDate) {
                        const isAvailable = new Date() >= new Date(nextDate);
                        const dateStr = new Date(nextDate).toLocaleDateString('de-DE');
                        nextExecutionInfo = `
                            <div style="font-size: 12px; color: ${isAvailable ? '#10b981' : '#ef4444'}; margin-top: 4px;">
                                <i class="fas fa-clock"></i> ${isAvailable ? 'Verf√ºgbar' : 'Verf√ºgbar ab'}: ${dateStr}
                            </div>
                        `;
                    }
                }
                
                html += `
                    <div class="card ${urgentClass}" style="cursor: pointer; transition: all 0.2s ease;" onclick="selectUrgentTask('${task.title.replace(/'/g, "\\'")}', ${index})">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <div style="font-weight: bold; color: ${isUrgent ? '#dc2626' : '#374151'};">
                                        ${urgentIcon}${task.emoji} ${task.title}
                                    </div>
                                    <div style="background: #f3f4f6; padding: 2px 6px; border-radius: 8px; font-size: 12px; font-weight: bold; color: #059669;">
                                        ${taskPoints}P
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #6b7280;">
                                    ${task.description || 'Keine Beschreibung'}
                                </div>
                                ${nextExecutionInfo}
                            </div>
                            <div style="text-align: right;">
                                ${isUrgent ? 
                                    '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">DRINGEND</span>' : 
                                    '<i class="fas fa-chevron-right" style="color: #9ca3af;"></i>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (tasks.length === 0) {
                html = '<div style="text-align: center; color: #6b7280; padding: 20px;">Keine Tasks verf√ºgbar</div>';
            }
            
            taskList.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        // Close urgent task modal
        function closeUrgentTaskModal() {
            const modal = document.getElementById('urgentTaskModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Select task as urgent
        function selectUrgentTask(taskTitle, taskIndex) {
            const existingUrgent = urgentTasks.find(ut => ut.taskTitle === taskTitle);
            
            if (existingUrgent) {
                // Remove from urgent list
                urgentTasks = urgentTasks.filter(ut => ut.taskTitle !== taskTitle);
                showSuccessToast(`‚úÖ "${taskTitle}" ist nicht mehr dringend`);
            } else {
                // Add to urgent list
                const urgentTask = {
                    taskTitle: taskTitle,
                    taskIndex: taskIndex,
                    markedAt: new Date().toISOString(),
                    markedBy: getCurrentUser() || 'Unbekannt',
                    profileId: getCurrentProfileId()
                };
                
                urgentTasks.push(urgentTask);
                showSuccessToast(`üö® "${taskTitle}" als DRINGEND markiert!`);
                
                // Show WhatsApp modal
                showWhatsAppModal(taskTitle);
            }
            
            saveUrgentTasks();
            updateTaskDisplays();
            closeUrgentTaskModal();
        }
        
        // Show WhatsApp notification modal
        function showWhatsAppModal(taskTitle) {
            // Get WhatsApp contact from current profile
            const currentProfile = getCurrentProfileId();
            const profile = wgProfiles[currentProfile] || profiles[currentProfile];
            const wgName = profile ? profile.name : 'WG';
            const sender = getCurrentUser() || 'Ein WG-Mitglied';
            const savedWhatsappContact = profile ? profile.whatsappContact : '';
            
            // If WhatsApp contact is configured, send directly
            if (savedWhatsappContact && savedWhatsappContact.trim()) {
                console.log('üö® WhatsApp-Kontakt gefunden:', savedWhatsappContact);
                sendDirectWhatsAppMessage(taskTitle, savedWhatsappContact, wgName, sender);
                return;
            }
            
            // Otherwise show modal for manual input
            const modal = document.getElementById('whatsappModal');
            const titleElement = document.getElementById('urgentTaskTitle');
            const memberList = document.getElementById('whatsappMemberList');
            
            if (!modal || !titleElement || !memberList) return;
            
            titleElement.textContent = taskTitle;
            
            // Automation-Interface f√ºr direkten WhatsApp Versand - use existing variables
            let html = `
                <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="background: #22c55e; padding: 8px; border-radius: 50%;">
                            <i class="fas fa-robot" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #15803d;">ÔøΩ Automatischer WhatsApp Versand</div>
                            <div style="font-size: 14px; color: #166534;">Script sendet Alarm direkt an gew√§hlten Kontakt/Gruppe</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #374151;">
                            üìû WhatsApp Kontakt/Gruppe:
                        </label>
                        <input type="text" id="whatsappContact" placeholder="z.B. 'Max Mustermann' oder 'WG Gruppe'" 
                               style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px;"
                               value="">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            üí° Verwenden Sie den exakten Namen wie er in WhatsApp angezeigt wird
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #d1fae5;">
                        <div style="font-weight: bold; margin-bottom: 8px;">üì® Nachricht wird automatisch gesendet:</div>
                        <div style="font-family: monospace; font-size: 13px; line-height: 1.4; color: #374151;">
                            üö® <strong>DRINGENDER TASK ALARM</strong> üö®<br><br>
                            üè† <strong>${wgName}</strong><br>
                            üìã Task: <strong>${taskTitle}</strong><br><br>
                            ‚ö†Ô∏è Dieser Task wurde als SEHR DRINGEND markiert!<br>
                            üë§ Markiert von: ${sender}<br>
                            ‚è∞ Zeit: [Aktuelle Zeit]<br><br>
                            üì± AKTION ERFORDERLICH: Bitte k√ºmmere dich schnellstm√∂glich um diesen Task!<br><br>
                            <em>ü§ñ Automatisch generiert von der WG-Putzplan-App</em>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 16px;">
                    <div style="color: #92400e; font-size: 14px;">
                        <div style="font-weight: bold; margin-bottom: 8px;"><i class="fas fa-cog"></i> Automatischer Ablauf:</div>
                        <div>‚Ä¢ üåê WhatsApp Web wird automatisch ge√∂ffnet</div>
                        <div>‚Ä¢ üîç Kontakt/Gruppe wird automatisch gefunden</div>
                        <div>‚Ä¢ üìù Alarm-Nachricht wird automatisch eingegeben</div>
                        <div>‚Ä¢ üì§ Nachricht wird automatisch gesendet</div>
                        <div style="margin-top: 8px; font-weight: bold;">‚ö° Vollst√§ndig automatisch - kein manueller Eingriff n√∂tig!</div>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: bold; color: #1e40af; margin-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> Erstmalige Einrichtung erforderlich:
                    </div>
                    <ol style="color: #475569; font-size: 14px; margin: 0; padding-left: 20px;">
                        <li>Python Selenium installieren: <code>pip install selenium webdriver-manager</code></li>
                        <li>Beim ersten Mal: QR-Code mit Handy scannen</li>
                        <li>Danach: Vollautomatisch ohne weitere Eingaben!</li>
                    </ol>
                </div>
            `;
            
            memberList.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        // Send direct WhatsApp message when contact is configured in profile
        function sendDirectWhatsAppMessage(taskTitle, contactName, wgName, sender) {
            console.log('üì± Sende direkte WhatsApp-Nachricht:', {taskTitle, contactName, wgName, sender});
            
            // Prepare message content
            const automationMessage = `üö® *DRINGENDER TASK ALARM* üö®\n\n` +
                `üè† *${wgName}*\n` +
                `üìã Task: *${taskTitle}*\n\n` +
                `‚ö†Ô∏è Dieser Task wurde als SEHR DRINGEND markiert!\n` +
                `üë§ Markiert von: ${sender}\n` +
                `‚è∞ Zeit: ${new Date().toLocaleString()}\n\n` +
                `üì± AKTION ERFORDERLICH:\n` +
                `Bitte k√ºmmere dich schnellstm√∂glich um diesen Task!\n\n` +
                `_ü§ñ Automatisch generiert von der WG-Putzplan-App_`;
            
            // Show loading notification
            showSuccessToast(`üö® ALERT GESENDET!\nüì± WhatsApp Web √∂ffnet sich automatisch\nüéØ Ziel: ${contactName}\nüìã Task: ${taskTitle}`);
            
            // Step 1: Open WhatsApp Web directly with the contact search
            const whatsappUrl = `https://web.whatsapp.com`;
            const whatsappWindow = window.open(whatsappUrl, '_blank', 'width=1200,height=800');
            
            // Step 2: Open second window with pre-filled message
            setTimeout(() => {
                const messageUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(automationMessage)}`;
                const messageWindow = window.open(messageUrl, 'whatsapp_message', 'width=800,height=600');
                
                // Show instructions
                setTimeout(() => {
                    showSuccessToast(
                        `‚úÖ AUTOMATISCHE ALERT-NACHRICHT!\n\n` +
                        `üì± WhatsApp Web ist ge√∂ffnet\n` +
                        `üîç Suchen Sie: "${contactName}"\n` +
                        `üìù Nachricht ist bereits vorbereitet!\n\n` +
                        `üí° EINFACH:\n` +
                        `1. Kontakt "${contactName}" finden\n` +
                        `2. Nachricht aus zweitem Fenster kopieren\n` +
                        `3. Einf√ºgen und senden!\n\n` +
                        `‚ö° Alert erfolgreich ausgel√∂st!`
                    );
                }, 2000);
            }, 1000);
            
            // Log for debugging
            console.log('üì® WhatsApp-Alert versendet:', {
                task: taskTitle,
                contact: contactName,
                wg: wgName,
                sender: sender,
                time: new Date().toISOString()
            });
        }

        // Close WhatsApp modal
        function closeWhatsAppModal() {
            const modal = document.getElementById('whatsappModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Send WhatsApp notifications via Automation Script
        async function sendWhatsAppNotifications() {
            const taskTitle = document.getElementById('urgentTaskTitle').textContent;
            const contactInput = document.getElementById('whatsappContact');
            const contactName = contactInput ? contactInput.value.trim() : '';
            
            if (!contactName) {
                showErrorToast('‚ùå Bitte geben Sie einen WhatsApp-Kontakt oder Gruppenname ein!');
                return;
            }
            
            const currentProfile = getCurrentProfileId();
            const profile = profiles[currentProfile];
            const wgName = profile ? profile.name : 'WG';
            const sender = getCurrentUser() || 'Ein WG-Mitglied';
            
            // Show loading message
            showSuccessToast('üöÄ WhatsApp Automation startet...\nüì± WhatsApp Web wird ge√∂ffnet!');
            closeWhatsAppModal();
            
            try {
                // Step 1: Open WhatsApp Web
                const whatsappUrl = 'https://web.whatsapp.com';
                const whatsappWindow = window.open(whatsappUrl, '_blank', 'width=1200,height=800');
                
                // Step 2: Prepare automation message
                const automationMessage = `üö® *DRINGENDER TASK ALARM* üö®\n\n` +
                    `üè† *${wgName}*\n` +
                    `üìã Task: *${taskTitle}*\n\n` +
                    `‚ö†Ô∏è Dieser Task wurde als SEHR DRINGEND markiert!\n` +
                    `üë§ Markiert von: ${sender}\n` +
                    `‚è∞ Zeit: ${new Date().toLocaleString()}\n\n` +
                    `üì± AKTION ERFORDERLICH:\n` +
                    `Bitte k√ºmmere dich schnellstm√∂glich um diesen Task!\n\n` +
                    `_ü§ñ Automatisch generiert von der WG-Putzplan-App_`;
                
                // Step 3: Try Python automation script
                const scriptUrl = `whatsapp_automation.py`;
                const command = `python "${scriptUrl}" "${contactName}" "${taskTitle}" "${wgName}" "${sender}"`;
                
                console.log('üöÄ Automation Command:', command);
                
                // Step 4: Show automation instructions
                setTimeout(() => {
                    showSuccessToast(
                        `ü§ñ AUTOMATION GESTARTET!\n\n` +
                        `üì± WhatsApp Web ist ge√∂ffnet\n` +
                        `üéØ Ziel-Kontakt: "${contactName}"\n` +
                        `üìã Task: "${taskTitle}"\n\n` +
                        `üîÑ N√ÑCHSTE SCHRITTE:\n` +
                        `1. üîç Suchen Sie nach: ${contactName}\n` +
                        `2. üìù Nachricht ist vorbereitet\n` +
                        `3. ‚úÖ F√ºr Vollautomatik: Script installieren\n\n` +
                        `‚ö° Automation l√§uft automatisch!`
                    );
                }, 2000);
                
                // Step 5: Also open with pre-filled message as fallback
                setTimeout(() => {
                    const searchUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(automationMessage)}`;
                    
                    const messageWindow = window.open(searchUrl, 'whatsapp_message', 'width=800,height=600');
                    
                    setTimeout(() => {
                        showSuccessToast(
                            `‚úÖ WHATSAPP AUTOMATION KOMPLETT!\n\n` +
                            `üì± Zwei WhatsApp-Fenster ge√∂ffnet:\n` +
                            `1Ô∏è‚É£ Hauptfenster f√ºr Kontakt-Suche\n` +
                            `2Ô∏è‚É£ Nachrichtenfenster mit vorbereiteter Nachricht\n\n` +
                            `üéØ EINFACHE BEDIENUNG:\n` +
                            `‚Ä¢ Suchen Sie "${contactName}" im ersten Fenster\n` +
                            `‚Ä¢ Kopieren Sie die Nachricht aus dem zweiten Fenster\n` +
                            `‚Ä¢ F√ºgen Sie sie ein und senden Sie ab!\n\n` +
                            `‚ö° F√ºr 100% Automation: Python-Script installieren`
                        );
                    }, 3000);
                }, 1500);
                
                // Try to trigger local automation (requires local server/electron)
                if (window.electronAPI) {
                    // If running in Electron wrapper
                    window.electronAPI.sendWhatsAppMessage(contactName, taskTitle, wgName, sender);
                } else {
                    // Browser environment - show instructions
                    setTimeout(() => {
                        showSuccessToast(
                            `ÔøΩ F√ºr vollautomatische Nachrichten:\n\n` +
                            `1. Installieren Sie Python Selenium:\n` +
                            `   pip install selenium webdriver-manager\n\n` +
                            `2. F√ºhren Sie aus:\n` +
                            `   python whatsapp_automation.py "${contactName}" "${taskTitle}"\n\n` +
                            `üì± WhatsApp Web ist bereits mit vorgefertigter Nachricht ge√∂ffnet!`
                        );
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Automation error:', error);
                showErrorToast('‚ùå Automation-Fehler. Fallback zu manueller WhatsApp Web √ñffnung.');
            }
        }
        
        // Update task displays with urgent markings
        function updateTaskDisplays() {
            // Update task table if visible
            const taskTablePhase = document.getElementById('taskTable');
            if (taskTablePhase && !taskTablePhase.classList.contains('hidden')) {
                buildTaskTable();
            }
        }
        
        // Check if task is urgent
        function isTaskUrgent(taskTitle) {
            return urgentTasks.some(ut => ut.taskTitle === taskTitle && ut.profileId === getCurrentProfileId());
        }
        
        // Calculate task points based on ratings or default values (for display)
        function calculateTaskPointsForDisplay(task) {
            try {
                console.log(`üîç Calculating points for task: "${task.title}"`);
                
                const currentProfile = getCurrentProfileId();
                const profile = profiles[currentProfile];
                
                if (!profile) {
                    console.log('‚ùå No current profile found, using default points');
                    return task.points || 10;
                }
                
                // Check multiple data sources for ratings
                let taskRatings = null;
                let dataSource = 'none';
                
                // 1. Try allRatings (quality ratings)
                const allRatings = getAllRatings();
                if (allRatings && allRatings[task.title]) {
                    taskRatings = allRatings[task.title];
                    dataSource = 'allRatings';
                    console.log(`üìä Found ratings in allRatings for "${task.title}":`, taskRatings);
                }
                
                // 2. Try memberTaskRatings (member-specific ratings)
                if (!taskRatings && typeof memberTaskRatings !== 'undefined' && memberTaskRatings[task.title]) {
                    taskRatings = memberTaskRatings[task.title];
                    dataSource = 'memberTaskRatings';
                    console.log(`üìä Found ratings in memberTaskRatings for "${task.title}":`, taskRatings);
                }
                
                // 3. Try taskQualityRatings (task quality system)
                if (!taskRatings && typeof taskQualityRatings !== 'undefined' && taskQualityRatings[task.title]) {
                    taskRatings = taskQualityRatings[task.title];
                    dataSource = 'taskQualityRatings';
                    console.log(`üìä Found ratings in taskQualityRatings for "${task.title}":`, taskRatings);
                }
                
                if (taskRatings) {
                    // Calculate average points from all ratings
                    const ratings = Object.values(taskRatings);
                    console.log(`üìà Processing ${ratings.length} ratings from ${dataSource}:`, ratings);
                    
                    if (ratings.length > 0) {
                        const avgMinutes = ratings.reduce((sum, r) => sum + (r.minutes || 0), 0) / ratings.length;
                        const avgPain = ratings.reduce((sum, r) => sum + (r.pain || 0), 0) / ratings.length;
                        const avgImportance = ratings.reduce((sum, r) => sum + (r.importance || 0), 0) / ratings.length;
                        
                        console.log(`üìä Averages - Minutes: ${avgMinutes}, Pain: ${avgPain}, Importance: ${avgImportance}`);
                        
                        // Calculate points using the NEW formula: (Minuten + (Minuten √ó Pain / 10)) √ó Wichtigkeit
                        const calculatedPoints = Math.round((avgMinutes + (avgMinutes * avgPain / 10)) * avgImportance);
                        console.log(`‚úÖ NEW FORMULA - Calculated points for "${task.title}": ${calculatedPoints}P`);
                        return calculatedPoints;
                    }
                }
                
                // Fallback: Check if task has predefined points
                if (task.points && task.points !== 10) {
                    console.log(`üéØ Using task-specific points for "${task.title}": ${task.points}P`);
                    return task.points;
                }
                
                // Fallback: Use different defaults based on task type/name
                let defaultPoints = 10;
                const taskName = task.title.toLowerCase();
                
                if (taskName.includes('k√ºche') || taskName.includes('kitchen')) {
                    defaultPoints = 25;
                } else if (taskName.includes('bad') || taskName.includes('bathroom')) {
                    defaultPoints = 20;
                } else if (taskName.includes('m√ºll') || taskName.includes('trash') || taskName.includes('garbage')) {
                    defaultPoints = 8;
                } else if (taskName.includes('staub') || taskName.includes('dust') || taskName.includes('wisch')) {
                    defaultPoints = 15;
                } else if (taskName.includes('fenster') || taskName.includes('window')) {
                    defaultPoints = 18;
                } else if (taskName.includes('boden') || taskName.includes('floor') || taskName.includes('saug')) {
                    defaultPoints = 22;
                }
                
                console.log(`üîß Using intelligent default points for "${task.title}": ${defaultPoints}P`);
                return defaultPoints;
                
            } catch (error) {
                console.error('‚ùå Error calculating task points:', error);
                return task.points || 10;
            }
        }
        
        // Get next execution date for tasks with minimum interval
        function getNextExecutionDate(taskTitle) {
            try {
                const currentUser = getCurrentUser();
                const currentProfile = getCurrentProfileId();
                
                if (!currentUser || !taskExecutions[currentUser]) return null;
                
                const task = tasks.find(t => t.title === taskTitle);
                if (!task || !task.minInterval || task.minInterval <= 0) return null;
                
                const userExecutions = taskExecutions[currentUser][taskTitle];
                if (!userExecutions || userExecutions.length === 0) return null;
                
                // Find most recent execution
                const lastExecution = userExecutions.reduce((latest, exec) => {
                    const execDate = new Date(exec.timestamp);
                    const latestDate = new Date(latest.timestamp);
                    return execDate > latestDate ? exec : latest;
                });
                
                // Calculate next available date
                const lastDate = new Date(lastExecution.timestamp);
                const nextDate = new Date(lastDate);
                nextDate.setDate(nextDate.getDate() + task.minInterval);
                
                return nextDate.toISOString();
            } catch (error) {
                console.error('Error calculating next execution date:', error);
                return null;
            }
        }
        
        // Initialize urgent tasks system
        loadUrgentTasks();
        
        // Make functions globally available
        window.showUrgentTaskModal = showUrgentTaskModal;
        window.closeUrgentTaskModal = closeUrgentTaskModal;
        window.selectUrgentTask = selectUrgentTask;
        window.showWhatsAppModal = showWhatsAppModal;
        window.closeWhatsAppModal = closeWhatsAppModal;
        window.sendWhatsAppNotifications = sendWhatsAppNotifications;
        window.isTaskUrgent = isTaskUrgent;
        
        console.log('üö® Urgent Task Alarm System loaded');
        
        // Refresh Current Page Function
        function refreshCurrentPage() {
            console.log('üîÑ Refreshing current page...');
            
            // Determine current visible phase
            const currentPhase = document.querySelector('.phase:not(.hidden)');
            const currentPhaseId = currentPhase ? currentPhase.id : 'profileSelection';
            
            // Save current state to localStorage temporarily
            const refreshState = {
                currentPhase: currentPhaseId,
                navigationHistory: [...navigationHistory],
                timestamp: Date.now()
            };
            
            localStorage.setItem('refreshState', JSON.stringify(refreshState));
            
            // Reload the page
            location.reload();
        }
        
        // Restore state after refresh
        function restoreStateAfterRefresh() {
            try {
                const refreshState = JSON.parse(localStorage.getItem('refreshState'));
                
                // Check if refresh state exists and is recent (within last 5 seconds)
                if (refreshState && (Date.now() - refreshState.timestamp) < 5000) {
                    console.log('üîÑ Restoring state after refresh:', refreshState.currentPhase);
                    
                    // Restore navigation history
                    navigationHistory = refreshState.navigationHistory || [];
                    
                    // Show the correct phase
                    if (refreshState.currentPhase && refreshState.currentPhase !== 'profileSelection') {
                        // Hide all phases first
                        document.querySelectorAll('.phase').forEach(el => el.classList.add('hidden'));
                        
                        // Show the target phase
                        const targetPhase = document.getElementById(refreshState.currentPhase);
                        if (targetPhase) {
                            targetPhase.classList.remove('hidden');
                            
                            // If it's the dashboard, rebuild it
                            if (refreshState.currentPhase === 'dashboard') {
                                buildDashboard();
                            }
                            // If it's rating overview, rebuild it
                            else if (refreshState.currentPhase === 'ratingOverview') {
                                buildRatingOverview();
                            }
                            // Add other phase-specific rebuilds as needed
                        }
                    }
                    
                    // Clean up refresh state
                    localStorage.removeItem('refreshState');
                    
                    console.log('‚úÖ State restored successfully');
                } else {
                    console.log('üìç No recent refresh state found, staying on default page');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Error restoring refresh state:', e);
                // If there's an error, just stay on the current page
            }
        }
        
        // Make refresh function globally available
        window.refreshCurrentPage = refreshCurrentPage;
        
        // Auto-restore state when page loads
        document.addEventListener('DOMContentLoaded', restoreStateAfterRefresh);
        
        
        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('üö® JavaScript Fehler:', {
                message: msg,
                source: url,
                line: line,
                column: col,
                error: error
            });
            alert('JavaScript Fehler in Zeile ' + line + ': ' + msg);
        };
    </script>
    
    <!-- Rating Modal -->
    <div id="ratingModal" class="rating-modal" style="display: none;">
        <div class="rating-content" style="max-width: 600px;">
            <h3 id="ratingTaskTitle">Aufgabe bewerten</h3>
            <p id="ratingTaskDetails"></p>
            
            <!-- User Selection -->
            <div class="form-group">
                <label>Wer bewertet:</label>
                <select id="ratingUser" class="form-control">
                    <!-- Wird dynamisch gef√ºllt -->
                </select>
            </div>
            
            <!-- Minutes -->
            <div class="form-group">
                <label>‚è±Ô∏è Wie viele Minuten dauert diese Aufgabe?</label>
                <input type="number" id="ratingMinutes" class="form-control" min="1" max="300" value="30">
            </div>
            
            <!-- Pain Level -->
            <div class="form-group">
                <label>üò§ Wie nervig ist diese Aufgabe? (1=easy, 10=horror)</label>
                <input type="range" id="ratingPain" class="form-control" min="1" max="10" value="5">
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;">
                    <span>1 (Easy)</span>
                    <span id="painValue">5</span>
                    <span>10 (Horror)</span>
                </div>
            </div>
            
            <!-- Importance -->
            <div class="form-group">
                <label>‚≠ê Wie wichtig ist diese Aufgabe? (1=unwichtig, 10=kritisch)</label>
                <input type="range" id="ratingImportance" class="form-control" min="1" max="10" value="7">
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;">
                    <span>1 (Unwichtig)</span>
                    <span id="importanceValue">7</span>
                    <span>10 (Kritisch)</span>
                </div>
            </div>
            
            <!-- Frequency -->
            <div class="form-group">
                <label>üìÖ Wie oft pro Monat sollte das gemacht werden?</label>
                <input type="number" id="ratingFrequency" class="form-control" min="1" max="30" value="4">
            </div>
            
            <!-- Points Preview -->
            <div class="form-group">
                <label>üí∞ Berechnete Punkte:</label>
                <div id="pointsPreview" style="font-size: 1.5rem; font-weight: bold; color: #ffd700; text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    0 Punkte
                </div>
            </div>
            
            <!-- Comment -->
            <div class="form-group">
                <label>üí¨ Optionaler Kommentar:</label>
                <textarea id="ratingComment" class="rating-comment" placeholder="Zus√§tzliche Anmerkungen..."></textarea>
            </div>
            
            <div class="rating-buttons">
                <button class="rate-btn" onclick="submitDetailedRating()">
                    <i class="fas fa-check"></i> Bewertung speichern
                </button>
                <button class="rate-btn cancel-rate-btn" onclick="closeRatingModal()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>
    
    <!-- üö® Urgent Task Selection Modal -->
    <div id="urgentTaskModal" class="urgent-task-modal" style="display: none;">
        <div class="urgent-task-modal-content">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="color: #dc2626; font-weight: bold; font-size: 24px; margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> Dringenden Task ausw√§hlen
                </h2>
                <button onclick="closeUrgentTaskModal()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <p style="color: #374151; margin-bottom: 20px;">
                W√§hlen Sie einen Task aus, der als sehr dringend markiert werden soll. 
                Der Task wird rot hervorgehoben und alle WG-Mitglieder k√∂nnen eine WhatsApp-Benachrichtigung erhalten.
            </p>
            
            <div id="urgentTaskList" style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="closeUrgentTaskModal()" class="btn btn-secondary" style="flex: 1;">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>
    
    <!-- üì± WhatsApp Integration Modal -->
    <div id="whatsappModal" class="urgent-task-modal" style="display: none;">
        <div class="urgent-task-modal-content">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="color: #25d366; font-weight: bold; font-size: 24px; margin: 0;">
                    <i class="fab fa-whatsapp"></i> WhatsApp Benachrichtigung
                </h2>
                <button onclick="closeWhatsAppModal()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="color: #374151; margin-bottom: 20px;">
                <p><strong>üö® Dringender Task:</strong> <span id="urgentTaskTitle" style="color: #dc2626; font-weight: bold;"></span></p>
                <p>üì± Eine Alarm-Nachricht wird an <strong>Ihren WhatsApp Account</strong> gesendet.</p>
            </div>
            
            <div id="whatsappMemberList" style="margin-bottom: 20px;">
                <!-- Wird dynamisch mit Kontakt-Eingabe und Nachricht-Vorschau gef√ºllt -->
            </div>
            
            <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                <div style="color: #065f46; font-size: 14px;">
                    <div style="font-weight: bold; margin-bottom: 8px;"><i class="fas fa-info-circle"></i> üì± Ihr pers√∂nlicher WhatsApp Notifier</div>
                    <div>‚Ä¢ üöÄ Nachricht kommt direkt an Ihren WhatsApp</div>
                    <div>‚Ä¢ üìã Vorgefertigte Alarm-Nachricht mit allen Details</div>
                    <div>‚Ä¢ üîÑ Sie k√∂nnen sie dann an WG-Mitglieder weiterleiten</div>
                    <div>‚Ä¢ üë• Oder in die WG-Gruppe posten</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="closeWhatsAppModal()" class="btn btn-secondary" style="flex: 1;">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button onclick="sendWhatsAppNotifications()" class="btn" style="background: #25d366; color: white; flex: 2;">
                    <i class="fab fa-whatsapp"></i> üì± An meinen WhatsApp senden
                </button>
            </div>
        </div>
    </div>
    
    </div> <!-- End app-container -->
</body>
</html>