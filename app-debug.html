<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putzplan App Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="status-box info">
        <h1>üîß Putzplan App Debug</h1>
        <p>Debug-Tool f√ºr die Putzplan App und Persistence-Tests</p>
        <p><strong>App URL:</strong> <a href="http://localhost:5173/" target="_blank">http://localhost:5173/</a></p>
    </div>
    
    <div class="status-box" id="appStatus">
        <h2>üì± App Status</h2>
        <div id="statusContent">Pr√ºfe App-Status...</div>
    </div>
    
    <div class="status-box" id="testContainer">
        <h2>üß™ Persistence Test</h2>
        <button onclick="runQuickTest()" id="testBtn">Quick Test starten</button>
        <button onclick="checkAfterReload()" id="checkBtn">Nach F5 pr√ºfen</button>
        <div id="testResults"></div>
    </div>
    
    <div class="status-box">
        <h2>üñ•Ô∏è App Preview</h2>
        <iframe src="http://localhost:5173/" id="appFrame"></iframe>
    </div>
    
    <script>
        let testPeriodId = null;
        
        function updateStatus(message, type = 'info') {
            const container = document.getElementById('appStatus');
            const content = document.getElementById('statusContent');
            container.className = 'status-box ' + type;
            content.innerHTML = message;
        }
        
        function addTestResult(message) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.innerHTML = '<pre>' + new Date().toLocaleTimeString() + ': ' + message + '</pre>';
            results.appendChild(div);
        }
        
        async function checkAppStatus() {
            updateStatus('Pr√ºfe App-Verf√ºgbarkeit...', 'info');
            
            try {
                // Test if app is reachable
                const response = await fetch('http://localhost:5173/');
                if (response.ok) {
                    updateStatus('‚úÖ App erreichbar auf http://localhost:5173/', 'success');
                    
                    // Try to access the iframe's dataManager
                    const iframe = document.getElementById('appFrame');
                    iframe.onload = function() {
                        setTimeout(() => {
                            try {
                                if (iframe.contentWindow.dataManager) {
                                    updateStatus('‚úÖ App l√§dt korrekt - dataManager verf√ºgbar', 'success');
                                } else {
                                    updateStatus('‚ö†Ô∏è App l√§dt aber dataManager nicht verf√ºgbar (m√∂gl. noch am Laden)', 'warning');
                                }
                            } catch (e) {
                                updateStatus('‚ö†Ô∏è Kann nicht auf App-Inhalt zugreifen (Cross-Origin)', 'warning');
                            }
                        }, 2000);
                    };
                } else {
                    updateStatus('‚ùå App nicht erreichbar - HTTP ' + response.status, 'error');
                }
            } catch (error) {
                updateStatus('‚ùå App-Server nicht verf√ºgbar: ' + error.message, 'error');
            }
        }
        
        function runQuickTest() {
            addTestResult('üß™ Starte Quick Test...');
            
            const iframe = document.getElementById('appFrame');
            
            try {
                const appWindow = iframe.contentWindow;
                
                if (!appWindow.dataManager) {
                    addTestResult('‚ùå dataManager nicht verf√ºgbar in iframe');
                    addTestResult('üìã MANUAL TEST: Gehe zu http://localhost:5173/ und f√ºhre folgenden Code aus:');
                    addTestResult(`
// === MANUAL TEST CODE ===
const testStart = new Date();
testStart.setHours(0,0,0,0);
const testEnd = new Date(testStart.getTime() + 14*24*60*60*1000);

localStorage.removeItem('putzplan-data');
localStorage.removeItem('putzplan-sync');

const period = dataManager.setCustomPeriod(testStart, testEnd, false);
console.log('Period created:', period.id);
sessionStorage.setItem('testPeriodId', period.id);

setTimeout(() => {
    const stored = localStorage.getItem('putzplan-data');
    const data = JSON.parse(stored);
    if (data.state?.currentPeriod?.id === period.id) {
        console.log('‚úÖ Saved to localStorage');
        console.log('üéØ Now press F5 and run: checkAfterReload()');
    } else {
        console.log('‚ùå NOT saved to localStorage');
    }
}, 500);
                    `);
                    return;
                }
                
                addTestResult('‚úÖ dataManager verf√ºgbar');
                
                // Clear storage
                appWindow.localStorage.removeItem('putzplan-data');
                appWindow.localStorage.removeItem('putzplan-sync');
                addTestResult('üßπ Storage gel√∂scht');
                
                // Create period
                const testStart = new Date();
                testStart.setHours(0, 0, 0, 0);
                const testEnd = new Date(testStart.getTime() + 14 * 24 * 60 * 60 * 1000);
                
                const period = appWindow.dataManager.setCustomPeriod(testStart, testEnd, false);
                testPeriodId = period.id;
                sessionStorage.setItem('testPeriodId', period.id);
                
                addTestResult('üìÖ Period erstellt: ' + period.id);
                
                // Check persistence
                setTimeout(() => {
                    const stored = appWindow.localStorage.getItem('putzplan-data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        if (data.state?.currentPeriod?.id === period.id) {
                            addTestResult('‚úÖ Period in localStorage gespeichert');
                            addTestResult('üéØ Jetzt F5 dr√ºcken und "Nach F5 pr√ºfen" klicken');
                        } else {
                            addTestResult('‚ùå Period NICHT in localStorage');
                        }
                    } else {
                        addTestResult('‚ùå Kein localStorage data');
                    }
                }, 500);
                
            } catch (error) {
                addTestResult('‚ùå Fehler: ' + error.message);
                addTestResult('üí° Versuche den manuellen Test direkt in der App-Console');
            }
        }
        
        function checkAfterReload() {
            const expectedId = sessionStorage.getItem('testPeriodId');
            if (!expectedId) {
                addTestResult('‚ùå Keine Test-Period-ID gefunden - f√ºhre zuerst den Test aus');
                return;
            }
            
            addTestResult('üîç Pr√ºfe Persistierung nach Reload...');
            addTestResult('Erwartete ID: ' + expectedId);
            
            const iframe = document.getElementById('appFrame');
            
            try {
                const appWindow = iframe.contentWindow;
                
                if (!appWindow.dataManager) {
                    addTestResult('‚ùå dataManager nicht verf√ºgbar nach Reload');
                    return;
                }
                
                const currentPeriod = appWindow.dataManager.getState().currentPeriod;
                const currentId = currentPeriod?.id;
                
                addTestResult('Gefundene ID: ' + (currentId || 'null'));
                
                if (currentId === expectedId) {
                    addTestResult('üéâ TEST ERFOLGREICH!');
                    addTestResult('‚úÖ Period hat Reload √ºberlebt');
                    addTestResult('‚úÖ CrossBrowserSync-Fix funktioniert!');
                    sessionStorage.removeItem('testPeriodId');
                } else {
                    addTestResult('‚ùå TEST FEHLGESCHLAGEN!');
                    addTestResult('üö® Period nach Reload verloren');
                    
                    // Debug
                    const storage = appWindow.localStorage.getItem('putzplan-data');
                    if (storage) {
                        const data = JSON.parse(storage);
                        addTestResult('Debug - Storage Period: ' + (data.state?.currentPeriod?.id || 'null'));
                    }
                }
                
            } catch (error) {
                addTestResult('‚ùå Fehler beim Check: ' + error.message);
            }
        }
        
        // Auto-start status check
        checkAppStatus();
        
        // Refresh iframe button
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = 'üîÑ App neu laden';
        refreshBtn.onclick = () => {
            document.getElementById('appFrame').src = 'http://localhost:5173/';
        };
        document.getElementById('testContainer').appendChild(refreshBtn);
    </script>
</body>
</html>