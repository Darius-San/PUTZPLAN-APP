<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Putzplan Persistence Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { max-height: 400px; overflow-y: auto; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Putzplan Persistence Ausgiebiger Test</h1>
    
    <div class="test-section">
        <h2>Test Steuerung</h2>
        <button onclick="runAllTests()">üöÄ Alle Tests Durchf√ºhren</button>
        <button onclick="clearResults()">üßπ Ergebnisse L√∂schen</button>
        <button onclick="inspectLocalStorage()">üîç LocalStorage Inspizieren</button>
        <button onclick="simulateDataCreation()">‚ûï Test-Daten Erstellen</button>
    </div>

    <div class="test-section">
        <h2>Test Ergebnisse</h2>
        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            results.innerHTML = '';
        }

        function inspectLocalStorage() {
            log('üîç LocalStorage Inspektion gestartet...', 'info');
            
            try {
                const putzplanData = localStorage.getItem('putzplan-data');
                if (putzplanData) {
                    const parsed = JSON.parse(putzplanData);
                    log(`‚úÖ putzplan-data Key gefunden! Version: ${parsed.version}`, 'success');
                    log(`üìä Datenstruktur: ${Object.keys(parsed.state || {}).join(', ')}`, 'info');
                    
                    if (parsed.state) {
                        const state = parsed.state;
                        log(`üë• Benutzer: ${state.users?.length || 0}`, 'info');
                        log(`üè† WGs: ${state.wgs?.length || 0}`, 'info');
                        log(`üìã Tasks: ${state.tasks?.length || 0}`, 'info');
                        log(`‚è∞ Perioden: ${state.periods?.length || 0}`, 'info');
                        log(`‚úÖ Ausf√ºhrungen: ${state.executions?.length || 0}`, 'info');
                    }
                    
                    // Zeige JSON in kompakter Form
                    const preview = JSON.stringify(parsed, null, 2).substring(0, 500) + '...';
                    log(`<pre>${preview}</pre>`, 'info');
                } else {
                    log('‚ùå Keine putzplan-data in localStorage gefunden!', 'error');
                }

                // Zeige alle localStorage Keys
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    allKeys.push(localStorage.key(i));
                }
                log(`üóÇÔ∏è Alle localStorage Keys: ${allKeys.join(', ')}`, 'info');

            } catch (error) {
                log(`‚ùå Fehler bei LocalStorage Inspektion: ${error.message}`, 'error');
            }
        }

        function simulateDataCreation() {
            log('üéØ Simuliere Daten-Erstellung...', 'info');
            
            try {
                // Erstelle Test-Daten im localStorage Format
                const testData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    state: {
                        users: [
                            { id: 'test-user-1', name: 'Test User 1', email: 'test1@example.com' },
                            { id: 'test-user-2', name: 'Test User 2', email: 'test2@example.com' }
                        ],
                        wgs: [
                            { id: 'test-wg-1', name: 'Test WG 1', members: ['test-user-1', 'test-user-2'] }
                        ],
                        periods: [
                            { 
                                id: 'test-period-' + Date.now(),
                                name: 'Persistence Test Periode',
                                startDate: new Date().toISOString(),
                                endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                                isActive: true
                            }
                        ],
                        tasks: [],
                        executions: [],
                        settings: {},
                        notifications: []
                    }
                };

                localStorage.setItem('putzplan-data', JSON.stringify(testData));
                log('‚úÖ Test-Daten erfolgreich in localStorage gespeichert!', 'success');
                
                // Verifikation
                const saved = localStorage.getItem('putzplan-data');
                const parsed = JSON.parse(saved);
                log(`‚úÖ Verifikation: ${parsed.state.periods.length} Periode(n) gespeichert`, 'success');

            } catch (error) {
                log(`‚ùå Fehler bei Test-Daten Erstellung: ${error.message}`, 'error');
            }
        }

        async function testAppReload() {
            log('üîÑ App Reload Test gestartet...', 'info');
            
            // Aktuelle Daten vor Reload sichern
            const beforeReload = localStorage.getItem('putzplan-data');
            
            if (!beforeReload) {
                log('‚ö†Ô∏è Keine Daten vor Reload vorhanden, erstelle Test-Daten', 'info');
                simulateDataCreation();
            }

            log('üíæ Daten vor Reload gesichert, simuliere Reload...', 'info');
            
            // Simuliere Reload durch kurze Wartezeit
            setTimeout(() => {
                const afterReload = localStorage.getItem('putzplan-data');
                
                if (afterReload === beforeReload) {
                    log('‚úÖ PERSISTENCE TEST BESTANDEN: Daten sind nach Reload identisch!', 'success');
                } else if (afterReload && beforeReload) {
                    log('‚ö†Ô∏è Daten unterscheiden sich nach Reload (m√∂glicherweise automatische Updates)', 'info');
                } else if (!afterReload) {
                    log('‚ùå PERSISTENCE TEST FEHLGESCHLAGEN: Daten nach Reload verschwunden!', 'error');
                } else {
                    log('üîç Unerwarteter Zustand nach Reload-Test', 'info');
                }
            }, 1000);
        }

        function testDataIntegrity() {
            log('üîí Datenintegrit√§ts-Test gestartet...', 'info');
            
            try {
                const data = localStorage.getItem('putzplan-data');
                if (!data) {
                    log('‚ùå Keine Daten f√ºr Integrit√§ts-Test verf√ºgbar', 'error');
                    return;
                }

                const parsed = JSON.parse(data);
                
                // Version Check
                if (parsed.version === '1.0') {
                    log('‚úÖ Version korrekt (1.0)', 'success');
                } else {
                    log(`‚ö†Ô∏è Unerwartete Version: ${parsed.version}`, 'error');
                }

                // State Structure Check
                const requiredKeys = ['users', 'wgs', 'tasks', 'executions', 'periods'];
                const stateKeys = Object.keys(parsed.state || {});
                
                for (const key of requiredKeys) {
                    if (stateKeys.includes(key)) {
                        log(`‚úÖ State Key '${key}' vorhanden`, 'success');
                    } else {
                        log(`‚ùå State Key '${key}' fehlt`, 'error');
                    }
                }

                // JSON Validierung
                JSON.stringify(parsed.state);
                log('‚úÖ JSON Struktur ist valid', 'success');

            } catch (error) {
                log(`‚ùå Datenintegrit√§ts-Test fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        function testLargeDataSet() {
            log('üìà Gro√üe Datenmenge Test gestartet...', 'info');
            
            try {
                const largeState = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    state: {
                        users: [],
                        wgs: [],
                        tasks: [],
                        executions: [],
                        periods: [],
                        settings: {},
                        notifications: []
                    }
                };

                // Erstelle 100 Test-Benutzer
                for (let i = 0; i < 100; i++) {
                    largeState.state.users.push({
                        id: `stress-user-${i}`,
                        name: `Stress Test User ${i}`,
                        email: `stress${i}@test.com`
                    });
                }

                // Erstelle 50 Test-Perioden
                for (let i = 0; i < 50; i++) {
                    largeState.state.periods.push({
                        id: `stress-period-${i}`,
                        name: `Stress Test Periode ${i}`,
                        startDate: new Date(Date.now() + i * 24 * 60 * 60 * 1000).toISOString(),
                        endDate: new Date(Date.now() + (i + 7) * 24 * 60 * 60 * 1000).toISOString(),
                        isActive: i === 0
                    });
                }

                const dataSize = JSON.stringify(largeState).length;
                log(`üìä Erstelle gro√üe Datenmenge: ${dataSize} Zeichen`, 'info');

                localStorage.setItem('putzplan-data-stress', JSON.stringify(largeState));
                
                // Verifikation
                const retrieved = localStorage.getItem('putzplan-data-stress');
                if (retrieved && JSON.parse(retrieved).state.users.length === 100) {
                    log('‚úÖ Gro√üe Datenmenge erfolgreich gespeichert und geladen', 'success');
                    
                    // Cleanup
                    localStorage.removeItem('putzplan-data-stress');
                    log('üßπ Stress-Test Daten bereinigt', 'info');
                } else {
                    log('‚ùå Stress-Test fehlgeschlagen', 'error');
                }

            } catch (error) {
                log(`‚ùå Gro√üe Datenmenge Test fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('üöÄ Starte ausgiebigen Persistence-Test...', 'info');
            log('================================================', 'info');
            
            // Test 1: LocalStorage Inspektion
            inspectLocalStorage();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: Datenintegrit√§tspr√ºfung
            testDataIntegrity();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 3: App Reload Simulation
            await testAppReload();
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test 4: Gro√üe Datenmenge
            testLargeDataSet();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            log('================================================', 'info');
            log('üéâ Alle Tests abgeschlossen!', 'success');
        }

        // Initial Check beim Laden der Seite
        window.onload = function() {
            log('üîß Persistence Test Tool geladen', 'info');
            log('Klicke auf "Alle Tests Durchf√ºhren" um zu starten', 'info');
        };
    </script>
</body>
</html>